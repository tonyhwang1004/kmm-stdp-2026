<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÍπÄÏóÑÎßàÎèÖÏÑúÏã§ | ÏùºÏùºÌîåÎûòÎÑà</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary: #1e3a5f;
            --primary-light: #2d5a8b;
            --primary-dark: #0f1f33;
            --accent: #3b82f6;
            --accent-light: #60a5fa;
            --bg-gradient: linear-gradient(135deg, #1e3a5f, #0f1f33);
            --card-bg: #f0f9ff;
            --header-text: white;
        }

        [data-theme="cherry"] {
            --primary: #db2777;
            --primary-light: #ec4899;
            --primary-dark: #9d174d;
            --accent: #f472b6;
            --accent-light: #fbcfe8;
            --bg-gradient: linear-gradient(135deg, #db2777, #9d174d);
            --card-bg: #fdf2f8;
        }

        [data-theme="mint"] {
            --primary: #059669;
            --primary-light: #10b981;
            --primary-dark: #064e3b;
            --accent: #34d399;
            --accent-light: #a7f3d0;
            --bg-gradient: linear-gradient(135deg, #059669, #064e3b);
            --card-bg: #ecfdf5;
        }

        [data-theme="dark"] {
            --primary: #1f1f1f;
            --primary-light: #374151;
            --primary-dark: #0a0a0a;
            --accent: #8b5cf6;
            --accent-light: #c4b5fd;
            --bg-gradient: linear-gradient(135deg, #1f1f1f, #0a0a0a);
            --card-bg: #27272a;
            --header-text: #e4e4e7;
        }

        [data-theme="violet"] {
            --primary: #7c3aed;
            --primary-light: #8b5cf6;
            --primary-dark: #5b21b6;
            --accent: #a78bfa;
            --accent-light: #ddd6fe;
            --bg-gradient: linear-gradient(135deg, #7c3aed, #5b21b6);
            --card-bg: #f5f3ff;
        }

        [data-theme="sunset"] {
            --primary: #ea580c;
            --primary-light: #f97316;
            --primary-dark: #c2410c;
            --accent: #fb923c;
            --accent-light: #fed7aa;
            --bg-gradient: linear-gradient(135deg, #ea580c, #dc2626);
            --card-bg: #fff7ed;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { 
            height: 100%; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f0f0f0;
            overflow: hidden;
        }

        .login-screen {
            position: fixed;
            inset: 0;
            background: var(--bg-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .login-screen.hidden { display: none; }
        .login-box {
            background: white;
            border-radius: 24px;
            padding: 2rem;
            width: 90%;
            max-width: 340px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .login-box h1 { color: var(--primary); margin-bottom: 0.5rem; font-size: 1.5rem; }
        .login-box .subtitle { color: #888; font-size: 0.85rem; margin-bottom: 1.5rem; }
        .login-box select {
            width: 100%;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 2px solid #e5e5e5;
            border-radius: 12px;
            font-size: 1rem;
            background: #fafafa;
        }
        .login-box select:focus { outline: none; border-color: var(--accent); }
        .login-box button {
            width: 100%;
            padding: 1rem;
            background: var(--bg-gradient);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
        }

        .container { display: none; flex-direction: column; height: 100vh; height: 100dvh; }
        .container.active { display: flex; }

        .header {
            background: var(--bg-gradient);
            color: var(--header-text, white);
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-left { display: flex; align-items: center; gap: 10px; }
        .mood { font-size: 1.6rem; }
        .name { font-weight: 600; font-size: 1.1rem; }
        .header-right { display: flex; gap: 8px; }
        .header-btn {
            width: 38px; height: 38px;
            background: rgba(255,255,255,0.15);
            border: none;
            border-radius: 10px;
            color: var(--header-text, white);
            font-size: 1rem;
            cursor: pointer;
        }

        .week-bar {
            background: white;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e5e5e5;
        }
        .week-nav {
            width: 32px; height: 32px;
            background: #f5f5f5;
            border: none;
            border-radius: 50%;
            cursor: pointer;
        }
        .week-info { text-align: center; }
        .week-title { font-weight: 700; color: var(--primary); font-size: 1.1rem; }
        .week-range { font-size: 0.75rem; color: #999; margin-top: 2px; }

        .table-wrapper { flex: 1; overflow: auto; padding: 10px; padding-bottom: 80px; }
        .plan-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            min-width: 750px;
        }
        .plan-table th {
            background: var(--primary);
            color: white;
            padding: 12px 6px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .plan-table th.subject-col { width: 55px; }
        .plan-table th.add-col { width: 42px; }
        .plan-table th.book-col { width: 85px; }
        .plan-table td {
            border: 1px solid #e5e5e5;
            padding: 4px;
            vertical-align: top;
            height: 85px;
        }
        .subject-cell {
            background: linear-gradient(135deg, #f8f8f8, #f0f0f0);
            text-align: center;
            font-weight: 700;
            font-size: 0.9rem;
            color: var(--primary);
            vertical-align: middle !important;
        }
        .add-cell {
            background: #f8f8f8;
            text-align: center;
            vertical-align: middle !important;
        }
        .book-cell {
            background: var(--card-bg);
            font-size: 0.65rem;
            vertical-align: middle !important;
            text-align: center;
            font-weight: 600;
            color: #555;
            padding: 6px 4px;
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
        }
        .book-cell .book-type {
            font-size: 0.55rem;
            padding: 2px 5px;
            border-radius: 4px;
            display: inline-block;
            margin-bottom: 3px;
            font-weight: 700;
        }
        .book-cell .book-type.lecture { background: linear-gradient(135deg, #dbeafe, #bfdbfe); color: #1e40af; }
        .book-cell .book-type.textbook { background: linear-gradient(135deg, #dcfce7, #bbf7d0); color: #166534; }
        .book-cell .book-name { word-break: keep-all; line-height: 1.3; }
        .add-btn {
            width: 32px; height: 32px;
            background: linear-gradient(135deg, #e0f2fe, #bae6fd);
            border: 2px dashed var(--accent);
            border-radius: 8px;
            color: var(--accent);
            font-size: 1.1rem;
            cursor: pointer;
        }

        .day-header { text-align: center; }
        .day-name { font-size: 0.7rem; opacity: 0.9; }
        .day-num { font-size: 1.05rem; font-weight: 700; }
        .today { background: var(--accent) !important; }
        .sat .day-num { color: #93c5fd; }
        .sun .day-num { color: #fca5a5; }

        .day-cell { position: relative; padding: 4px !important; }

        .cell-add {
            width: 100%;
            height: 100%;
            min-height: 75px;
            background: transparent;
            border: 2px dashed #d5d5d5;
            border-radius: 8px;
            color: #bbb;
            font-size: 1.6rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .cell-add:hover { border-color: var(--accent); color: var(--accent); background: var(--card-bg); }

        .plan-card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #e5e5e5;
        }
        .plan-card.completed { border-color: #86efac; background: linear-gradient(135deg, #f0fdf4, #dcfce7); }
        .plan-card.pending { border-color: #fcd34d; background: linear-gradient(135deg, #fefce8, #fef9c3); }
        .plan-card.failed { border-color: #fca5a5; background: linear-gradient(135deg, #fef2f2, #fee2e2); }
        .plan-card.paused { border-color: #c4b5fd; background: linear-gradient(135deg, #f5f3ff, #ede9fe); }
        .plan-card.running { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3); }
        .plan-card.done-local { border-color: #86efac; background: linear-gradient(135deg, #f0fdf4, #dcfce7); }

        .card-top {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 5px 6px;
            background: rgba(0,0,0,0.02);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        
        .timer-btn {
            width: 24px; height: 24px;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 0.5rem;
            cursor: pointer;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .play-btn { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .play-btn:disabled { background: #d1d5db; cursor: not-allowed; box-shadow: none; }
        .pause-btn { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .pause-btn:disabled { background: #d1d5db; cursor: not-allowed; box-shadow: none; }
        .stop-btn { background: linear-gradient(135deg, #10b981, #059669); }
        .stop-btn:disabled { background: #d1d5db; cursor: not-allowed; box-shadow: none; }
        
        .play-btn.active { background: linear-gradient(135deg, #10b981, #059669); animation: pulse 1.5s infinite; }
        .pause-btn.active { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .card-timer {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--primary);
            font-family: 'SF Mono', Monaco, monospace;
            margin-left: 2px;
        }
        .card-timer.done { color: #10b981; }
        .card-status { margin-left: auto; font-size: 0.85rem; }

        .card-bottom { padding: 4px 5px; }
        .card-inputs {
            display: flex;
            align-items: center;
            gap: 2px;
            flex-wrap: wrap;
        }
        .card-input {
            width: 32px;
            padding: 3px 2px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.65rem;
            background: white;
        }
        .card-input:focus { outline: none; border-color: var(--accent); }
        .card-input.time-input { width: 28px; background: #fef3c7; }
        .input-label { font-size: 0.55rem; color: #888; }
        .input-sep { font-size: 0.6rem; color: #999; }

        .check-bar {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: white;
            padding: 12px 15px;
            border-top: 1px solid #e5e5e5;
            display: flex;
            gap: 10px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
            z-index: 50;
        }
        .check-bar-info { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .check-bar-title { font-weight: 700; color: var(--primary); font-size: 0.9rem; }
        .check-bar-status { font-size: 0.75rem; color: #888; margin-top: 2px; }
        .check-bar-btns { display: flex; gap: 8px; }
        .check-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
        }
        .check-btn.request { background: linear-gradient(135deg, var(--accent), var(--primary)); color: white; }
        .check-btn.request:disabled { background: #d1d5db; cursor: not-allowed; }
        .check-btn.cancel { background: #f5f5f5; color: #666; }
        .check-btn i { margin-right: 5px; }

        .stats-panel {
            display: none;
            position: fixed;
            bottom: 70px; left: 10px; right: 10px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 -4px 30px rgba(0,0,0,0.15);
            padding: 20px;
            z-index: 100;
        }
        .stats-panel.active { display: block; }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .stat-item { text-align: center; padding: 12px; background: linear-gradient(135deg, #f8f8f8, #f0f0f0); border-radius: 12px; }
        .stat-value { font-size: 1.5rem; font-weight: 700; color: var(--primary); }
        .stat-label { font-size: 0.65rem; color: #999; margin-top: 2px; }
        .close-stats { position: absolute; top: 12px; right: 12px; background: none; border: none; font-size: 1.3rem; color: #999; cursor: pointer; }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 500;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }
        .modal.active { display: flex; }
        .modal-box {
            background: white;
            border-radius: 20px;
            padding: 1.5rem;
            width: 90%;
            max-width: 340px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-box h3 { margin-bottom: 1rem; color: var(--primary); font-size: 1.2rem; }
        .modal-box select, .modal-box input[type="text"] {
            width: 100%;
            padding: 12px;
            margin-bottom: 12px;
            border: 2px solid #e5e5e5;
            border-radius: 12px;
            font-size: 1rem;
            background: #fafafa;
        }
        .modal-box select:focus, .modal-box input:focus { outline: none; border-color: var(--accent); }
        
        .type-selector { display: flex; gap: 10px; margin-bottom: 15px; }
        .type-option { flex: 1; position: relative; }
        .type-option input { position: absolute; opacity: 0; }
        .type-option label {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            border: 2px solid #e5e5e5;
            border-radius: 12px;
            cursor: pointer;
        }
        .type-option label i { font-size: 1.8rem; margin-bottom: 6px; color: #888; }
        .type-option label span { font-weight: 600; color: #666; }
        .type-option input:checked + label { border-color: var(--accent); background: var(--card-bg); }
        .type-option input:checked + label i { color: var(--accent); }
        .type-option input:checked + label span { color: var(--primary); }
        
        .modal-btns { display: flex; gap: 10px; margin-top: 5px; }
        .modal-btns button {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }
        .modal-btns .cancel { background: #f0f0f0; color: #666; }
        .modal-btns .confirm { background: var(--accent); color: white; }

        .theme-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px; }
        .theme-option {
            padding: 15px;
            border: 3px solid #e5e5e5;
            border-radius: 14px;
            cursor: pointer;
            text-align: center;
        }
        .theme-option.active { border-color: var(--primary); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .theme-option .theme-preview { width: 100%; height: 40px; border-radius: 8px; margin-bottom: 8px; }
        .theme-option .theme-name { font-weight: 600; font-size: 0.85rem; }

        .context-menu {
            display: none;
            position: fixed;
            background: white;
            border-radius: 14px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.25);
            overflow: hidden;
            z-index: 600;
            min-width: 150px;
        }
        .context-menu.active { display: block; }
        .context-menu-item {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
        }
        .context-menu-item:first-child { border-bottom: 1px solid #f0f0f0; }
        .context-menu-item:active { background: #e8e8e8; }
        .context-menu-item.danger { color: #ef4444; }
        .context-menu-item i { width: 20px; text-align: center; font-size: 1rem; }

        .check-modal .check-summary {
            background: linear-gradient(135deg, #f8f8f8, #f0f0f0);
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
            max-height: 200px;
            overflow-y: auto;
        }
        .check-modal .check-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e5e5e5;
        }
        .check-modal .check-item:last-child { border-bottom: none; }
        .check-modal .check-item.warning { background: #fef3c7; margin: 0 -10px; padding: 8px 10px; border-radius: 6px; }
        .check-modal .check-item .subject { font-weight: 600; color: var(--primary); }
        .check-modal .check-item .time { font-family: monospace; color: var(--accent); font-weight: 600; }
        .check-modal .check-total { text-align: center; padding-top: 10px; font-size: 1.3rem; font-weight: 700; color: var(--primary); }

        .photo-section { margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e5e5; }
        .photo-label { font-size: 0.85rem; font-weight: 600; color: var(--primary); margin-bottom: 10px; }
        .photo-preview {
            width: 100%;
            height: 150px;
            border: 2px dashed #ddd;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            overflow: hidden;
            background: #fafafa;
        }
        .photo-preview img { width: 100%; height: 100%; object-fit: cover; }
        .photo-preview i { font-size: 2rem; color: #bbb; margin-bottom: 8px; }
        .photo-preview span { font-size: 0.8rem; color: #888; }
        .photo-preview.has-photo { border-style: solid; border-color: var(--accent); }
        #photoInput { display: none; }

        .toast {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            opacity: 0;
            transition: all 0.3s;
            z-index: 700;
            font-weight: 500;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .toast.success { background: linear-gradient(135deg, #10b981, #059669); }
        .toast.warning { background: linear-gradient(135deg, #f59e0b, #d97706); }

        .capture-header {
            display: none;
            background: var(--bg-gradient);
            color: white;
            padding: 18px 20px;
            text-align: center;
            border-radius: 12px 12px 0 0;
        }
        .capture-header.visible { display: block; }
        .capture-title { font-size: 1.3rem; font-weight: 700; margin-bottom: 4px; }
        .capture-info { font-size: 0.9rem; opacity: 0.9; }
        .capture-mode .plan-table { border-radius: 0 0 12px 12px; }

        [data-theme="dark"] .login-box,
        [data-theme="dark"] .modal-box,
        [data-theme="dark"] .stats-panel,
        [data-theme="dark"] .context-menu { background: #27272a; color: #e4e4e7; }
        [data-theme="dark"] .plan-table { background: #1f1f1f; }
        [data-theme="dark"] .plan-table td { border-color: #3f3f46; }
        [data-theme="dark"] .subject-cell { background: linear-gradient(135deg, #27272a, #1f1f1f); color: #e4e4e7; }
        [data-theme="dark"] .week-bar, [data-theme="dark"] .check-bar { background: #27272a; border-color: #3f3f46; }
        [data-theme="dark"] .week-title { color: #e4e4e7; }
        [data-theme="dark"] .plan-card { background: #3f3f46; border-color: #52525b; }
        [data-theme="dark"] .card-timer { color: #e4e4e7; }
        [data-theme="dark"] .card-input { background: #27272a; color: #e4e4e7; border-color: #52525b; }
    </style>
</head>
<body data-theme="ocean">
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <h1>üìö ÍπÄÏóÑÎßàÎèÖÏÑúÏã§</h1>
            <p class="subtitle">ÏùºÏùº ÌîåÎûòÎÑà</p>
            <select id="loginFloor" onchange="loadStudents()">
                <option value="">Ï∏µ ÏÑ†ÌÉù</option>
                <option value="7Ï∏µ">7Ï∏µ</option>
                <option value="8Ï∏µ">8Ï∏µ</option>
            </select>
            <select id="loginName">
                <option value="">Ïù¥Î¶Ñ ÏÑ†ÌÉù</option>
            </select>
            <button onclick="login()">ÏãúÏûëÌïòÍ∏∞</button>
        </div>
    </div>

    <div class="container" id="container">
        <div class="header">
            <div class="header-left">
                <span class="mood" id="mood">üòä</span>
                <span class="name" id="userName">ÌïôÏÉù</span>
            </div>
            <div class="header-right">
                <button class="header-btn" onclick="openThemeModal()" title="ÌÖåÎßà"><i class="fas fa-palette"></i></button>
                <button class="header-btn" onclick="toggleStats()" title="ÌÜµÍ≥Ñ"><i class="fas fa-chart-bar"></i></button>
                <button class="header-btn" onclick="captureShare()" title="Í≥µÏú†"><i class="fas fa-camera"></i></button>
                <button class="header-btn" onclick="logout()" title="Î°úÍ∑∏ÏïÑÏõÉ"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>

        <div class="week-bar">
            <button class="week-nav" onclick="changeWeek(-1)"><i class="fas fa-chevron-left"></i></button>
            <div class="week-info">
                <div class="week-title" id="weekTitle">2Ïõî 1Ï£ºÏ∞®</div>
                <div class="week-range" id="weekRange">2/3(Ïõî)~2/9(Ïùº)</div>
            </div>
            <button class="week-nav" onclick="changeWeek(1)"><i class="fas fa-chevron-right"></i></button>
        </div>

        <div class="table-wrapper">
            <div id="captureArea">
                <div class="capture-header" id="captureHeader">
                    <div class="capture-title">üìö ÍπÄÏóÑÎßàÎèÖÏÑúÏã§ Ï£ºÍ∞ÑÍ≥ÑÌöçÌëú</div>
                    <div class="capture-info" id="captureInfo">ÌïôÏÉù ¬∑ Ï∏µ ¬∑ Ï£ºÏ∞®</div>
                </div>
                <table class="plan-table">
                <thead id="tableHead"></thead>
                <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>

        <div class="check-bar">
            <div class="check-bar-info">
                <div class="check-bar-title">Ïò§ÎäòÏùò ÌïôÏäµ</div>
                <div class="check-bar-status" id="checkBarStatus">ÏôÑÎ£å: 0Í∞ú ¬∑ 0Î∂Ñ</div>
            </div>
            <div class="check-bar-btns">
                <button class="check-btn cancel" onclick="cancelAllChecks()" id="cancelCheckBtn" style="display:none;">
                    <i class="fas fa-times"></i>Ï∑®ÏÜå
                </button>
                <button class="check-btn request" onclick="openCheckModal()" id="requestCheckBtn" disabled>
                    <i class="fas fa-bell"></i>Í≤ÄÏÇ¨ ÏöîÏ≤≠
                </button>
            </div>
        </div>

        <div class="stats-panel" id="statsPanel">
            <button class="close-stats" onclick="toggleStats()"><i class="fas fa-times"></i></button>
            <div class="stats-grid">
                <div class="stat-item"><div class="stat-value" id="statTotal">0</div><div class="stat-label">Ï¥ù Í≥ÑÌöç</div></div>
                <div class="stat-item"><div class="stat-value" id="statDone" style="color:#10b981">0</div><div class="stat-label">ÏôÑÎ£å</div></div>
                <div class="stat-item"><div class="stat-value" id="statTime" style="color:var(--accent)">0h</div><div class="stat-label">Í≥µÎ∂ÄÏãúÍ∞Ñ</div></div>
                <div class="stat-item"><div class="stat-value" id="statRate" style="color:#f59e0b">0%</div><div class="stat-label">Ïã§Ï≤úÏú®</div></div>
            </div>
        </div>
    </div>

    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="editBook()">
            <i class="fas fa-edit"></i>
            <span>ÏàòÏ†ï</span>
        </div>
        <div class="context-menu-item danger" onclick="deleteBook()">
            <i class="fas fa-trash"></i>
            <span>ÏÇ≠Ï†ú</span>
        </div>
    </div>

    <div class="modal" id="bookModal">
        <div class="modal-box">
            <h3 id="bookModalTitle">üìö ÍµêÏû¨/Ïù∏Í∞ï Ï∂îÍ∞Ä</h3>
            <select id="bookSubject">
                <option value="">Í≥ºÎ™© ÏÑ†ÌÉù</option>
                <option value="Íµ≠Ïñ¥">Íµ≠Ïñ¥</option>
                <option value="ÏàòÌïô">ÏàòÌïô</option>
                <option value="ÏòÅÏñ¥">ÏòÅÏñ¥</option>
                <option value="ÌÉêÍµ¨">ÌÉêÍµ¨</option>
            </select>
            <div class="type-selector">
                <div class="type-option">
                    <input type="radio" name="bookType" id="typeTextbook" value="textbook" checked>
                    <label for="typeTextbook"><i class="fas fa-book"></i><span>ÍµêÏû¨</span></label>
                </div>
                <div class="type-option">
                    <input type="radio" name="bookType" id="typeLecture" value="lecture">
                    <label for="typeLecture"><i class="fas fa-video"></i><span>Ïù∏Í∞ï</span></label>
                </div>
            </div>
            <input type="text" id="bookName" placeholder="ÍµêÏû¨Î™Ö ÎòêÎäî Í∞ïÏùòÎ™Ö">
            <div class="modal-btns">
                <button class="cancel" onclick="closeBookModal()">Ï∑®ÏÜå</button>
                <button class="confirm" onclick="saveBook()">Ï†ÄÏû•</button>
            </div>
        </div>
    </div>

    <div class="modal" id="themeModal">
        <div class="modal-box">
            <h3>üé® ÌîåÎûòÎÑà ÌÖåÎßà</h3>
            <div class="theme-grid">
                <div class="theme-option active" data-theme="ocean" onclick="selectTheme('ocean')">
                    <div class="theme-preview" style="background: linear-gradient(135deg, #1e3a5f, #3b82f6);"></div>
                    <div class="theme-name">üåä Ïò§ÏÖò Î∏îÎ£®</div>
                </div>
                <div class="theme-option" data-theme="cherry" onclick="selectTheme('cherry')">
                    <div class="theme-preview" style="background: linear-gradient(135deg, #db2777, #f472b6);"></div>
                    <div class="theme-name">üå∏ Ï≤¥Î¶¨ Î∏îÎùºÏç∏</div>
                </div>
                <div class="theme-option" data-theme="mint" onclick="selectTheme('mint')">
                    <div class="theme-preview" style="background: linear-gradient(135deg, #059669, #34d399);"></div>
                    <div class="theme-name">üåø ÎØºÌä∏ Í∑∏Î¶∞</div>
                </div>
                <div class="theme-option" data-theme="violet" onclick="selectTheme('violet')">
                    <div class="theme-preview" style="background: linear-gradient(135deg, #7c3aed, #a78bfa);"></div>
                    <div class="theme-name">üíú Î∞îÏù¥Ïò¨Î†õ</div>
                </div>
                <div class="theme-option" data-theme="sunset" onclick="selectTheme('sunset')">
                    <div class="theme-preview" style="background: linear-gradient(135deg, #ea580c, #f97316);"></div>
                    <div class="theme-name">üçä ÏÑ†ÏÖã</div>
                </div>
                <div class="theme-option" data-theme="dark" onclick="selectTheme('dark')">
                    <div class="theme-preview" style="background: linear-gradient(135deg, #1f1f1f, #8b5cf6);"></div>
                    <div class="theme-name">üåô Îã§ÌÅ¨ ÎÇòÏù¥Ìä∏</div>
                </div>
            </div>
            <div class="modal-btns">
                <button class="confirm" onclick="closeThemeModal()" style="flex:1;">ÌôïÏù∏</button>
            </div>
        </div>
    </div>

    <div class="modal check-modal" id="checkModal">
        <div class="modal-box">
            <h3>üìã Í≤ÄÏÇ¨ ÏöîÏ≤≠</h3>
            <div class="check-summary" id="checkSummary"></div>
            <div class="photo-section">
                <div class="photo-label">üì∏ Ïù∏Ï¶ù ÏÇ¨ÏßÑ (ÏÑ†ÌÉù)</div>
                <div class="photo-preview" id="photoPreview" onclick="document.getElementById('photoInput').click()">
                    <i class="fas fa-camera"></i>
                    <span>ÌÑ∞ÏπòÌïòÏó¨ ÏÇ¨ÏßÑ Ï¥¨ÏòÅ</span>
                </div>
                <input type="file" id="photoInput" accept="image/*" capture="environment" onchange="handlePhoto(this)">
            </div>
            <div class="modal-btns">
                <button class="cancel" onclick="closeCheckModal(false)">Ï∑®ÏÜå</button>
                <button class="confirm" onclick="closeCheckModal(true)">ÏöîÏ≤≠ÌïòÍ∏∞</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        const API = 'https://script.google.com/macros/s/AKfycbwGFbsj8FgFIuF-iFkJ4ekyS76MWQf9UrUysJ-Fs12vuVByJwenoYRgOJeOZiPOa6gzkg/exec';
        
        let user = null;
        let books = [];
        let plans = [];
        let weekStart = getMonday(new Date());
        let timers = {};
        let completedToday = [];
        
        let selectedBook = null;
        let editMode = false;
        let editingBookData = null;
        let longPressTimer = null;
        let contextMenuJustOpened = false;
        let currentPhotoData = null;

        const SUBJECTS = ['Íµ≠Ïñ¥', 'ÏàòÌïô', 'ÏòÅÏñ¥', 'ÌÉêÍµ¨'];

        document.addEventListener('DOMContentLoaded', () => {
            loadTheme();
            document.addEventListener('click', (e) => {
                if (contextMenuJustOpened) { contextMenuJustOpened = false; return; }
                if (!e.target.closest('.context-menu')) hideContextMenu();
            });
        });

        function getMonday(d) {
            const date = new Date(d);
            const day = date.getDay();
            return new Date(date.setDate(date.getDate() - day + (day === 0 ? -6 : 1)));
        }
        function fmt(d) { return d.toISOString().split('T')[0]; }
        function fmtKR(d) { return `${d.getMonth()+1}/${d.getDate()}`; }
        function dayName(i) { return ['Ïõî','Ìôî','Ïàò','Î™©','Í∏à','ÌÜ†','Ïùº'][i]; }
        function getWeekDates() {
            const arr = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(weekStart);
                d.setDate(weekStart.getDate() + i);
                arr.push(d);
            }
            return arr;
        }

        async function api(data) {
            try {
                const res = await fetch(API, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(data) });
                return await res.json();
            } catch { return { success: false }; }
        }

        function loadTheme() { applyTheme(localStorage.getItem('plannerTheme') || 'ocean'); }
        function applyTheme(theme) {
            document.body.setAttribute('data-theme', theme);
            document.querySelectorAll('.theme-option').forEach(opt => opt.classList.toggle('active', opt.dataset.theme === theme));
        }
        function selectTheme(theme) { applyTheme(theme); localStorage.setItem('plannerTheme', theme); }
        function openThemeModal() { document.getElementById('themeModal').classList.add('active'); }
        function closeThemeModal() { document.getElementById('themeModal').classList.remove('active'); }

        async function loadStudents() {
            const floor = document.getElementById('loginFloor').value;
            const sel = document.getElementById('loginName');
            if (!floor) return;
            sel.innerHTML = '<option>Î°úÎî©Ï§ë...</option>';
            const res = await api({ action: 'getStudents', floor });
            if (res.success) sel.innerHTML = '<option value="">Ïù¥Î¶Ñ ÏÑ†ÌÉù</option>' + res.students.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
        }

        async function login() {
            const floor = document.getElementById('loginFloor').value;
            const name = document.getElementById('loginName').value;
            if (!floor || !name) return toast('Ï∏µÍ≥º Ïù¥Î¶ÑÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî', 'warning');
            user = { floor, name };
            document.getElementById('userName').textContent = name;
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('container').classList.add('active');
            await loadData();
        }

        function logout() {
            user = null; timers = {}; completedToday = [];
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('container').classList.remove('active');
        }

        async function loadData() {
            const bRes = await api({ action: 'getBooks', floor: user.floor, name: user.name });
            if (bRes.success) books = bRes.books || [];
            await loadPlans();
            renderWeek(); renderTable(); updateMood(); updateCheckBar();
        }

        async function loadPlans() {
            const dates = getWeekDates();
            const res = await api({ action: 'getWeekPlans', floor: user.floor, name: user.name, startDate: fmt(dates[0]), endDate: fmt(dates[6]) });
            if (res.success) plans = res.plans || [];
        }

        function changeWeek(delta) {
            weekStart.setDate(weekStart.getDate() + delta * 7);
            loadPlans().then(() => { renderWeek(); renderTable(); });
        }

        function renderWeek() {
            const dates = getWeekDates();
            const m = dates[0].getMonth() + 1;
            const w = Math.ceil(dates[0].getDate() / 7);
            document.getElementById('weekTitle').textContent = `${m}Ïõî ${w}Ï£ºÏ∞®`;
            document.getElementById('weekRange').textContent = `${fmtKR(dates[0])}(Ïõî)~${fmtKR(dates[6])}(Ïùº)`;
        }

        function renderTable() {
            const dates = getWeekDates();
            const today = fmt(new Date());

            let hHtml = '<tr><th class="subject-col">Í≥ºÎ™©</th><th class="add-col">+</th><th class="book-col">ÍµêÏû¨</th>';
            for (let i = 0; i < 7; i++) {
                const d = dates[i];
                const cls = fmt(d) === today ? 'today' : (i === 5 ? 'sat' : (i === 6 ? 'sun' : ''));
                hHtml += `<th class="${cls}"><div class="day-header ${cls}"><div class="day-name">${dayName(i)}</div><div class="day-num">${d.getDate()}</div></div></th>`;
            }
            hHtml += '</tr>';
            document.getElementById('tableHead').innerHTML = hHtml;

            let bHtml = '';
            SUBJECTS.forEach(subject => {
                const sBooks = books.filter(b => b.subject === subject);
                
                if (sBooks.length === 0) {
                    bHtml += `<tr><td class="subject-cell">${subject}</td><td class="add-cell"><button class="add-btn" onclick="openBookModal('${subject}')">+</button></td><td class="book-cell">-</td>`;
                    for (let i = 0; i < 7; i++) bHtml += `<td class="day-cell"><button class="cell-add" onclick="quickAdd('${subject}','${subject}','${fmt(dates[i])}','textbook')">+</button></td>`;
                    bHtml += '</tr>';
                } else {
                    sBooks.forEach((book, idx) => {
                        bHtml += '<tr>';
                        if (idx === 0) {
                            bHtml += `<td class="subject-cell" rowspan="${sBooks.length}">${subject}</td>`;
                            bHtml += `<td class="add-cell" rowspan="${sBooks.length}"><button class="add-btn" onclick="openBookModal('${subject}')">+</button></td>`;
                        }
                        
                        const typeLabel = book.type === 'lecture' ? 'üé¨ Ïù∏Í∞ï' : 'üìñ ÍµêÏû¨';
                        const typeClass = book.type === 'lecture' ? 'lecture' : 'textbook';
                        bHtml += `<td class="book-cell" onpointerdown="startLongPress(event,'${subject}','${book.name}','${book.type||'textbook'}')" onpointerup="endLongPress(event)" onpointerleave="endLongPress(event)">
                            <span class="book-type ${typeClass}">${typeLabel}</span><div class="book-name">${book.name}</div></td>`;
                        
                        for (let i = 0; i < 7; i++) {
                            const dateStr = fmt(dates[i]);
                            const dayPlans = plans.filter(p => p.date === dateStr && p.subject === subject && p.book === book.name);
                            
                            bHtml += '<td class="day-cell">';
                            if (dayPlans.length > 0) {
                                const plan = dayPlans[0];
                                const key = `${subject}-${book.name}-${dateStr}`;
                                const timer = timers[key] || { state: 'idle', elapsed: 0 };
                                const bookType = book.type || 'textbook';
                                
                                const isCompletedLocal = completedToday.some(c => c.key === key);
                                const completedData = completedToday.find(c => c.key === key);
                                
                                let cardCls = '', statusIcon = '';
                                if (plan.status === 'approved' || plan.status === 'O') { cardCls = 'completed'; statusIcon = '‚úÖ'; }
                                else if (plan.status === 'failed' || plan.status === 'X') { cardCls = 'failed'; statusIcon = '‚ùå'; }
                                else if (plan.status === 'requested') { cardCls = 'pending'; statusIcon = '‚è≥'; }
                                else if (isCompletedLocal) { cardCls = 'done-local'; statusIcon = '‚úîÔ∏è'; }
                                
                                if (timer.state === 'running') cardCls = 'running';
                                if (timer.state === 'paused') cardCls = 'paused';
                                
                                const isServerComplete = ['approved', 'O', 'requested'].includes(plan.status);
                                const isRunning = timer.state === 'running';
                                const isPaused = timer.state === 'paused';
                                
                                let displaySeconds = timer.elapsed || 0;
                                if (completedData) displaySeconds = completedData.elapsed;
                                else if (plan.actualTime) displaySeconds = plan.actualTime * 60;
                                const timerDisplay = formatTime(displaySeconds);
                                const timerDone = isCompletedLocal || isServerComplete;
                                
                                const startVal = completedData?.startPage || plan.startPage || '';
                                const endVal = completedData?.endPage || plan.endPage || '';
                                const timeVal = completedData ? Math.ceil(completedData.elapsed / 60) : (plan.actualTime || '');
                                
                                const unit = bookType === 'lecture' ? 'Í∞ï' : 'p';
                                const inputDisabled = isServerComplete ? 'disabled' : '';
                                
                                bHtml += `<div class="plan-card ${cardCls}">
                                    <div class="card-top">
                                        <button class="timer-btn play-btn ${isRunning ? 'active' : ''}" onclick="timerPlay('${subject}','${book.name}','${dateStr}')" ${isServerComplete || isCompletedLocal || isRunning ? 'disabled' : ''}><i class="fas fa-play"></i></button>
                                        <button class="timer-btn pause-btn ${isPaused ? 'active' : ''}" onclick="timerPause('${subject}','${book.name}','${dateStr}')" ${isServerComplete || isCompletedLocal || timer.state === 'idle' ? 'disabled' : ''}><i class="fas fa-pause"></i></button>
                                        <button class="timer-btn stop-btn" onclick="timerStop('${subject}','${book.name}','${dateStr}','${bookType}')" ${isServerComplete || isCompletedLocal ? 'disabled' : ''}><i class="fas fa-check"></i></button>
                                        <span class="card-timer ${timerDone ? 'done' : ''}" id="timer-${key}">${timerDisplay}</span>
                                        <span class="card-status">${statusIcon}</span>
                                    </div>
                                    <div class="card-bottom">
                                        <div class="card-inputs">
                                            <span class="input-label">${unit}</span>
                                            <input class="card-input" value="${startVal}" placeholder="-" ${inputDisabled} onchange="updateInput('${key}','${dateStr}','${subject}','${book.name}','start',this.value)">
                                            <span class="input-sep">~</span>
                                            <input class="card-input" value="${endVal}" placeholder="-" ${inputDisabled} onchange="updateInput('${key}','${dateStr}','${subject}','${book.name}','end',this.value)">
                                            <span class="input-sep">|</span>
                                            <input class="card-input time-input" value="${timeVal}" placeholder="Î∂Ñ" ${inputDisabled} onchange="updateInput('${key}','${dateStr}','${subject}','${book.name}','time',this.value)">
                                            <span class="input-label">Î∂Ñ</span>
                                        </div>
                                    </div>
                                </div>`;
                            } else {
                                bHtml += `<button class="cell-add" onclick="quickAdd('${subject}','${book.name}','${dateStr}','${book.type||'textbook'}')">+</button>`;
                            }
                            bHtml += '</td>';
                        }
                        bHtml += '</tr>';
                    });
                }
            });
            document.getElementById('tableBody').innerHTML = bHtml;
        }

        function formatTime(seconds) {
            const m = Math.floor(seconds / 60), s = seconds % 60;
            return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        }

        function updateInput(key, dateStr, subject, book, type, value) {
            const plan = plans.find(p => p.date === dateStr && p.subject === subject && p.book === book);
            if (!plan) return;
            
            if (type === 'start') plan.startPage = value;
            else if (type === 'end') plan.endPage = value;
            else if (type === 'time') plan.actualTime = parseInt(value) || 0;
            
            const completed = completedToday.find(c => c.key === key);
            if (completed) {
                if (type === 'start') completed.startPage = value;
                else if (type === 'end') completed.endPage = value;
                else if (type === 'time') completed.elapsed = (parseInt(value) || 0) * 60;
            }
            
            api({ action: 'updatePlanPage', floor: user.floor, name: user.name, date: dateStr, subject, bookName: book, startPage: plan.startPage, endPage: plan.endPage, actualTime: plan.actualTime });
            updateCheckBar();
        }

        async function quickAdd(subject, book, dateStr, bookType) {
            if (plans.some(p => p.date === dateStr && p.subject === subject && p.book === book)) {
                toast('‚ö†Ô∏è Ïù¥ÎØ∏ Í≥ÑÌöçÏù¥ ÏûàÏäµÎãàÎã§', 'warning'); return;
            }
            const res = await api({ action: 'addPlan', floor: user.floor, name: user.name, date: dateStr, subject, bookName: book, time: 60, bookType });
            if (res.success) { plans.push({ date: dateStr, subject, book, status: 'pending' }); renderTable(); toast('‚úÖ Í≥ÑÌöç Ï∂îÍ∞ÄÎê®', 'success'); }
        }

        function timerPlay(subject, book, dateStr) {
            const key = `${subject}-${book}-${dateStr}`;
            if (!timers[key]) timers[key] = { state: 'idle', elapsed: 0, start: null, interval: null };
            const timer = timers[key];
            if (timer.state === 'running') return;
            
            timer.state = 'running';
            timer.start = Date.now() - timer.elapsed * 1000;
            timer.interval = setInterval(() => {
                timer.elapsed = Math.floor((Date.now() - timer.start) / 1000);
                const el = document.getElementById(`timer-${key}`);
                if (el) el.textContent = formatTime(timer.elapsed);
            }, 1000);
            renderTable(); toast('‚è±Ô∏è ÌïôÏäµ ÏãúÏûë!');
        }
        
        function timerPause(subject, book, dateStr) {
            const key = `${subject}-${book}-${dateStr}`;
            const timer = timers[key];
            if (!timer || timer.state !== 'running') return;
            clearInterval(timer.interval); timer.interval = null; timer.state = 'paused';
            renderTable(); toast('‚è∏Ô∏è ÏùºÏãúÏ†ïÏßÄ');
        }
        
        function timerStop(subject, book, dateStr, bookType) {
            const key = `${subject}-${book}-${dateStr}`;
            const timer = timers[key] || { state: 'idle', elapsed: 0 };
            const plan = plans.find(p => p.date === dateStr && p.subject === subject && p.book === book);
            
            if (timer.interval) { clearInterval(timer.interval); timer.interval = null; }
            
            // ÌÉÄÏù¥Î®∏ ÏãúÍ∞Ñ ÎòêÎäî ÏßÅÏ†ë ÏûÖÎ†•Ìïú ÏãúÍ∞Ñ ÏÇ¨Ïö©
            let elapsed = timer.elapsed || 0;
            if (elapsed === 0 && plan?.actualTime) elapsed = plan.actualTime * 60;
            
            const startPage = plan?.startPage || '';
            const endPage = plan?.endPage || '';
            
            // ÏôÑÎ£å Î™©Î°ùÏóê Ï∂îÍ∞Ä (Í≤ÄÏ¶ùÏùÄ Í≤ÄÏÇ¨ÏöîÏ≤≠ Ïãú)
            const existing = completedToday.findIndex(c => c.key === key);
            const data = { key, subject, book, dateStr, elapsed, bookType, startPage, endPage };
            
            if (existing >= 0) completedToday[existing] = data;
            else completedToday.push(data);
            
            timers[key] = { state: 'idle', elapsed: elapsed, start: null, interval: null };
            renderTable(); updateCheckBar(); 
            toast('‚úîÔ∏è ÏôÑÎ£å! Í≤ÄÏÇ¨ ÏöîÏ≤≠ Î≤ÑÌäºÏùÑ ÎàåÎü¨Ï£ºÏÑ∏Ïöî', 'success');
        }

        function handlePhoto(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    currentPhotoData = e.target.result;
                    document.getElementById('photoPreview').innerHTML = `<img src="${currentPhotoData}" alt="Ïù∏Ï¶ùÏÇ¨ÏßÑ">`;
                    document.getElementById('photoPreview').classList.add('has-photo');
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function updateCheckBar() {
            const count = completedToday.length;
            const totalMin = completedToday.reduce((sum, c) => sum + Math.ceil(c.elapsed / 60), 0);
            document.getElementById('checkBarStatus').textContent = `ÏôÑÎ£å: ${count}Í∞ú ¬∑ ${totalMin}Î∂Ñ`;
            document.getElementById('requestCheckBtn').disabled = count === 0;
            document.getElementById('cancelCheckBtn').style.display = count > 0 ? 'inline-flex' : 'none';
        }

        function openCheckModal() {
            if (completedToday.length === 0) return;
            
            // ÏµúÏã† plan Îç∞Ïù¥ÌÑ∞Î°ú ÏóÖÎç∞Ïù¥Ìä∏
            completedToday.forEach(c => {
                const plan = plans.find(p => p.date === c.dateStr && p.subject === c.subject && p.book === c.book);
                if (plan) {
                    c.startPage = c.startPage || plan.startPage || '';
                    c.endPage = c.endPage || plan.endPage || '';
                    if (c.elapsed === 0 && plan.actualTime) c.elapsed = plan.actualTime * 60;
                }
            });
            
            let html = '', totalSec = 0, hasWarning = false;
            completedToday.forEach(c => {
                const range = c.bookType === 'lecture' ? `${c.startPage || '?'}Í∞ï~${c.endPage || '?'}Í∞ï` : `p.${c.startPage || '?'}~${c.endPage || '?'}`;
                const mins = Math.ceil(c.elapsed / 60);
                const warning = (!c.startPage || !c.endPage || c.elapsed === 0);
                if (warning) hasWarning = true;
                
                html += `<div class="check-item ${warning ? 'warning' : ''}">
                    <div>
                        <span class="subject">${c.subject}</span>
                        <span style="color:#888;font-size:0.8rem;"> ¬∑ ${c.book}</span>
                        <div style="font-size:0.75rem;color:${warning ? '#f59e0b' : '#888'};">${range} ${warning ? '‚ö†Ô∏è' : ''}</div>
                    </div>
                    <span class="time">${mins > 0 ? mins + 'Î∂Ñ' : '?Î∂Ñ'}</span>
                </div>`;
                totalSec += c.elapsed;
            });
            
            const totalMin = Math.ceil(totalSec / 60);
            const h = Math.floor(totalMin / 60), m = totalMin % 60;
            html += `<div class="check-total">Ï¥ù ${h > 0 ? h + 'ÏãúÍ∞Ñ ' : ''}${m}Î∂Ñ</div>`;
            
            if (hasWarning) {
                html += `<div style="color:#f59e0b;font-size:0.8rem;text-align:center;margin-top:10px;">‚ö†Ô∏è ÌéòÏù¥ÏßÄ/ÏãúÍ∞ÑÏù¥ ÎπÑÏñ¥ÏûàÎäî Ìï≠Î™©Ïù¥ ÏûàÏäµÎãàÎã§</div>`;
            }
            
            document.getElementById('checkSummary').innerHTML = html;
            currentPhotoData = null;
            document.getElementById('photoPreview').innerHTML = '<i class="fas fa-camera"></i><span>ÌÑ∞ÏπòÌïòÏó¨ ÏÇ¨ÏßÑ Ï¥¨ÏòÅ</span>';
            document.getElementById('photoPreview').classList.remove('has-photo');
            document.getElementById('checkModal').classList.add('active');
        }

        async function closeCheckModal(confirm) {
            document.getElementById('checkModal').classList.remove('active');
            if (!confirm || completedToday.length === 0) return;
            for (const c of completedToday) {
                await api({ 
                    action: 'requestCheck', 
                    floor: user.floor, 
                    name: user.name, 
                    date: c.dateStr, 
                    subject: c.subject, 
                    bookName: c.book, 
                    actualTime: Math.ceil(c.elapsed / 60), 
                    startPage: c.startPage, 
                    endPage: c.endPage, 
                    bookType: c.bookType,
                    photoData: currentPhotoData 
                });
            }
            completedToday = []; currentPhotoData = null;
            await loadPlans(); renderTable(); updateMood(); updateCheckBar();
            toast('üîî Í≤ÄÏÇ¨ ÏöîÏ≤≠ ÏôÑÎ£å!', 'success');
        }

        function cancelAllChecks() {
            if (completedToday.length === 0) return;
            if (confirm('ÏôÑÎ£åÎêú ÌïôÏäµ Í∏∞Î°ùÏùÑ Î™®Îëê Ï∑®ÏÜåÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                completedToday.forEach(c => { timers[c.key] = { state: 'idle', elapsed: 0, start: null, interval: null }; });
                completedToday = []; renderTable(); updateCheckBar(); toast('ÌïôÏäµ Í∏∞Î°ùÏù¥ Ï∑®ÏÜåÎêòÏóàÏäµÎãàÎã§');
            }
        }

        function startLongPress(e, subject, name, type) {
            longPressTimer = setTimeout(() => { selectedBook = { subject, name, type }; showContextMenu(e.clientX, e.clientY); longPressTimer = null; }, 500);
        }
        function endLongPress(e) { if (longPressTimer) { clearTimeout(longPressTimer); longPressTimer = null; } if (contextMenuJustOpened) { e.preventDefault(); e.stopPropagation(); } }
        function showContextMenu(x, y) {
            const menu = document.getElementById('contextMenu');
            menu.style.left = Math.min(x, window.innerWidth - 160) + 'px';
            menu.style.top = Math.min(y, window.innerHeight - 120) + 'px';
            menu.classList.add('active'); contextMenuJustOpened = true;
            if (navigator.vibrate) navigator.vibrate(50);
        }
        function hideContextMenu() { document.getElementById('contextMenu').classList.remove('active'); contextMenuJustOpened = false; }
        
        function editBook() {
            hideContextMenu(); if (!selectedBook) return;
            editMode = true; editingBookData = { ...selectedBook };
            document.getElementById('bookModalTitle').textContent = '‚úèÔ∏è ÍµêÏû¨ ÏàòÏ†ï';
            document.getElementById('bookSubject').value = selectedBook.subject;
            document.getElementById('bookSubject').disabled = true;
            document.getElementById('bookName').value = selectedBook.name;
            document.getElementById(selectedBook.type === 'lecture' ? 'typeLecture' : 'typeTextbook').checked = true;
            document.getElementById('bookModal').classList.add('active');
        }
        
        async function deleteBook() {
            hideContextMenu(); if (!selectedBook) return;
            if (!confirm(`"${selectedBook.name}" ÍµêÏû¨Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) return;
            const res = await api({ action: 'deleteBook', floor: user.floor, name: user.name, subject: selectedBook.subject, bookName: selectedBook.name });
            if (res.success) { books = books.filter(b => !(b.subject === selectedBook.subject && b.name === selectedBook.name)); renderTable(); toast('üóëÔ∏è ÏÇ≠Ï†úÎê®', 'success'); }
            else toast('ÏÇ≠Ï†ú Ïã§Ìå®');
            selectedBook = null;
        }

        function openBookModal(subject) {
            editMode = false; editingBookData = null;
            document.getElementById('bookModalTitle').textContent = 'üìö ÍµêÏû¨/Ïù∏Í∞ï Ï∂îÍ∞Ä';
            document.getElementById('bookSubject').value = subject || '';
            document.getElementById('bookSubject').disabled = false;
            document.getElementById('bookName').value = '';
            document.getElementById('typeTextbook').checked = true;
            document.getElementById('bookModal').classList.add('active');
        }

        function closeBookModal() {
            document.getElementById('bookModal').classList.remove('active');
            editMode = false; editingBookData = null; selectedBook = null;
            document.getElementById('bookSubject').disabled = false;
        }

        async function saveBook() {
            const subject = document.getElementById('bookSubject').value;
            const name = document.getElementById('bookName').value.trim();
            const type = document.querySelector('input[name="bookType"]:checked').value;
            if (!subject || !name) return toast('Í≥ºÎ™©Í≥º Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî', 'warning');
            
            if (editMode && editingBookData) {
                const res = await api({ action: 'updateBook', floor: user.floor, name: user.name, subject: editingBookData.subject, oldBookName: editingBookData.name, newBookName: name, bookType: type });
                if (res.success) {
                    const idx = books.findIndex(b => b.subject === editingBookData.subject && b.name === editingBookData.name);
                    if (idx >= 0) { books[idx].name = name; books[idx].type = type; }
                    closeBookModal(); renderTable(); toast('‚úèÔ∏è ÏàòÏ†ïÎê®', 'success');
                } else toast('ÏàòÏ†ï Ïã§Ìå®');
            } else {
                const res = await api({ action: 'addBook', floor: user.floor, name: user.name, subject, bookName: name, bookType: type });
                if (res.success) { books.push({ subject, name, type }); closeBookModal(); renderTable(); toast(type === 'lecture' ? 'üé¨ Ïù∏Í∞ï Ï∂îÍ∞ÄÎê®' : 'üìö ÍµêÏû¨ Ï∂îÍ∞ÄÎê®', 'success'); }
            }
        }

        async function updateMood() {
            const res = await api({ action: 'getRecords', floor: user.floor, name: user.name, date: fmt(new Date()) });
            if (res.success) {
                const totalTime = (res.records || []).filter(r => ['approved', 'O', 'requested'].includes(r.status)).reduce((sum, r) => sum + (r.actualTime || 0), 0);
                document.getElementById('mood').textContent = totalTime >= 480 ? 'üî•' : totalTime >= 240 ? 'üòä' : totalTime >= 60 ? 'üôÇ' : totalTime > 0 ? 'üí™' : 'üò¥';
            }
        }

        function toggleStats() {
            const panel = document.getElementById('statsPanel');
            panel.classList.toggle('active');
            if (panel.classList.contains('active')) loadStats();
        }

        async function loadStats() {
            const res = await api({ action: 'getStats', floor: user.floor, name: user.name });
            if (res.success) {
                const s = res.stats;
                document.getElementById('statTotal').textContent = s.totalPlans || 0;
                document.getElementById('statDone').textContent = s.completed || 0;
                document.getElementById('statTime').textContent = (s.totalTimeHours || 0) + 'h';
                document.getElementById('statRate').textContent = (s.rate || 0) + '%';
            }
        }

        async function captureShare() {
            try {
                toast('üì∏ Ï∫°Ï≤ò Ï§ë...');
                const captureArea = document.getElementById('captureArea');
                const captureHeader = document.getElementById('captureHeader');
                const wrapper = document.querySelector('.table-wrapper');
                const dates = getWeekDates();
                document.getElementById('captureInfo').textContent = `${user.name} ¬∑ ${user.floor} ¬∑ ${dates[0].getMonth()+1}Ïõî ${Math.ceil(dates[0].getDate()/7)}Ï£ºÏ∞®`;
                captureHeader.classList.add('visible'); captureArea.classList.add('capture-mode');
                const origOverflow = wrapper.style.overflow, origHeight = wrapper.style.height;
                wrapper.style.overflow = 'visible'; wrapper.style.height = 'auto';
                await new Promise(r => setTimeout(r, 150));
                const canvas = await html2canvas(captureArea, { backgroundColor: '#fff', scale: 2, useCORS: true });
                captureHeader.classList.remove('visible'); captureArea.classList.remove('capture-mode');
                wrapper.style.overflow = origOverflow; wrapper.style.height = origHeight;
                canvas.toBlob(async blob => {
                    try { await navigator.clipboard.write([new ClipboardItem({'image/png': blob})]); toast('üìã Î≥µÏÇ¨Îê®! Ïπ¥ÌÜ°Ïóê Î∂ôÏó¨ÎÑ£Í∏∞', 'success'); }
                    catch { const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${user.name}_Í≥ÑÌöçÌëú.png`; a.click(); toast('üì• Ï†ÄÏû•Îê®', 'success'); }
                }, 'image/png');
            } catch (e) { console.error(e); toast('Ï∫°Ï≤ò Ïã§Ìå®'); }
        }

        function toast(msg, type = '') {
            const t = document.getElementById('toast');
            t.textContent = msg; t.className = 'toast' + (type ? ` ${type}` : '');
            t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2500);
        }
    </script>
</body>
</html>
