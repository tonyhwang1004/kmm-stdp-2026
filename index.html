<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ê¹€ì—„ë§ˆë…ì„œì‹¤ | ì¼ì¼í”Œë˜ë„ˆ</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            /* ê¸°ë³¸ í…Œë§ˆ: ì˜¤ì…˜ ë¸”ë£¨ */
            --primary: #1e3a5f;
            --primary-light: #2d5a8b;
            --primary-dark: #0f1f33;
            --accent: #3b82f6;
            --accent-light: #60a5fa;
            --bg-gradient: linear-gradient(135deg, #1e3a5f, #0f1f33);
            --card-bg: #f0f9ff;
            --header-text: white;
        }

        /* ğŸŒ¸ ì²´ë¦¬ ë¸”ë¼ì¸ */
        [data-theme="cherry"] {
            --primary: #db2777;
            --primary-light: #ec4899;
            --primary-dark: #9d174d;
            --accent: #f472b6;
            --accent-light: #fbcfe8;
            --bg-gradient: linear-gradient(135deg, #db2777, #9d174d);
            --card-bg: #fdf2f8;
        }

        /* ğŸŒ¿ ë¯¼íŠ¸ ê·¸ë¦° */
        [data-theme="mint"] {
            --primary: #059669;
            --primary-light: #10b981;
            --primary-dark: #064e3b;
            --accent: #34d399;
            --accent-light: #a7f3d0;
            --bg-gradient: linear-gradient(135deg, #059669, #064e3b);
            --card-bg: #ecfdf5;
        }

        /* ğŸŒ™ ë‹¤í¬ ë‚˜ì´íŠ¸ */
        [data-theme="dark"] {
            --primary: #1f1f1f;
            --primary-light: #374151;
            --primary-dark: #0a0a0a;
            --accent: #8b5cf6;
            --accent-light: #c4b5fd;
            --bg-gradient: linear-gradient(135deg, #1f1f1f, #0a0a0a);
            --card-bg: #27272a;
            --header-text: #e4e4e7;
        }

        /* ğŸ’œ ë°”ì´ì˜¬ë › ë“œë¦¼ */
        [data-theme="violet"] {
            --primary: #7c3aed;
            --primary-light: #8b5cf6;
            --primary-dark: #5b21b6;
            --accent: #a78bfa;
            --accent-light: #ddd6fe;
            --bg-gradient: linear-gradient(135deg, #7c3aed, #5b21b6);
            --card-bg: #f5f3ff;
        }

        /* ğŸŠ ì„ ì…‹ ì˜¤ë Œì§€ */
        [data-theme="sunset"] {
            --primary: #ea580c;
            --primary-light: #f97316;
            --primary-dark: #c2410c;
            --accent: #fb923c;
            --accent-light: #fed7aa;
            --bg-gradient: linear-gradient(135deg, #ea580c, #dc2626);
            --card-bg: #fff7ed;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { 
            height: 100%; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f0f0f0;
            overflow: hidden;
        }

        /* ë¡œê·¸ì¸ */
        .login-screen {
            position: fixed;
            inset: 0;
            background: var(--bg-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .login-screen.hidden { display: none; }
        .login-box {
            background: white;
            border-radius: 24px;
            padding: 2rem;
            width: 90%;
            max-width: 340px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .login-box h1 { 
            color: var(--primary); 
            margin-bottom: 0.5rem;
            font-size: 1.5rem;
        }
        .login-box .subtitle {
            color: #888;
            font-size: 0.85rem;
            margin-bottom: 1.5rem;
        }
        .login-box select {
            width: 100%;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 2px solid #e5e5e5;
            border-radius: 12px;
            font-size: 1rem;
            background: #fafafa;
            transition: border-color 0.2s;
        }
        .login-box select:focus {
            outline: none;
            border-color: var(--accent);
        }
        .login-box button {
            width: 100%;
            padding: 1rem;
            background: var(--bg-gradient);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .login-box button:active {
            transform: scale(0.98);
        }

        /* ë©”ì¸ */
        .container {
            display: none;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
        }
        .container.active { display: flex; }

        /* í—¤ë” */
        .header {
            background: var(--bg-gradient);
            color: var(--header-text, white);
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .mood { font-size: 1.6rem; }
        .name { font-weight: 600; font-size: 1.1rem; }
        .header-right {
            display: flex;
            gap: 8px;
        }
        .header-btn {
            width: 38px; height: 38px;
            background: rgba(255,255,255,0.15);
            border: none;
            border-radius: 10px;
            color: var(--header-text, white);
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .header-btn:hover {
            background: rgba(255,255,255,0.25);
        }

        /* ì£¼ì°¨ ë°” */
        .week-bar {
            background: white;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e5e5e5;
        }
        .week-nav {
            width: 32px; height: 32px;
            background: #f5f5f5;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            transition: background 0.2s;
        }
        .week-nav:hover { background: #e5e5e5; }
        .week-info { text-align: center; }
        .week-title { font-weight: 700; color: var(--primary); font-size: 1.1rem; }
        .week-range { font-size: 0.75rem; color: #999; margin-top: 2px; }

        /* í…Œì´ë¸” ì˜ì—­ */
        .table-wrapper {
            flex: 1;
            overflow: auto;
            padding: 10px;
            padding-bottom: 80px;
        }
        .plan-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            min-width: 750px;
        }
        .plan-table th {
            background: var(--primary);
            color: white;
            padding: 12px 6px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .plan-table th.subject-col { width: 55px; }
        .plan-table th.add-col { width: 42px; }
        .plan-table th.book-col { width: 85px; }
        .plan-table td {
            border: 1px solid #e5e5e5;
            padding: 4px;
            vertical-align: top;
            height: 80px;
        }
        .subject-cell {
            background: linear-gradient(135deg, #f8f8f8, #f0f0f0);
            text-align: center;
            font-weight: 700;
            font-size: 0.9rem;
            color: var(--primary);
            vertical-align: middle !important;
        }
        .add-cell {
            background: #f8f8f8;
            text-align: center;
            vertical-align: middle !important;
        }
        .book-cell {
            background: var(--card-bg);
            font-size: 0.65rem;
            vertical-align: middle !important;
            text-align: center;
            font-weight: 600;
            color: #555;
            padding: 6px 4px;
            cursor: pointer;
            transition: background 0.2s;
            user-select: none;
            -webkit-user-select: none;
        }
        .book-cell:active {
            background: #e0e0e0;
        }
        .book-cell .book-type {
            font-size: 0.55rem;
            padding: 2px 5px;
            border-radius: 4px;
            display: inline-block;
            margin-bottom: 3px;
            font-weight: 700;
        }
        .book-cell .book-type.lecture {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            color: #1e40af;
        }
        .book-cell .book-type.textbook {
            background: linear-gradient(135deg, #dcfce7, #bbf7d0);
            color: #166534;
        }
        .book-cell .book-name {
            word-break: keep-all;
            line-height: 1.3;
        }
        .add-btn {
            width: 32px; height: 32px;
            background: linear-gradient(135deg, #e0f2fe, #bae6fd);
            border: 2px dashed var(--accent);
            border-radius: 8px;
            color: var(--accent);
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .add-btn:hover {
            background: var(--accent);
            color: white;
            border-style: solid;
        }

        /* ìš”ì¼ í—¤ë” */
        .day-header { text-align: center; }
        .day-name { font-size: 0.7rem; opacity: 0.9; }
        .day-num { font-size: 1.05rem; font-weight: 700; }
        .today { background: var(--accent) !important; }
        .sat .day-num { color: #93c5fd; }
        .sun .day-num { color: #fca5a5; }

        /* ë°ì´ ì…€ */
        .day-cell {
            position: relative;
            padding: 4px !important;
        }

        /* + ë²„íŠ¼ (ì…€ ë‚´) */
        .cell-add {
            width: 100%;
            height: 100%;
            min-height: 70px;
            background: transparent;
            border: 2px dashed #d5d5d5;
            border-radius: 8px;
            color: #bbb;
            font-size: 1.6rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .cell-add:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--card-bg);
        }

        /* ê³„íš ì¹´ë“œ */
        .plan-card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #e5e5e5;
            margin-bottom: 4px;
            transition: all 0.2s;
        }
        .plan-card.completed { 
            border-color: #86efac; 
            background: linear-gradient(135deg, #f0fdf4, #dcfce7); 
        }
        .plan-card.pending { 
            border-color: #fcd34d; 
            background: linear-gradient(135deg, #fefce8, #fef9c3); 
        }
        .plan-card.failed { 
            border-color: #fca5a5; 
            background: linear-gradient(135deg, #fef2f2, #fee2e2); 
        }
        .plan-card.paused { 
            border-color: #c4b5fd; 
            background: linear-gradient(135deg, #f5f3ff, #ede9fe); 
        }
        .plan-card.running {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }
        .plan-card.done-local {
            border-color: #86efac;
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
        }

        /* ì¹´ë“œ ìƒë‹¨ */
        .card-top {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 5px 6px;
            background: rgba(0,0,0,0.02);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        
        .timer-btn {
            width: 26px; height: 26px;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 0.55rem;
            cursor: pointer;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .play-btn { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .play-btn:disabled { background: #d1d5db; cursor: not-allowed; box-shadow: none; }
        .pause-btn { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .pause-btn:disabled { background: #d1d5db; cursor: not-allowed; box-shadow: none; }
        .stop-btn { background: linear-gradient(135deg, #10b981, #059669); }
        .stop-btn:disabled { background: #d1d5db; cursor: not-allowed; box-shadow: none; }
        
        .play-btn.active {
            background: linear-gradient(135deg, #10b981, #059669);
            animation: pulse 1.5s infinite;
        }
        .pause-btn.active {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); }
        }
        
        .card-timer {
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--primary);
            font-family: 'SF Mono', Monaco, monospace;
            margin-left: 3px;
        }
        .card-status {
            margin-left: auto;
            font-size: 0.9rem;
        }

        /* ì¹´ë“œ í•˜ë‹¨ - ì™„ë£Œ í›„ ë²”ìœ„ í‘œì‹œ */
        .card-bottom {
            padding: 4px 6px;
            font-size: 0.7rem;
            color: #666;
            text-align: center;
        }
        .card-range {
            background: rgba(0,0,0,0.05);
            padding: 3px 6px;
            border-radius: 4px;
            font-weight: 600;
        }

        /* í•˜ë‹¨ ê²€ì‚¬ ë°” */
        .check-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 12px 15px;
            border-top: 1px solid #e5e5e5;
            display: flex;
            gap: 10px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
            z-index: 50;
        }
        .check-bar-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .check-bar-title {
            font-weight: 700;
            color: var(--primary);
            font-size: 0.9rem;
        }
        .check-bar-status {
            font-size: 0.75rem;
            color: #888;
            margin-top: 2px;
        }
        .check-bar-btns {
            display: flex;
            gap: 8px;
        }
        .check-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .check-btn.request {
            background: linear-gradient(135deg, var(--accent), var(--primary));
            color: white;
        }
        .check-btn.request:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }
        .check-btn.cancel {
            background: #f5f5f5;
            color: #666;
        }
        .check-btn i {
            margin-right: 5px;
        }

        /* í†µê³„ íŒ¨ë„ */
        .stats-panel {
            display: none;
            position: fixed;
            bottom: 70px; left: 10px; right: 10px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 -4px 30px rgba(0,0,0,0.15);
            padding: 20px;
            z-index: 100;
        }
        .stats-panel.active { display: block; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        .stat-item {
            text-align: center;
            padding: 12px;
            background: linear-gradient(135deg, #f8f8f8, #f0f0f0);
            border-radius: 12px;
        }
        .stat-value { font-size: 1.5rem; font-weight: 700; color: var(--primary); }
        .stat-label { font-size: 0.65rem; color: #999; margin-top: 2px; }
        .close-stats {
            position: absolute; top: 12px; right: 12px;
            background: none; border: none; font-size: 1.3rem; color: #999;
            cursor: pointer;
        }

        /* ëª¨ë‹¬ ê³µí†µ */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 500;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }
        .modal.active { display: flex; }
        .modal-box {
            background: white;
            border-radius: 20px;
            padding: 1.5rem;
            width: 90%;
            max-width: 340px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .modal-box h3 { 
            margin-bottom: 1rem; 
            color: var(--primary);
            font-size: 1.2rem;
        }
        .modal-box select, .modal-box input[type="text"] {
            width: 100%;
            padding: 12px;
            margin-bottom: 12px;
            border: 2px solid #e5e5e5;
            border-radius: 12px;
            font-size: 1rem;
            background: #fafafa;
        }
        .modal-box select:focus, .modal-box input:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        /* ìœ í˜• ì„ íƒ */
        .type-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .type-option {
            flex: 1;
            position: relative;
        }
        .type-option input {
            position: absolute;
            opacity: 0;
        }
        .type-option label {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            border: 2px solid #e5e5e5;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .type-option label i {
            font-size: 1.8rem;
            margin-bottom: 6px;
            color: #888;
        }
        .type-option label span {
            font-weight: 600;
            color: #666;
        }
        .type-option input:checked + label {
            border-color: var(--accent);
            background: var(--card-bg);
        }
        .type-option input:checked + label i {
            color: var(--accent);
        }
        .type-option input:checked + label span {
            color: var(--primary);
        }
        
        .modal-btns {
            display: flex;
            gap: 10px;
            margin-top: 5px;
        }
        .modal-btns button {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .modal-btns .cancel { background: #f0f0f0; color: #666; }
        .modal-btns .confirm { background: var(--accent); color: white; }
        .modal-btns .danger { background: #ef4444; color: white; }

        /* í…Œë§ˆ ì„ íƒ ëª¨ë‹¬ */
        .theme-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        .theme-option {
            padding: 15px;
            border: 3px solid #e5e5e5;
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        .theme-option.active {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .theme-option .theme-preview {
            width: 100%;
            height: 40px;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .theme-option .theme-name {
            font-weight: 600;
            font-size: 0.85rem;
        }

        /* ìˆ˜ì •/ì‚­ì œ ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ */
        .context-menu {
            display: none;
            position: fixed;
            background: white;
            border-radius: 14px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
            z-index: 600;
            min-width: 140px;
        }
        .context-menu.active { display: block; }
        .context-menu-item {
            padding: 14px 18px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 0.95rem;
        }
        .context-menu-item:hover {
            background: #f5f5f5;
        }
        .context-menu-item.danger {
            color: #ef4444;
        }
        .context-menu-item i {
            width: 18px;
            text-align: center;
        }

        /* ê²€ì‚¬ ìš”ì²­ ëª¨ë‹¬ */
        .check-modal .check-summary {
            background: linear-gradient(135deg, #f8f8f8, #f0f0f0);
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
            max-height: 200px;
            overflow-y: auto;
        }
        .check-modal .check-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e5e5e5;
        }
        .check-modal .check-item:last-child {
            border-bottom: none;
        }
        .check-modal .check-item .subject {
            font-weight: 600;
            color: var(--primary);
        }
        .check-modal .check-item .time {
            font-family: monospace;
            color: var(--accent);
            font-weight: 600;
        }
        .check-modal .check-total {
            text-align: center;
            padding-top: 10px;
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary);
        }

        /* í† ìŠ¤íŠ¸ */
        .toast {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            opacity: 0;
            transition: all 0.3s;
            z-index: 700;
            font-weight: 500;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .toast.success { background: linear-gradient(135deg, #10b981, #059669); }
        .toast.warning { background: linear-gradient(135deg, #f59e0b, #d97706); }

        /* í•™ìŠµ ì™„ë£Œ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .complete-time {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, var(--card-bg), #f0f0f0);
            border-radius: 12px;
            margin-bottom: 12px;
        }
        .complete-time span:first-child {
            display: block;
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary);
            font-family: 'SF Mono', Monaco, monospace;
        }
        .complete-time-label {
            font-size: 0.8rem;
            color: #888;
        }
        .complete-info {
            text-align: center;
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e5e5e5;
        }
        
        .range-input-section {
            margin-bottom: 15px;
        }
        .range-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 10px;
        }
        .range-inputs {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .range-field {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .range-field label {
            font-size: 0.7rem;
            color: #888;
            margin-bottom: 4px;
        }
        .range-field input {
            width: 70px;
            padding: 12px 8px;
            text-align: center;
            border: 2px solid #e5e5e5;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: 600;
            background: #fafafa;
        }
        .range-field input:focus {
            outline: none;
            border-color: var(--accent);
            background: white;
        }
        .range-unit {
            font-size: 0.75rem;
            color: #888;
            margin-top: 4px;
        }
        .range-separator {
            font-size: 1.2rem;
            color: #888;
            margin-top: 15px;
        }
        
        .pencil-memo-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e5e5e5;
        }
        .pencil-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 8px;
        }
        .pencil-tools {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 8px;
        }
        .pencil-tool {
            width: 32px;
            height: 32px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .pencil-tool.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        .pencil-colors {
            display: flex;
            gap: 5px;
            margin-left: auto;
        }
        .pencil-color {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .pencil-color.active {
            border-color: #333;
            transform: scale(1.1);
        }
        .pencil-canvas-wrap {
            border: 2px solid #e5e5e5;
            border-radius: 10px;
            overflow: hidden;
            touch-action: none;
            background: #fffef5;
        }
        #pencilCanvas {
            width: 100%;
            height: 120px;
            display: block;
        }

        /* ìº¡ì²˜ìš© */
        .capture-header {
            display: none;
            background: var(--bg-gradient);
            color: white;
            padding: 18px 20px;
            text-align: center;
            border-radius: 12px 12px 0 0;
        }
        .capture-header.visible { display: block; }
        .capture-title { font-size: 1.3rem; font-weight: 700; margin-bottom: 4px; }
        .capture-info { font-size: 0.9rem; opacity: 0.9; }
        .capture-mode .plan-table { border-radius: 0 0 12px 12px; }

        /* ë‹¤í¬ëª¨ë“œ íŠ¹ë³„ ì²˜ë¦¬ */
        [data-theme="dark"] .login-box,
        [data-theme="dark"] .modal-box,
        [data-theme="dark"] .stats-panel,
        [data-theme="dark"] .context-menu {
            background: #27272a;
            color: #e4e4e7;
        }
        [data-theme="dark"] .plan-table {
            background: #1f1f1f;
        }
        [data-theme="dark"] .plan-table td {
            border-color: #3f3f46;
        }
        [data-theme="dark"] .subject-cell {
            background: linear-gradient(135deg, #27272a, #1f1f1f);
            color: #e4e4e7;
        }
        [data-theme="dark"] .week-bar,
        [data-theme="dark"] .check-bar {
            background: #27272a;
            border-color: #3f3f46;
        }
        [data-theme="dark"] .week-title {
            color: #e4e4e7;
        }
        [data-theme="dark"] .plan-card {
            background: #3f3f46;
            border-color: #52525b;
        }
        [data-theme="dark"] .card-timer {
            color: #e4e4e7;
        }
        [data-theme="dark"] .card-input {
            background: #27272a;
            color: #e4e4e7;
        }
    </style>
</head>
<body data-theme="ocean">
    <!-- ë¡œê·¸ì¸ -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <h1>ğŸ“š ê¹€ì—„ë§ˆë…ì„œì‹¤</h1>
            <p class="subtitle">ì¼ì¼ í”Œë˜ë„ˆ</p>
            <select id="loginFloor" onchange="loadStudents()">
                <option value="">ì¸µ ì„ íƒ</option>
                <option value="7ì¸µ">7ì¸µ</option>
                <option value="8ì¸µ">8ì¸µ</option>
            </select>
            <select id="loginName">
                <option value="">ì´ë¦„ ì„ íƒ</option>
            </select>
            <button onclick="login()">ì‹œì‘í•˜ê¸°</button>
        </div>
    </div>

    <!-- ë©”ì¸ -->
    <div class="container" id="container">
        <div class="header">
            <div class="header-left">
                <span class="mood" id="mood">ğŸ˜Š</span>
                <span class="name" id="userName">í•™ìƒ</span>
            </div>
            <div class="header-right">
                <button class="header-btn" onclick="openThemeModal()" title="í…Œë§ˆ"><i class="fas fa-palette"></i></button>
                <button class="header-btn" onclick="toggleStats()" title="í†µê³„"><i class="fas fa-chart-bar"></i></button>
                <button class="header-btn" onclick="captureShare()" title="ê³µìœ "><i class="fas fa-camera"></i></button>
                <button class="header-btn" onclick="logout()" title="ë¡œê·¸ì•„ì›ƒ"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>

        <div class="week-bar">
            <button class="week-nav" onclick="changeWeek(-1)"><i class="fas fa-chevron-left"></i></button>
            <div class="week-info">
                <div class="week-title" id="weekTitle">2ì›” 1ì£¼ì°¨</div>
                <div class="week-range" id="weekRange">2/3(ì›”)~2/9(ì¼)</div>
            </div>
            <button class="week-nav" onclick="changeWeek(1)"><i class="fas fa-chevron-right"></i></button>
        </div>

        <div class="table-wrapper">
            <div id="captureArea">
                <div class="capture-header" id="captureHeader">
                    <div class="capture-title">ğŸ“š ê¹€ì—„ë§ˆë…ì„œì‹¤ ì£¼ê°„ê³„íší‘œ</div>
                    <div class="capture-info" id="captureInfo">í•™ìƒ Â· ì¸µ Â· ì£¼ì°¨</div>
                </div>
                <table class="plan-table">
                <thead id="tableHead"></thead>
                <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- í•˜ë‹¨ ê²€ì‚¬ ë°” -->
        <div class="check-bar">
            <div class="check-bar-info">
                <div class="check-bar-title">ì˜¤ëŠ˜ì˜ í•™ìŠµ</div>
                <div class="check-bar-status" id="checkBarStatus">ì™„ë£Œ: 0ê°œ Â· 0ë¶„</div>
            </div>
            <div class="check-bar-btns">
                <button class="check-btn cancel" onclick="cancelAllChecks()" id="cancelCheckBtn" style="display:none;">
                    <i class="fas fa-times"></i>ì·¨ì†Œ
                </button>
                <button class="check-btn request" onclick="openCheckModal()" id="requestCheckBtn" disabled>
                    <i class="fas fa-bell"></i>ê²€ì‚¬ ìš”ì²­
                </button>
            </div>
        </div>

        <div class="stats-panel" id="statsPanel">
            <button class="close-stats" onclick="toggleStats()"><i class="fas fa-times"></i></button>
            <div class="stats-grid">
                <div class="stat-item"><div class="stat-value" id="statTotal">0</div><div class="stat-label">ì´ ê³„íš</div></div>
                <div class="stat-item"><div class="stat-value" id="statDone" style="color:#10b981">0</div><div class="stat-label">ì™„ë£Œ</div></div>
                <div class="stat-item"><div class="stat-value" id="statTime" style="color:var(--accent)">0h</div><div class="stat-label">ê³µë¶€ì‹œê°„</div></div>
                <div class="stat-item"><div class="stat-value" id="statRate" style="color:#f59e0b">0%</div><div class="stat-label">ì‹¤ì²œìœ¨</div></div>
            </div>
        </div>
    </div>

    <!-- ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ (êµì¬ ìˆ˜ì •/ì‚­ì œ) -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="editBook()">
            <i class="fas fa-edit"></i>
            <span>ìˆ˜ì •</span>
        </div>
        <div class="context-menu-item danger" onclick="deleteBook()">
            <i class="fas fa-trash"></i>
            <span>ì‚­ì œ</span>
        </div>
    </div>

    <!-- êµì¬/ì¸ê°• ì¶”ê°€ ëª¨ë‹¬ -->
    <div class="modal" id="bookModal">
        <div class="modal-box">
            <h3 id="bookModalTitle">ğŸ“š êµì¬/ì¸ê°• ì¶”ê°€</h3>
            <select id="bookSubject">
                <option value="">ê³¼ëª© ì„ íƒ</option>
                <option value="êµ­ì–´">êµ­ì–´</option>
                <option value="ìˆ˜í•™">ìˆ˜í•™</option>
                <option value="ì˜ì–´">ì˜ì–´</option>
                <option value="íƒêµ¬">íƒêµ¬</option>
            </select>
            <div class="type-selector">
                <div class="type-option">
                    <input type="radio" name="bookType" id="typeTextbook" value="textbook" checked>
                    <label for="typeTextbook">
                        <i class="fas fa-book"></i>
                        <span>êµì¬</span>
                    </label>
                </div>
                <div class="type-option">
                    <input type="radio" name="bookType" id="typeLecture" value="lecture">
                    <label for="typeLecture">
                        <i class="fas fa-video"></i>
                        <span>ì¸ê°•</span>
                    </label>
                </div>
            </div>
            <input type="text" id="bookName" placeholder="êµì¬ëª… ë˜ëŠ” ê°•ì˜ëª…">
            <div class="modal-btns">
                <button class="cancel" onclick="closeBookModal()">ì·¨ì†Œ</button>
                <button class="confirm" onclick="saveBook()">ì €ì¥</button>
            </div>
        </div>
    </div>

    <!-- í…Œë§ˆ ì„ íƒ ëª¨ë‹¬ -->
    <div class="modal" id="themeModal">
        <div class="modal-box">
            <h3>ğŸ¨ í”Œë˜ë„ˆ í…Œë§ˆ</h3>
            <div class="theme-grid">
                <div class="theme-option active" data-theme="ocean" onclick="selectTheme('ocean')">
                    <div class="theme-preview" style="background: linear-gradient(135deg, #1e3a5f, #3b82f6);"></div>
                    <div class="theme-name">ğŸŒŠ ì˜¤ì…˜ ë¸”ë£¨</div>
                </div>
                <div class="theme-option" data-theme="cherry" onclick="selectTheme('cherry')">
                    <div class="theme-preview" style="background: linear-gradient(135deg, #db2777, #f472b6);"></div>
                    <div class="theme-name">ğŸŒ¸ ì²´ë¦¬ ë¸”ë¼ì¸</div>
                </div>
                <div class="theme-option" data-theme="mint" onclick="selectTheme('mint')">
                    <div class="theme-preview" style="background: linear-gradient(135deg, #059669, #34d399);"></div>
                    <div class="theme-name">ğŸŒ¿ ë¯¼íŠ¸ ê·¸ë¦°</div>
                </div>
                <div class="theme-option" data-theme="violet" onclick="selectTheme('violet')">
                    <div class="theme-preview" style="background: linear-gradient(135deg, #7c3aed, #a78bfa);"></div>
                    <div class="theme-name">ğŸ’œ ë°”ì´ì˜¬ë ›</div>
                </div>
                <div class="theme-option" data-theme="sunset" onclick="selectTheme('sunset')">
                    <div class="theme-preview" style="background: linear-gradient(135deg, #ea580c, #f97316);"></div>
                    <div class="theme-name">ğŸŠ ì„ ì…‹</div>
                </div>
                <div class="theme-option" data-theme="dark" onclick="selectTheme('dark')">
                    <div class="theme-preview" style="background: linear-gradient(135deg, #1f1f1f, #8b5cf6);"></div>
                    <div class="theme-name">ğŸŒ™ ë‹¤í¬ ë‚˜ì´íŠ¸</div>
                </div>
            </div>
            <div class="modal-btns">
                <button class="confirm" onclick="closeThemeModal()" style="flex:1;">í™•ì¸</button>
            </div>
        </div>
    </div>

    <!-- ê²€ì‚¬ ìš”ì²­ ëª¨ë‹¬ -->
    <div class="modal check-modal" id="checkModal">
        <div class="modal-box">
            <h3>ğŸ“‹ ê²€ì‚¬ ìš”ì²­</h3>
            <div class="check-summary" id="checkSummary">
                <!-- ë™ì  ìƒì„± -->
            </div>
            <p style="font-size:0.85rem; color:#888; text-align:center;">ìœ„ ë‚´ìš©ìœ¼ë¡œ ê²€ì‚¬ë¥¼ ìš”ì²­í•©ë‹ˆë‹¤</p>
            <div class="modal-btns">
                <button class="cancel" onclick="closeCheckModal(false)">ì·¨ì†Œ</button>
                <button class="confirm" onclick="closeCheckModal(true)">ìš”ì²­í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <!-- í•™ìŠµ ì™„ë£Œ ì…ë ¥ ëª¨ë‹¬ (íœìŠ¬) -->
    <div class="modal" id="completeModal">
        <div class="modal-box" style="max-width: 360px;">
            <h3>âœï¸ í•™ìŠµ ì™„ë£Œ ê¸°ë¡</h3>
            <div class="complete-time">
                <span id="completeTimeDisplay">00:00</span>
                <span class="complete-time-label">í•™ìŠµ ì‹œê°„</span>
            </div>
            <div class="complete-info" id="completeInfo">ìˆ˜í•™ Â· ìˆ˜í•™ì˜ì •ì„</div>
            
            <!-- ë²”ìœ„ ì…ë ¥ -->
            <div class="range-input-section">
                <div class="range-label" id="rangeLabel">ê³µë¶€í•œ ë²”ìœ„ë¥¼ ì…ë ¥í•˜ì„¸ìš”</div>
                <div class="range-inputs">
                    <div class="range-field">
                        <label id="startLabel">ì‹œì‘</label>
                        <input type="text" id="completeStart" placeholder="ì˜ˆ: 10">
                        <span class="range-unit" id="startUnit">p.</span>
                    </div>
                    <span class="range-separator">~</span>
                    <div class="range-field">
                        <label id="endLabel">ë</label>
                        <input type="text" id="completeEnd" placeholder="ì˜ˆ: 25">
                        <span class="range-unit" id="endUnit">p.</span>
                    </div>
                </div>
            </div>
            
            <!-- íœìŠ¬ ë©”ëª¨ ì˜ì—­ -->
            <div class="pencil-memo-section">
                <div class="pencil-label">ğŸ“ ë©”ëª¨ (íœìŠ¬ë¡œ ì‘ì„±)</div>
                <div class="pencil-tools">
                    <button class="pencil-tool active" onclick="setPencilTool('pen')"><i class="fas fa-pen"></i></button>
                    <button class="pencil-tool" onclick="setPencilTool('eraser')"><i class="fas fa-eraser"></i></button>
                    <button class="pencil-tool" onclick="clearPencilCanvas()"><i class="fas fa-trash"></i></button>
                    <div class="pencil-colors">
                        <span class="pencil-color active" style="background:#333" onclick="setPencilColor('#333')"></span>
                        <span class="pencil-color" style="background:#ef4444" onclick="setPencilColor('#ef4444')"></span>
                        <span class="pencil-color" style="background:#3b82f6" onclick="setPencilColor('#3b82f6')"></span>
                    </div>
                </div>
                <div class="pencil-canvas-wrap">
                    <canvas id="pencilCanvas"></canvas>
                </div>
            </div>
            
            <div class="modal-btns">
                <button class="cancel" onclick="closeCompleteModal(false)">ì·¨ì†Œ</button>
                <button class="confirm" onclick="closeCompleteModal(true)">ì™„ë£Œ</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        const API = 'https://script.google.com/macros/s/AKfycbwGFbsj8FgFIuF-iFkJ4ekyS76MWQf9UrUysJ-Fs12vuVByJwenoYRgOJeOZiPOa6gzkg/exec';
        
        let user = null;
        let books = [];
        let plans = [];
        let weekStart = getMonday(new Date());
        let timers = {}; // { key: { state, elapsed, start, interval } }
        let completedToday = []; // ì˜¤ëŠ˜ ì™„ë£Œí•œ í•­ëª©ë“¤ (ê²€ì‚¬ ì „)
        
        // ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ìš©
        let selectedBook = null;
        let editMode = false;
        let longPressTimer = null;

        const SUBJECTS = ['êµ­ì–´', 'ìˆ˜í•™', 'ì˜ì–´', 'íƒêµ¬'];

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            loadTheme();
            document.addEventListener('click', hideContextMenu);
        });

        function getMonday(d) {
            const date = new Date(d);
            const day = date.getDay();
            return new Date(date.setDate(date.getDate() - day + (day === 0 ? -6 : 1)));
        }
        function fmt(d) { return d.toISOString().split('T')[0]; }
        function fmtKR(d) { return `${d.getMonth()+1}/${d.getDate()}`; }
        function dayName(i) { return ['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† ','ì¼'][i]; }
        function getWeekDates() {
            const arr = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(weekStart);
                d.setDate(weekStart.getDate() + i);
                arr.push(d);
            }
            return arr;
        }

        async function api(data) {
            try {
                const res = await fetch(API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(data)
                });
                return await res.json();
            } catch { return { success: false }; }
        }

        // ============ í…Œë§ˆ ============
        function loadTheme() {
            const saved = localStorage.getItem('plannerTheme') || 'ocean';
            applyTheme(saved);
        }
        
        function applyTheme(theme) {
            document.body.setAttribute('data-theme', theme);
            document.querySelectorAll('.theme-option').forEach(opt => {
                opt.classList.toggle('active', opt.dataset.theme === theme);
            });
        }
        
        function selectTheme(theme) {
            applyTheme(theme);
            localStorage.setItem('plannerTheme', theme);
        }
        
        function openThemeModal() {
            document.getElementById('themeModal').classList.add('active');
        }
        
        function closeThemeModal() {
            document.getElementById('themeModal').classList.remove('active');
        }

        // ============ ë¡œê·¸ì¸ ============
        async function loadStudents() {
            const floor = document.getElementById('loginFloor').value;
            const sel = document.getElementById('loginName');
            if (!floor) return;
            sel.innerHTML = '<option>ë¡œë”©ì¤‘...</option>';
            const res = await api({ action: 'getStudents', floor });
            if (res.success) {
                sel.innerHTML = '<option value="">ì´ë¦„ ì„ íƒ</option>' +
                    res.students.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
            }
        }

        async function login() {
            const floor = document.getElementById('loginFloor').value;
            const name = document.getElementById('loginName').value;
            if (!floor || !name) return toast('ì¸µê³¼ ì´ë¦„ì„ ì„ íƒí•˜ì„¸ìš”', 'warning');
            
            user = { floor, name };
            document.getElementById('userName').textContent = name;
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('container').classList.add('active');
            await loadData();
        }

        function logout() {
            user = null;
            timers = {};
            completedToday = [];
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('container').classList.remove('active');
        }

        async function loadData() {
            const bRes = await api({ action: 'getBooks', floor: user.floor, name: user.name });
            if (bRes.success) books = bRes.books || [];
            await loadPlans();
            renderWeek();
            renderTable();
            updateMood();
            updateCheckBar();
        }

        async function loadPlans() {
            const dates = getWeekDates();
            const res = await api({
                action: 'getWeekPlans',
                floor: user.floor,
                name: user.name,
                startDate: fmt(dates[0]),
                endDate: fmt(dates[6])
            });
            if (res.success) plans = res.plans || [];
        }

        function changeWeek(delta) {
            weekStart.setDate(weekStart.getDate() + delta * 7);
            loadPlans().then(() => { renderWeek(); renderTable(); });
        }

        function renderWeek() {
            const dates = getWeekDates();
            const m = dates[0].getMonth() + 1;
            const w = Math.ceil(dates[0].getDate() / 7);
            document.getElementById('weekTitle').textContent = `${m}ì›” ${w}ì£¼ì°¨`;
            document.getElementById('weekRange').textContent = `${fmtKR(dates[0])}(ì›”)~${fmtKR(dates[6])}(ì¼)`;
        }

        function renderTable() {
            const dates = getWeekDates();
            const today = fmt(new Date());

            // í—¤ë”
            let hHtml = '<tr><th class="subject-col">ê³¼ëª©</th><th class="add-col">+</th><th class="book-col">êµì¬</th>';
            for (let i = 0; i < 7; i++) {
                const d = dates[i];
                const isToday = fmt(d) === today;
                const cls = isToday ? 'today' : (i === 5 ? 'sat' : (i === 6 ? 'sun' : ''));
                hHtml += `<th class="${cls}"><div class="day-header ${cls}">
                    <div class="day-name">${dayName(i)}</div>
                    <div class="day-num">${d.getDate()}</div>
                </div></th>`;
            }
            hHtml += '</tr>';
            document.getElementById('tableHead').innerHTML = hHtml;

            // ë°”ë””
            let bHtml = '';
            SUBJECTS.forEach(subject => {
                const sBooks = books.filter(b => b.subject === subject);
                
                if (sBooks.length === 0) {
                    bHtml += `<tr>
                        <td class="subject-cell">${subject}</td>
                        <td class="add-cell"><button class="add-btn" onclick="openBookModal('${subject}')">+</button></td>
                        <td class="book-cell">-</td>`;
                    for (let i = 0; i < 7; i++) {
                        bHtml += `<td class="day-cell"><button class="cell-add" onclick="quickAdd('${subject}','${subject}','${fmt(dates[i])}','textbook')">+</button></td>`;
                    }
                    bHtml += '</tr>';
                } else {
                    sBooks.forEach((book, idx) => {
                        bHtml += '<tr>';
                        if (idx === 0) {
                            bHtml += `<td class="subject-cell" rowspan="${sBooks.length}">${subject}</td>`;
                            bHtml += `<td class="add-cell" rowspan="${sBooks.length}"><button class="add-btn" onclick="openBookModal('${subject}')">+</button></td>`;
                        }
                        
                        const typeLabel = book.type === 'lecture' ? 'ğŸ¬ ì¸ê°•' : 'ğŸ“– êµì¬';
                        const typeClass = book.type === 'lecture' ? 'lecture' : 'textbook';
                        bHtml += `<td class="book-cell" 
                            onpointerdown="startLongPress(event, '${subject}', '${book.name}', '${book.type || 'textbook'}')"
                            onpointerup="endLongPress()"
                            onpointerleave="endLongPress()">
                            <span class="book-type ${typeClass}">${typeLabel}</span>
                            <div class="book-name">${book.name}</div>
                        </td>`;
                        
                        for (let i = 0; i < 7; i++) {
                            const dateStr = fmt(dates[i]);
                            const dayPlans = plans.filter(p => p.date === dateStr && p.subject === subject && p.book === book.name);
                            
                            bHtml += `<td class="day-cell">`;
                            if (dayPlans.length > 0) {
                                const plan = dayPlans[0]; // í•˜ë‚˜ë§Œ!
                                const key = `${subject}-${book.name}-${dateStr}`;
                                const timer = timers[key] || { state: 'idle', elapsed: 0 };
                                const bookType = book.type || 'textbook';
                                
                                // ì™„ë£Œ ìƒíƒœ ì²´í¬
                                const isCompletedLocal = completedToday.some(c => c.key === key);
                                
                                let cardCls = '';
                                let statusIcon = '';
                                
                                if (plan.status === 'approved' || plan.status === 'O') {
                                    cardCls = 'completed';
                                    statusIcon = 'âœ…';
                                } else if (plan.status === 'failed' || plan.status === 'X') {
                                    cardCls = 'failed';
                                    statusIcon = 'âŒ';
                                } else if (plan.status === 'requested') {
                                    cardCls = 'pending';
                                    statusIcon = 'â³';
                                } else if (isCompletedLocal) {
                                    cardCls = 'done-local';
                                    statusIcon = 'âœ”ï¸';
                                }
                                
                                if (timer.state === 'running') cardCls = 'running';
                                if (timer.state === 'paused') cardCls = 'paused';
                                
                                const isServerComplete = ['approved', 'O', 'requested'].includes(plan.status);
                                const isRunning = timer.state === 'running';
                                const isPaused = timer.state === 'paused';
                                const isIdle = timer.state === 'idle';
                                
                                const timerDisplay = formatTime(timer.elapsed || 0);
                                
                                bHtml += `<div class="plan-card ${cardCls}">
                                    <div class="card-top">
                                        <button class="timer-btn play-btn ${isRunning ? 'active' : ''}" 
                                            onclick="timerPlay('${subject}','${book.name}','${dateStr}')" 
                                            ${isServerComplete || isCompletedLocal || isRunning ? 'disabled' : ''}>
                                            <i class="fas fa-play"></i>
                                        </button>
                                        <button class="timer-btn pause-btn ${isPaused ? 'active' : ''}" 
                                            onclick="timerPause('${subject}','${book.name}','${dateStr}')"
                                            ${isServerComplete || isCompletedLocal || isIdle ? 'disabled' : ''}>
                                            <i class="fas fa-pause"></i>
                                        </button>
                                        <button class="timer-btn stop-btn" 
                                            onclick="timerStop('${subject}','${book.name}','${dateStr}','${bookType}')"
                                            ${isServerComplete || isCompletedLocal || isIdle ? 'disabled' : ''}>
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <span class="card-timer" id="timer-${key}">${timerDisplay}</span>
                                        <span class="card-status">${statusIcon}</span>
                                    </div>
                                    <div class="card-bottom">
                                        ${getRangeDisplay(plan, bookType, isCompletedLocal, key)}
                                    </div>
                                </div>`;
                            } else {
                                bHtml += `<button class="cell-add" onclick="quickAdd('${subject}','${book.name}','${dateStr}','${book.type || 'textbook'}')">+</button>`;
                            }
                            bHtml += '</td>';
                        }
                        bHtml += '</tr>';
                    });
                }
            });
            
            document.getElementById('tableBody').innerHTML = bHtml;
        }

        function formatTime(seconds) {
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        }

        // ============ íƒ€ì´ë¨¸ ============
        function timerPlay(subject, book, dateStr) {
            const key = `${subject}-${book}-${dateStr}`;
            
            if (!timers[key]) {
                timers[key] = { state: 'idle', elapsed: 0, start: null, interval: null };
            }
            
            const timer = timers[key];
            if (timer.state === 'running') return;
            
            timer.state = 'running';
            timer.start = Date.now() - timer.elapsed * 1000;
            timer.interval = setInterval(() => {
                timer.elapsed = Math.floor((Date.now() - timer.start) / 1000);
                const el = document.getElementById(`timer-${key}`);
                if (el) el.textContent = formatTime(timer.elapsed);
            }, 1000);
            
            renderTable();
            toast('â±ï¸ í•™ìŠµ ì‹œì‘!');
        }
        
        function timerPause(subject, book, dateStr) {
            const key = `${subject}-${book}-${dateStr}`;
            const timer = timers[key];
            
            if (!timer || timer.state !== 'running') return;
            
            clearInterval(timer.interval);
            timer.interval = null;
            timer.state = 'paused';
            
            renderTable();
            toast('â¸ï¸ ì¼ì‹œì •ì§€');
        }
        
        function timerStop(subject, book, dateStr, bookType) {
            const key = `${subject}-${book}-${dateStr}`;
            const timer = timers[key];
            
            if (!timer || timer.state === 'idle') return;
            
            if (timer.interval) {
                clearInterval(timer.interval);
                timer.interval = null;
            }
            
            const elapsed = timer.elapsed;
            if (elapsed < 60) {
                toast('âš ï¸ ìµœì†Œ 1ë¶„ ì´ìƒ í•™ìŠµí•´ì£¼ì„¸ìš”', 'warning');
                return;
            }
            
            // ì™„ë£Œ ëª¨ë‹¬ ì—´ê¸°
            openCompleteModal(subject, book, dateStr, elapsed, bookType, key);
        }
        
        // ì™„ë£Œ ëª¨ë‹¬ ê´€ë ¨ ë³€ìˆ˜
        let pendingComplete = null;
        let pencilCanvas, pencilCtx;
        let isPencilDrawing = false;
        let pencilTool = 'pen';
        let pencilColor = '#333';
        
        function openCompleteModal(subject, book, dateStr, elapsed, bookType, key) {
            pendingComplete = { subject, book, dateStr, elapsed, bookType, key };
            
            // ëª¨ë‹¬ ì •ë³´ ì„¤ì •
            document.getElementById('completeTimeDisplay').textContent = formatTime(elapsed);
            document.getElementById('completeInfo').textContent = `${subject} Â· ${book}`;
            
            // ë²”ìœ„ ì…ë ¥ ë ˆì´ë¸” ì„¤ì •
            if (bookType === 'lecture') {
                document.getElementById('rangeLabel').textContent = 'ì‹œì²­í•œ ê°•ì˜ ë²”ìœ„ë¥¼ ì…ë ¥í•˜ì„¸ìš”';
                document.getElementById('startUnit').textContent = 'ê°•';
                document.getElementById('endUnit').textContent = 'ê°•';
                document.getElementById('completeStart').placeholder = 'ì˜ˆ: 1';
                document.getElementById('completeEnd').placeholder = 'ì˜ˆ: 3';
            } else {
                document.getElementById('rangeLabel').textContent = 'ê³µë¶€í•œ í˜ì´ì§€ ë²”ìœ„ë¥¼ ì…ë ¥í•˜ì„¸ìš”';
                document.getElementById('startUnit').textContent = 'p.';
                document.getElementById('endUnit').textContent = 'p.';
                document.getElementById('completeStart').placeholder = 'ì˜ˆ: 10';
                document.getElementById('completeEnd').placeholder = 'ì˜ˆ: 25';
            }
            
            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            document.getElementById('completeStart').value = '';
            document.getElementById('completeEnd').value = '';
            
            // ëª¨ë‹¬ ì—´ê¸°
            document.getElementById('completeModal').classList.add('active');
            
            // íœìŠ¬ ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
            setTimeout(initPencilCanvas, 100);
        }
        
        function closeCompleteModal(confirm) {
            document.getElementById('completeModal').classList.remove('active');
            
            if (!confirm || !pendingComplete) {
                // ì·¨ì†Œ ì‹œ íƒ€ì´ë¨¸ ê³„ì† ìœ ì§€ (ì¼ì‹œì •ì§€ ìƒíƒœë¡œ)
                if (pendingComplete) {
                    const timer = timers[pendingComplete.key];
                    if (timer) timer.state = 'paused';
                    renderTable();
                }
                pendingComplete = null;
                return;
            }
            
            const { subject, book, dateStr, elapsed, bookType, key } = pendingComplete;
            const startPage = document.getElementById('completeStart').value.trim();
            const endPage = document.getElementById('completeEnd').value.trim();
            
            // ë²”ìœ„ ì…ë ¥ ê²€ì¦
            if (!startPage || !endPage) {
                toast('âš ï¸ ë²”ìœ„ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”', 'warning');
                document.getElementById('completeModal').classList.add('active');
                return;
            }
            
            // ë©”ëª¨ ì´ë¯¸ì§€ ì €ì¥
            const memoImage = pencilCanvas ? pencilCanvas.toDataURL() : null;
            
            // ì™„ë£Œ ëª©ë¡ì— ì¶”ê°€
            completedToday.push({
                key,
                subject,
                book,
                dateStr,
                elapsed,
                bookType,
                startPage,
                endPage,
                memoImage
            });
            
            // plansì—ë„ ë²”ìœ„ ì—…ë°ì´íŠ¸
            const plan = plans.find(p => p.date === dateStr && p.subject === subject && p.book === book);
            if (plan) {
                plan.startPage = startPage;
                plan.endPage = endPage;
            }
            
            // ì„œë²„ì— í˜ì´ì§€ ì •ë³´ ì €ì¥
            api({
                action: 'updatePlanPage',
                floor: user.floor,
                name: user.name,
                date: dateStr,
                subject,
                bookName: book,
                startPage,
                endPage
            });
            
            // íƒ€ì´ë¨¸ ë¦¬ì…‹
            timers[key] = { state: 'idle', elapsed: 0, start: null, interval: null };
            
            pendingComplete = null;
            renderTable();
            updateCheckBar();
            toast('âœ… í•™ìŠµ ì™„ë£Œ! ê²€ì‚¬ ìš”ì²­ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”', 'success');
        }
        
        // ë²”ìœ„ í‘œì‹œ í•¨ìˆ˜
        function getRangeDisplay(plan, bookType, isCompletedLocal, key) {
            const completed = completedToday.find(c => c.key === key);
            const start = completed?.startPage || plan?.startPage;
            const end = completed?.endPage || plan?.endPage;
            
            if (start && end) {
                const unit = bookType === 'lecture' ? 'ê°•' : 'p.';
                return `<span class="card-range">${unit}${start} ~ ${unit}${end}</span>`;
            }
            return '<span style="color:#bbb;font-size:0.65rem;">â–¶ ì‹œì‘í•˜ê¸°</span>';
        }
        
        // íœìŠ¬ ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
        function initPencilCanvas() {
            pencilCanvas = document.getElementById('pencilCanvas');
            if (!pencilCanvas) return;
            
            const wrap = pencilCanvas.parentElement;
            pencilCanvas.width = wrap.clientWidth;
            pencilCanvas.height = 120;
            
            pencilCtx = pencilCanvas.getContext('2d');
            pencilCtx.fillStyle = '#fffef5';
            pencilCtx.fillRect(0, 0, pencilCanvas.width, pencilCanvas.height);
            pencilCtx.lineCap = 'round';
            pencilCtx.lineJoin = 'round';
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            pencilCanvas.addEventListener('pointerdown', startPencilDraw);
            pencilCanvas.addEventListener('pointermove', pencilDraw);
            pencilCanvas.addEventListener('pointerup', endPencilDraw);
            pencilCanvas.addEventListener('pointerleave', endPencilDraw);
        }
        
        function startPencilDraw(e) {
            isPencilDrawing = true;
            const rect = pencilCanvas.getBoundingClientRect();
            pencilCtx.beginPath();
            pencilCtx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        }
        
        function pencilDraw(e) {
            if (!isPencilDrawing) return;
            const rect = pencilCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            if (pencilTool === 'pen') {
                pencilCtx.strokeStyle = pencilColor;
                pencilCtx.lineWidth = 2;
                pencilCtx.lineTo(x, y);
                pencilCtx.stroke();
            } else {
                pencilCtx.fillStyle = '#fffef5';
                pencilCtx.beginPath();
                pencilCtx.arc(x, y, 12, 0, Math.PI * 2);
                pencilCtx.fill();
            }
        }
        
        function endPencilDraw() {
            isPencilDrawing = false;
        }
        
        function setPencilTool(tool) {
            pencilTool = tool;
            document.querySelectorAll('.pencil-tool').forEach((btn, i) => {
                btn.classList.toggle('active', i === (tool === 'pen' ? 0 : 1));
            });
        }
        
        function setPencilColor(color) {
            pencilColor = color;
            document.querySelectorAll('.pencil-color').forEach(dot => {
                dot.classList.toggle('active', dot.style.background === color);
            });
        }
        
        function clearPencilCanvas() {
            if (pencilCtx) {
                pencilCtx.fillStyle = '#fffef5';
                pencilCtx.fillRect(0, 0, pencilCanvas.width, pencilCanvas.height);
            }
        }

        // ============ ê²€ì‚¬ ë°” ============
        function updateCheckBar() {
            const count = completedToday.length;
            const totalMin = completedToday.reduce((sum, c) => sum + Math.ceil(c.elapsed / 60), 0);
            
            document.getElementById('checkBarStatus').textContent = `ì™„ë£Œ: ${count}ê°œ Â· ${totalMin}ë¶„`;
            document.getElementById('requestCheckBtn').disabled = count === 0;
            document.getElementById('cancelCheckBtn').style.display = count > 0 ? 'inline-flex' : 'none';
        }

        function openCheckModal() {
            if (completedToday.length === 0) return;
            
            let html = '';
            let totalSec = 0;
            
            completedToday.forEach(c => {
                const range = c.bookType === 'lecture' 
                    ? `${c.startPage || '?'}ê°•~${c.endPage || '?'}ê°•`
                    : `p.${c.startPage || '?'}~${c.endPage || '?'}`;
                html += `<div class="check-item">
                    <div>
                        <span class="subject">${c.subject}</span>
                        <span style="color:#888;font-size:0.8rem;"> Â· ${c.book}</span>
                        <div style="font-size:0.75rem;color:#888;">${range}</div>
                    </div>
                    <span class="time">${formatTime(c.elapsed)}</span>
                </div>`;
                totalSec += c.elapsed;
            });
            
            const totalMin = Math.ceil(totalSec / 60);
            const h = Math.floor(totalMin / 60);
            const m = totalMin % 60;
            const totalStr = h > 0 ? `${h}ì‹œê°„ ${m}ë¶„` : `${m}ë¶„`;
            
            html += `<div class="check-total">ì´ ${totalStr}</div>`;
            
            document.getElementById('checkSummary').innerHTML = html;
            document.getElementById('checkModal').classList.add('active');
        }

        async function closeCheckModal(confirm) {
            document.getElementById('checkModal').classList.remove('active');
            
            if (!confirm || completedToday.length === 0) return;
            
            // ì¼ê´„ ê²€ì‚¬ ìš”ì²­
            for (const c of completedToday) {
                await api({
                    action: 'requestCheck',
                    floor: user.floor,
                    name: user.name,
                    date: c.dateStr,
                    subject: c.subject,
                    bookName: c.book,
                    actualTime: Math.ceil(c.elapsed / 60)
                });
            }
            
            completedToday = [];
            await loadPlans();
            renderTable();
            updateMood();
            updateCheckBar();
            toast('ğŸ”” ê²€ì‚¬ ìš”ì²­ ì™„ë£Œ!', 'success');
        }

        function cancelAllChecks() {
            if (completedToday.length === 0) return;
            
            if (confirm('ì™„ë£Œëœ í•™ìŠµ ê¸°ë¡ì„ ëª¨ë‘ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                // íƒ€ì´ë¨¸ ë¦¬ì…‹
                completedToday.forEach(c => {
                    timers[c.key] = { state: 'idle', elapsed: 0, start: null, interval: null };
                });
                completedToday = [];
                renderTable();
                updateCheckBar();
                toast('í•™ìŠµ ê¸°ë¡ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤');
            }
        }

        // ============ ë¹ ë¥¸ ì¶”ê°€ (ì¤‘ë³µ ë°©ì§€) ============
        async function quickAdd(subject, book, dateStr, bookType) {
            // ì¤‘ë³µ ì²´í¬
            const exists = plans.some(p => p.date === dateStr && p.subject === subject && p.book === book);
            if (exists) {
                toast('âš ï¸ ì´ë¯¸ ê³„íšì´ ìˆìŠµë‹ˆë‹¤', 'warning');
                return;
            }
            
            const res = await api({
                action: 'addPlan',
                floor: user.floor,
                name: user.name,
                date: dateStr,
                subject: subject,
                bookName: book,
                time: 60,
                bookType: bookType
            });
            
            if (res.success) {
                plans.push({ date: dateStr, subject, book, status: 'pending' });
                renderTable();
                toast('âœ… ê³„íš ì¶”ê°€ë¨', 'success');
            }
        }

        // í˜ì´ì§€ ì—…ë°ì´íŠ¸ëŠ” completeModalì—ì„œ ì²˜ë¦¬

        // ============ êµì¬ ê´€ë¦¬ (ê¸¸ê²Œ ëˆ„ë¥´ê¸°) ============
        function startLongPress(e, subject, name, type) {
            e.preventDefault();
            longPressTimer = setTimeout(() => {
                selectedBook = { subject, name, type };
                showContextMenu(e.clientX, e.clientY);
            }, 500);
        }
        
        function endLongPress() {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        }
        
        function showContextMenu(x, y) {
            const menu = document.getElementById('contextMenu');
            menu.style.left = Math.min(x, window.innerWidth - 160) + 'px';
            menu.style.top = Math.min(y, window.innerHeight - 120) + 'px';
            menu.classList.add('active');
        }
        
        function hideContextMenu() {
            document.getElementById('contextMenu').classList.remove('active');
        }
        
        function editBook() {
            hideContextMenu();
            if (!selectedBook) return;
            
            editMode = true;
            document.getElementById('bookModalTitle').textContent = 'âœï¸ êµì¬ ìˆ˜ì •';
            document.getElementById('bookSubject').value = selectedBook.subject;
            document.getElementById('bookSubject').disabled = true;
            document.getElementById('bookName').value = selectedBook.name;
            document.querySelector(`input[name="bookType"][value="${selectedBook.type}"]`).checked = true;
            
            document.getElementById('bookModal').classList.add('active');
        }
        
        async function deleteBook() {
            hideContextMenu();
            if (!selectedBook) return;
            
            if (!confirm(`"${selectedBook.name}" êµì¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            
            const res = await api({
                action: 'deleteBook',
                floor: user.floor,
                name: user.name,
                subject: selectedBook.subject,
                bookName: selectedBook.name
            });
            
            if (res.success) {
                books = books.filter(b => !(b.subject === selectedBook.subject && b.name === selectedBook.name));
                renderTable();
                toast('ğŸ—‘ï¸ ì‚­ì œë¨', 'success');
            } else {
                toast('ì‚­ì œ ì‹¤íŒ¨');
            }
            selectedBook = null;
        }

        function openBookModal(subject) {
            editMode = false;
            document.getElementById('bookModalTitle').textContent = 'ğŸ“š êµì¬/ì¸ê°• ì¶”ê°€';
            document.getElementById('bookSubject').value = subject || '';
            document.getElementById('bookSubject').disabled = false;
            document.getElementById('bookName').value = '';
            document.getElementById('typeTextbook').checked = true;
            document.getElementById('bookModal').classList.add('active');
        }

        function closeBookModal() {
            document.getElementById('bookModal').classList.remove('active');
            editMode = false;
            selectedBook = null;
        }

        async function saveBook() {
            const subject = document.getElementById('bookSubject').value;
            const name = document.getElementById('bookName').value.trim();
            const type = document.querySelector('input[name="bookType"]:checked').value;
            
            if (!subject || !name) return toast('ê³¼ëª©ê³¼ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”', 'warning');
            
            if (editMode && selectedBook) {
                // ìˆ˜ì •
                const res = await api({
                    action: 'updateBook',
                    floor: user.floor,
                    name: user.name,
                    subject: selectedBook.subject,
                    oldBookName: selectedBook.name,
                    newBookName: name,
                    bookType: type
                });
                
                if (res.success) {
                    const idx = books.findIndex(b => b.subject === selectedBook.subject && b.name === selectedBook.name);
                    if (idx >= 0) {
                        books[idx].name = name;
                        books[idx].type = type;
                    }
                    closeBookModal();
                    renderTable();
                    toast('âœï¸ ìˆ˜ì •ë¨', 'success');
                }
            } else {
                // ì¶”ê°€
                const res = await api({
                    action: 'addBook',
                    floor: user.floor,
                    name: user.name,
                    subject,
                    bookName: name,
                    bookType: type
                });
                
                if (res.success) {
                    books.push({ subject, name, type });
                    closeBookModal();
                    renderTable();
                    toast(type === 'lecture' ? 'ğŸ¬ ì¸ê°• ì¶”ê°€ë¨' : 'ğŸ“š êµì¬ ì¶”ê°€ë¨', 'success');
                }
            }
        }

        // ============ ê¸°íƒ€ ============
        async function updateMood() {
            const res = await api({
                action: 'getRecords',
                floor: user.floor,
                name: user.name,
                date: fmt(new Date())
            });
            
            if (res.success) {
                const records = res.records || [];
                const totalTime = records
                    .filter(r => ['approved', 'O', 'requested'].includes(r.status))
                    .reduce((sum, r) => sum + (r.actualTime || 0), 0);
                
                let emoji = 'ğŸ˜´';
                if (totalTime >= 480) emoji = 'ğŸ”¥';
                else if (totalTime >= 240) emoji = 'ğŸ˜Š';
                else if (totalTime >= 60) emoji = 'ğŸ™‚';
                else if (totalTime > 0) emoji = 'ğŸ’ª';
                
                document.getElementById('mood').textContent = emoji;
            }
        }

        function toggleStats() {
            const panel = document.getElementById('statsPanel');
            panel.classList.toggle('active');
            if (panel.classList.contains('active')) loadStats();
        }

        async function loadStats() {
            const res = await api({
                action: 'getStats',
                floor: user.floor,
                name: user.name
            });
            
            if (res.success) {
                const s = res.stats;
                document.getElementById('statTotal').textContent = s.totalPlans || 0;
                document.getElementById('statDone').textContent = s.completed || 0;
                document.getElementById('statTime').textContent = (s.totalTimeHours || 0) + 'h';
                document.getElementById('statRate').textContent = (s.rate || 0) + '%';
            }
        }

        async function captureShare() {
            try {
                toast('ğŸ“¸ ìº¡ì²˜ ì¤‘...');
                
                const captureArea = document.getElementById('captureArea');
                const captureHeader = document.getElementById('captureHeader');
                const wrapper = document.querySelector('.table-wrapper');
                
                const dates = getWeekDates();
                const m = dates[0].getMonth() + 1;
                const w = Math.ceil(dates[0].getDate() / 7);
                document.getElementById('captureInfo').textContent = 
                    `${user.name} Â· ${user.floor} Â· ${m}ì›” ${w}ì£¼ì°¨ (${fmtKR(dates[0])}~${fmtKR(dates[6])})`;
                
                captureHeader.classList.add('visible');
                captureArea.classList.add('capture-mode');
                
                const originalOverflow = wrapper.style.overflow;
                const originalHeight = wrapper.style.height;
                
                wrapper.style.overflow = 'visible';
                wrapper.style.height = 'auto';
                
                await new Promise(r => setTimeout(r, 150));
                
                const canvas = await html2canvas(captureArea, {
                    backgroundColor: '#ffffff',
                    scale: 2,
                    useCORS: true,
                    logging: false
                });
                
                captureHeader.classList.remove('visible');
                captureArea.classList.remove('capture-mode');
                wrapper.style.overflow = originalOverflow;
                wrapper.style.height = originalHeight;
                
                canvas.toBlob(async (blob) => {
                    try {
                        await navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]);
                        toast('ğŸ“‹ ë³µì‚¬ë¨! ì¹´í†¡ì— ë¶™ì—¬ë„£ê¸°', 'success');
                    } catch {
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `${user.name}_ê³„íší‘œ.png`;
                        a.click();
                        toast('ğŸ“¥ ì €ì¥ë¨', 'success');
                    }
                }, 'image/png');
            } catch (e) {
                console.error(e);
                toast('ìº¡ì²˜ ì‹¤íŒ¨');
            }
        }

        function toast(msg, type = '') {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = 'toast' + (type ? ` ${type}` : '');
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2500);
        }
    </script>
</body>
</html>
