<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ê¹€ì—„ë§ˆë…ì„œì‹¤ | ì¼ì¼í”Œë˜ë„ˆ</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary: #1e3a5f;
            --primary-light: #2d5a8b;
            --primary-dark: #0f1f33;
            --accent: #3b82f6;
            --accent-light: #60a5fa;
            --bg-gradient: linear-gradient(135deg, #1e3a5f, #0f1f33);
            --card-bg: #f0f9ff;
            --header-text: white;
        }

        [data-theme="cherry"] {
            --primary: #db2777;
            --primary-light: #ec4899;
            --primary-dark: #9d174d;
            --accent: #f472b6;
            --accent-light: #fbcfe8;
            --bg-gradient: linear-gradient(135deg, #db2777, #9d174d);
            --card-bg: #fdf2f8;
        }

        [data-theme="mint"] {
            --primary: #059669;
            --primary-light: #10b981;
            --primary-dark: #064e3b;
            --accent: #34d399;
            --accent-light: #a7f3d0;
            --bg-gradient: linear-gradient(135deg, #059669, #064e3b);
            --card-bg: #ecfdf5;
        }

        [data-theme="dark"] {
            --primary: #1f1f1f;
            --primary-light: #374151;
            --primary-dark: #0a0a0a;
            --accent: #8b5cf6;
            --accent-light: #c4b5fd;
            --bg-gradient: linear-gradient(135deg, #1f1f1f, #0a0a0a);
            --card-bg: #27272a;
            --header-text: #e4e4e7;
        }

        [data-theme="violet"] {
            --primary: #7c3aed;
            --primary-light: #8b5cf6;
            --primary-dark: #5b21b6;
            --accent: #a78bfa;
            --accent-light: #ddd6fe;
            --bg-gradient: linear-gradient(135deg, #7c3aed, #5b21b6);
            --card-bg: #f5f3ff;
        }

        [data-theme="sunset"] {
            --primary: #ea580c;
            --primary-light: #f97316;
            --primary-dark: #c2410c;
            --accent: #fb923c;
            --accent-light: #fed7aa;
            --bg-gradient: linear-gradient(135deg, #ea580c, #dc2626);
            --card-bg: #fff7ed;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { 
            height: 100%; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f0f0f0;
            overflow: hidden;
        }

        .login-screen {
            position: fixed;
            inset: 0;
            background: var(--bg-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .login-screen.hidden { display: none; }
        .login-box {
            background: white;
            border-radius: 24px;
            padding: 2rem;
            width: 90%;
            max-width: 340px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .login-box h1 { color: var(--primary); margin-bottom: 0.5rem; font-size: 1.5rem; }
        .login-box .subtitle { color: #888; font-size: 0.85rem; margin-bottom: 1.5rem; }
        .login-box select {
            width: 100%;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 2px solid #e5e5e5;
            border-radius: 12px;
            font-size: 1rem;
            background: #fafafa;
        }
        .login-box select:focus { outline: none; border-color: var(--accent); }
        .login-box button {
            width: 100%;
            padding: 1rem;
            background: var(--bg-gradient);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
        }

        .container { display: none; flex-direction: column; height: 100vh; height: 100dvh; }
        .container.active { display: flex; }

        .header {
            background: var(--bg-gradient);
            color: var(--header-text, white);
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-left { display: flex; align-items: center; gap: 10px; }
        .mood { font-size: 1.6rem; }
        .name { font-weight: 600; font-size: 1.1rem; }
        .header-right { display: flex; gap: 8px; }
        .header-btn {
            width: 38px; height: 38px;
            background: rgba(255,255,255,0.15);
            border: none;
            border-radius: 10px;
            color: var(--header-text, white);
            font-size: 1rem;
            cursor: pointer;
        }

        .week-bar {
            background: white;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e5e5e5;
        }
        .week-nav {
            width: 32px; height: 32px;
            background: #f5f5f5;
            border: none;
            border-radius: 50%;
            cursor: pointer;
        }
        .week-info { text-align: center; }
        .week-title { font-weight: 700; color: var(--primary); font-size: 1.1rem; }
        .week-range { font-size: 0.75rem; color: #999; margin-top: 2px; }

        .table-wrapper { flex: 1; overflow: auto; padding: 10px; padding-bottom: 140px; }
        .plan-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            min-width: 750px;
        }
        .plan-table th {
            background: var(--primary);
            color: white;
            padding: 12px 6px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .plan-table th.subject-col { width: 55px; }
        .plan-table th.add-col { width: 42px; }
        .plan-table th.book-col { width: 85px; }
        .plan-table td {
            border: 1px solid #e5e5e5;
            padding: 4px;
            vertical-align: top;
            height: 85px;
        }
        .subject-cell {
            background: linear-gradient(135deg, #f8f8f8, #f0f0f0);
            text-align: center;
            font-weight: 700;
            font-size: 0.9rem;
            color: var(--primary);
            vertical-align: middle !important;
        }
        .add-cell {
            background: #f8f8f8;
            text-align: center;
            vertical-align: middle !important;
        }
        .book-cell {
            background: var(--card-bg);
            font-size: 0.65rem;
            vertical-align: middle !important;
            text-align: center;
            font-weight: 600;
            color: #555;
            padding: 6px 4px;
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
        }
        .book-cell .book-type {
            font-size: 0.55rem;
            padding: 2px 5px;
            border-radius: 4px;
            display: inline-block;
            margin-bottom: 3px;
            font-weight: 700;
        }
        .book-cell .book-type.lecture { background: linear-gradient(135deg, #dbeafe, #bfdbfe); color: #1e40af; }
        .book-cell .book-type.textbook { background: linear-gradient(135deg, #dcfce7, #bbf7d0); color: #166534; }
        .book-cell .book-name { word-break: keep-all; line-height: 1.3; }
        .add-btn {
            width: 32px; height: 32px;
            background: linear-gradient(135deg, #e0f2fe, #bae6fd);
            border: 2px dashed var(--accent);
            border-radius: 8px;
            color: var(--accent);
            font-size: 1.1rem;
            cursor: pointer;
        }

        .day-header { text-align: center; }
        .day-name { font-size: 0.7rem; opacity: 0.9; }
        .day-num { font-size: 1.05rem; font-weight: 700; }
        .today { background: var(--accent) !important; }
        .sat .day-num { color: #93c5fd; }
        .sun .day-num { color: #fca5a5; }

        .day-cell { position: relative; padding: 4px !important; }

        .cell-add {
            width: 100%;
            height: 100%;
            min-height: 75px;
            background: transparent;
            border: 2px dashed #d5d5d5;
            border-radius: 8px;
            color: #bbb;
            font-size: 1.6rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .cell-add:hover { border-color: var(--accent); color: var(--accent); background: var(--card-bg); }

        .plan-card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #e5e5e5;
        }
        .plan-card.completed { border-color: #86efac; background: linear-gradient(135deg, #f0fdf4, #dcfce7); }
        .plan-card.pending { border-color: #fcd34d; background: linear-gradient(135deg, #fefce8, #fef9c3); }
        .plan-card.failed { border-color: #fca5a5; background: linear-gradient(135deg, #fef2f2, #fee2e2); }
        .plan-card.missed { border-color: #fdba74; background: linear-gradient(135deg, #fff7ed, #ffedd5); } /* ë‚ ì§œ ì§€ë‚¨ ë¯¸ì™„ë£Œ - ì£¼í™©ìƒ‰ */
        .plan-card.paused { border-color: #c4b5fd; background: linear-gradient(135deg, #f5f3ff, #ede9fe); }
        .plan-card.running { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3); }
        .plan-card.done-local { border-color: #86efac; background: linear-gradient(135deg, #f0fdf4, #dcfce7); }

        .card-top {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 5px 6px;
            background: rgba(0,0,0,0.02);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        
        .timer-btn {
            width: 24px; height: 24px;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 0.5rem;
            cursor: pointer;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .play-btn { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .play-btn:disabled { background: #d1d5db; cursor: not-allowed; box-shadow: none; }
        .pause-btn { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .pause-btn:disabled { background: #d1d5db; cursor: not-allowed; box-shadow: none; }
        .stop-btn { background: linear-gradient(135deg, #10b981, #059669); }
        .stop-btn:disabled { background: #d1d5db; cursor: not-allowed; box-shadow: none; }
        
        .play-btn.active { background: linear-gradient(135deg, #10b981, #059669); animation: pulse 1.5s infinite; }
        .pause-btn.active { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .card-timer {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--primary);
            font-family: 'SF Mono', Monaco, monospace;
            margin-left: 2px;
        }
        .card-timer.done { color: #10b981; }
        .card-status { margin-left: auto; font-size: 0.85rem; }

        .card-bottom { padding: 4px 5px; }
        .card-inputs {
            display: flex;
            align-items: center;
            gap: 2px;
            flex-wrap: wrap;
        }
        .card-input {
            width: 32px;
            padding: 3px 2px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.65rem;
            background: white;
        }
        .card-input:focus { outline: none; border-color: var(--accent); }
        .card-input.time-input { width: 28px; background: #fef3c7; }
        .input-label { font-size: 0.55rem; color: #888; }
        .input-sep { font-size: 0.6rem; color: #999; }

        .check-bar {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: white;
            padding: 12px 15px;
            border-top: 1px solid #e5e5e5;
            display: flex;
            gap: 10px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
            z-index: 50;
        }
        .check-bar-info { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .check-bar-title { font-weight: 700; color: var(--primary); font-size: 0.9rem; }
        .check-bar-status { font-size: 0.75rem; color: #888; margin-top: 2px; }
        .check-bar-btns { display: flex; gap: 8px; }
        .check-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
        }
        .check-btn.request { background: linear-gradient(135deg, var(--accent), var(--primary)); color: white; }
        .check-btn.request:disabled { background: #d1d5db; cursor: not-allowed; }
        .check-btn.cancel { background: #f5f5f5; color: #666; }
        .check-btn i { margin-right: 5px; }

        .stats-panel {
            display: none;
            position: fixed;
            bottom: 70px; left: 10px; right: 10px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 -4px 30px rgba(0,0,0,0.15);
            padding: 20px;
            z-index: 100;
        }
        .stats-panel.active { display: block; }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .stat-item { text-align: center; padding: 12px; background: linear-gradient(135deg, #f8f8f8, #f0f0f0); border-radius: 12px; }
        .stat-value { font-size: 1.5rem; font-weight: 700; color: var(--primary); }
        .stat-label { font-size: 0.65rem; color: #999; margin-top: 2px; }
        .close-stats { position: absolute; top: 12px; right: 12px; background: none; border: none; font-size: 1.3rem; color: #999; cursor: pointer; }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 500;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }
        .modal.active { display: flex; }
        .modal-box {
            background: white;
            border-radius: 20px;
            padding: 1.5rem;
            width: 90%;
            max-width: 340px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-box h3 { margin-bottom: 1rem; color: var(--primary); font-size: 1.2rem; }
        .modal-box select, .modal-box input[type="text"] {
            width: 100%;
            padding: 12px;
            margin-bottom: 12px;
            border: 2px solid #e5e5e5;
            border-radius: 12px;
            font-size: 1rem;
            background: #fafafa;
        }
        .modal-box select:focus, .modal-box input:focus { outline: none; border-color: var(--accent); }
        
        .type-selector { display: flex; gap: 10px; margin-bottom: 15px; }
        .type-option { flex: 1; position: relative; }
        .type-option input { position: absolute; opacity: 0; }
        .type-option label {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            border: 2px solid #e5e5e5;
            border-radius: 12px;
            cursor: pointer;
        }
        .type-option label i { font-size: 1.8rem; margin-bottom: 6px; color: #888; }
        .type-option label span { font-weight: 600; color: #666; }
        .type-option input:checked + label { border-color: var(--accent); background: var(--card-bg); }
        .type-option input:checked + label i { color: var(--accent); }
        .type-option input:checked + label span { color: var(--primary); }
        
        .modal-btns { display: flex; gap: 10px; margin-top: 5px; }
        .modal-btns button {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }
        .modal-btns .cancel { background: #f0f0f0; color: #666; }
        .modal-btns .confirm { background: var(--accent); color: white; }

        .theme-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px; }
        .theme-option {
            padding: 15px;
            border: 3px solid #e5e5e5;
            border-radius: 14px;
            cursor: pointer;
            text-align: center;
        }
        .theme-option.active { border-color: var(--primary); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .theme-option .theme-preview { width: 100%; height: 40px; border-radius: 8px; margin-bottom: 8px; }
        .theme-option .theme-name { font-weight: 600; font-size: 0.85rem; }

        .context-menu {
            display: none;
            position: fixed;
            background: white;
            border-radius: 14px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.25);
            overflow: hidden;
            z-index: 600;
            min-width: 150px;
        }
        .context-menu.active { display: block; }
        .context-menu-item {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
        }
        .context-menu-item:first-child { border-bottom: 1px solid #f0f0f0; }
        .context-menu-item:active { background: #e8e8e8; }
        .context-menu-item.danger { color: #ef4444; }
        .context-menu-item i { width: 20px; text-align: center; font-size: 1rem; }

        .check-modal .check-summary {
            background: linear-gradient(135deg, #f8f8f8, #f0f0f0);
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
            max-height: 200px;
            overflow-y: auto;
        }
        .check-modal .check-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e5e5e5;
        }
        .check-modal .check-item:last-child { border-bottom: none; }
        .check-modal .check-item.warning { background: #fef3c7; margin: 0 -10px; padding: 8px 10px; border-radius: 6px; }
        .check-modal .check-item .subject { font-weight: 600; color: var(--primary); }
        .check-modal .check-item .time { font-family: monospace; color: var(--accent); font-weight: 600; }
        .check-modal .check-total { text-align: center; padding-top: 10px; font-size: 1.3rem; font-weight: 700; color: var(--primary); }

        .photo-section { margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e5e5; }
        .photo-label { font-size: 0.85rem; font-weight: 600; color: var(--primary); margin-bottom: 10px; }
        .photo-preview {
            width: 100%;
            height: 150px;
            border: 2px dashed #ddd;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            overflow: hidden;
            background: #fafafa;
        }
        .photo-preview img { width: 100%; height: 100%; object-fit: cover; }
        .photo-preview i { font-size: 2rem; color: #bbb; margin-bottom: 8px; }
        .photo-preview span { font-size: 0.8rem; color: #888; }
        .photo-preview.has-photo { border-style: solid; border-color: var(--accent); }
        #photoInput { display: none; }

        .toast {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            opacity: 0;
            transition: all 0.3s;
            z-index: 700;
            font-weight: 500;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .toast.success { background: linear-gradient(135deg, #10b981, #059669); }
        .toast.warning { background: linear-gradient(135deg, #f59e0b, #d97706); }

        .capture-header {
            display: none;
            background: var(--bg-gradient);
            color: white;
            padding: 18px 20px;
            text-align: center;
            border-radius: 12px 12px 0 0;
        }
        .capture-header.visible { display: block; }
        .capture-title { font-size: 1.3rem; font-weight: 700; margin-bottom: 4px; }
        .capture-info { font-size: 0.9rem; opacity: 0.9; }
        .capture-mode .plan-table { border-radius: 0 0 12px 12px; }

        [data-theme="dark"] .login-box,
        [data-theme="dark"] .modal-box,
        [data-theme="dark"] .stats-panel,
        [data-theme="dark"] .context-menu { background: #27272a; color: #e4e4e7; }
        [data-theme="dark"] .plan-table { background: #1f1f1f; }
        [data-theme="dark"] .plan-table td { border-color: #3f3f46; }
        [data-theme="dark"] .subject-cell { background: linear-gradient(135deg, #27272a, #1f1f1f); color: #e4e4e7; }
        [data-theme="dark"] .week-bar, [data-theme="dark"] .check-bar { background: #27272a; border-color: #3f3f46; }

        /* ========== ì—°ì† í•™ìŠµì¼ & ëˆ„ì  ì‹œê°„ ë°” ========== */
        .streak-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            padding: 10px 15px;
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border-bottom: 1px solid #fcd34d;
        }
        .streak-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .streak-icon {
            font-size: 1.2rem;
        }
        .streak-value {
            font-size: 1.4rem;
            font-weight: 800;
            color: #92400e;
        }
        .streak-label {
            font-size: 0.8rem;
            color: #a16207;
            font-weight: 600;
        }
        .streak-divider {
            width: 1px;
            height: 24px;
            background: #fcd34d;
        }
        [data-theme="dark"] .streak-bar { background: linear-gradient(135deg, #78350f, #92400e); border-color: #a16207; }
        [data-theme="dark"] .streak-value { color: #fef3c7; }
        [data-theme="dark"] .streak-label { color: #fde68a; }
        [data-theme="dark"] .week-title { color: #e4e4e7; }
        [data-theme="dark"] .plan-card { background: #3f3f46; border-color: #52525b; }
        [data-theme="dark"] .card-timer { color: #e4e4e7; }
        [data-theme="dark"] .card-input { background: #27272a; color: #e4e4e7; border-color: #52525b; }

        /* ========== í•˜ë‹¨ íƒ­ ë„¤ë¹„ê²Œì´ì…˜ ========== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            border-top: 1px solid #e0e0e0;
            padding: 8px 0;
            padding-bottom: max(8px, env(safe-area-inset-bottom));
            z-index: 90;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 4px;
            border: none;
            background: none;
            cursor: pointer;
            color: #888;
            font-size: 0.7rem;
            transition: all 0.2s;
        }
        .nav-item i { font-size: 1.2rem; }
        .nav-item.active { color: var(--primary); }
        .nav-item .nav-badge {
            position: absolute;
            top: 2px;
            right: calc(50% - 20px);
            background: #ef4444;
            color: white;
            font-size: 0.6rem;
            padding: 1px 5px;
            border-radius: 8px;
        }
        [data-theme="dark"] .bottom-nav { background: #1f1f1f; border-color: #3f3f46; }
        [data-theme="dark"] .nav-item { color: #888; }
        [data-theme="dark"] .nav-item.active { color: var(--accent); }

        /* ========== ì „ì²´í™”ë©´ ëª¨ë‹¬ (ë­í‚¹, í†µê³„, ì‹¤ì‹œê°„) ========== */
        .fullscreen-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #f5f5f5;
            z-index: 200;
            display: none;
            flex-direction: column;
        }
        .fullscreen-modal.show { display: flex; }
        .fm-header {
            background: var(--bg-gradient);
            color: white;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .fm-header h2 { font-size: 1.1rem; display: flex; align-items: center; gap: 8px; }
        .fm-close {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 1rem;
            cursor: pointer;
        }
        .fm-body {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            padding-bottom: 100px;
        }
        [data-theme="dark"] .fullscreen-modal { background: #0a0a0a; }

        /* ë­í‚¹ ë¦¬ìŠ¤íŠ¸ */
        .ranking-card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .ranking-card-title {
            padding: 12px 16px;
            font-weight: 700;
            color: var(--primary);
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .ranking-list { list-style: none; }
        .ranking-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #f8f8f8;
        }
        .ranking-item:last-child { border-bottom: none; }
        .rank-badge {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.85rem;
            margin-right: 12px;
        }
        .rank-1 { background: linear-gradient(135deg, #fef3c7, #fde047); color: #92400e; }
        .rank-2 { background: linear-gradient(135deg, #e5e7eb, #d1d5db); color: #4b5563; }
        .rank-3 { background: linear-gradient(135deg, #fed7aa, #fdba74); color: #c2410c; }
        .rank-other { background: #f3f4f6; color: #6b7280; }
        .rank-info { flex: 1; }
        .rank-name { font-weight: 600; color: #333; }
        .rank-name.me { color: var(--primary); }
        .rank-floor { font-size: 0.75rem; color: #888; }
        .rank-value { font-weight: 700; color: var(--primary); }
        .rank-value small { font-size: 0.75rem; font-weight: 400; color: #888; }
        [data-theme="dark"] .ranking-card { background: #27272a; }
        [data-theme="dark"] .rank-name { color: #e4e4e7; }

        /* ë‚´ í†µê³„ ê·¸ë˜í”„ */
        .my-stats-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .my-stats-title {
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .stats-summary-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        .summary-box {
            text-align: center;
            padding: 16px;
            background: var(--card-bg);
            border-radius: 12px;
        }
        .summary-box .value { font-size: 1.8rem; font-weight: 800; color: var(--primary); }
        .summary-box .label { font-size: 0.75rem; color: #888; margin-top: 4px; }
        .subject-bar {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }
        .subject-bar-name {
            width: 50px;
            font-size: 0.8rem;
            font-weight: 600;
            color: #555;
        }
        .subject-bar-track {
            flex: 1;
            height: 24px;
            background: #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
            margin: 0 10px;
        }
        .subject-bar-fill {
            height: 100%;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
            color: white;
            font-size: 0.7rem;
            font-weight: 600;
            min-width: 30px;
        }
        .subject-bar-time {
            width: 50px;
            text-align: right;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--primary);
        }
        [data-theme="dark"] .my-stats-card { background: #27272a; }
        [data-theme="dark"] .summary-box { background: #3f3f46; }

        /* ì‹¤ì‹œê°„ í˜„í™© */
        .live-card {
            background: white;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .live-status {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #d1d5db;
        }
        .live-status.studying {
            background: #10b981;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .live-info { flex: 1; }
        .live-name { font-weight: 600; color: #333; }
        .live-detail { font-size: 0.8rem; color: #888; margin-top: 2px; }
        .live-time {
            font-weight: 700;
            color: var(--primary);
            font-family: monospace;
            font-size: 1rem;
        }
        .live-time.active { color: #10b981; }
        .live-count {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            border-radius: 16px;
            margin-bottom: 16px;
        }
        .live-count .number { font-size: 3rem; font-weight: 800; }
        .live-count .label { font-size: 0.9rem; opacity: 0.9; }
        [data-theme="dark"] .live-card { background: #27272a; }
        [data-theme="dark"] .live-name { color: #e4e4e7; }
        /* ========== ì»¨ë””ì…˜(ì—„ë§ˆì†ì¼€ì–´) ìŠ¤íƒ€ì¼ ========== */
.care-card {
    background: white;
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 16px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
}
.care-title {
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
}
.care-row {
    margin-bottom: 16px;
}
.care-row label {
    display: block;
    font-size: 0.85rem;
    font-weight: 600;
    color: #555;
    margin-bottom: 8px;
}
.care-input-row {
    display: flex;
    align-items: center;
    gap: 8px;
}
.care-input-row input[type="number"] {
    width: 80px;
    padding: 10px;
    border: 2px solid #e5e5e5;
    border-radius: 10px;
    font-size: 1rem;
    text-align: center;
}
.care-slider-wrap {
    display: flex;
    align-items: center;
    gap: 12px;
}
.care-slider-wrap input[type="range"] {
    flex: 1;
    height: 8px;
    -webkit-appearance: none;
    background: linear-gradient(90deg, #ef4444, #f59e0b, #22c55e);
    border-radius: 4px;
}
.care-slider-wrap input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 24px;
    height: 24px;
    background: white;
    border: 3px solid var(--accent);
    border-radius: 50%;
    cursor: pointer;
}
.care-slider-wrap span {
    font-size: 1.3rem;
    font-weight: 800;
    color: var(--accent);
    min-width: 30px;
}
.emoji-rating {
    display: flex;
    gap: 8px;
}
.emoji-btn {
    flex: 1;
    padding: 12px 8px;
    background: #f5f5f5;
    border: 2px solid transparent;
    border-radius: 12px;
    font-size: 1.3rem;
    cursor: pointer;
    text-align: center;
}
.emoji-btn.selected {
    background: white;
    border-color: var(--accent);
    box-shadow: 0 2px 8px rgba(59,130,246,0.2);
}
.emoji-btn small {
    display: block;
    font-size: 0.65rem;
    color: #888;
    margin-top: 4px;
}
.symptom-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}
.symptom-tag {
    padding: 10px 14px;
    background: #f5f5f5;
    border: 2px solid transparent;
    border-radius: 20px;
    font-size: 0.85rem;
    cursor: pointer;
}
.symptom-tag.selected {
    background: #dcfce7;
    border-color: #10b981;
    color: #059669;
}
.care-submit-btn {
    width: 100%;
    padding: 16px;
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    margin-top: 10px;
}
.care-result-card {
    margin-top: 20px;
    padding: 20px;
    background: linear-gradient(135deg, #f0fdf4, #dcfce7);
    border-radius: 16px;
    text-align: center;
}
.care-result-card.warning { background: linear-gradient(135deg, #fefce8, #fef3c7); }
.care-result-card.danger { background: linear-gradient(135deg, #fef2f2, #fee2e2); }
.care-result-title {
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 12px;
}
.care-score {
    font-size: 3rem;
    font-weight: 800;
    color: #10b981;
}
.care-result-card.warning .care-score { color: #f59e0b; }
.care-result-card.danger .care-score { color: #ef4444; }
.care-message {
    font-size: 1rem;
    color: #555;
    margin: 10px 0;
}
.care-tips {
    text-align: left;
    margin-top: 16px;
}
.care-tip {
    padding: 12px;
    background: white;
    border-radius: 10px;
    margin-bottom: 8px;
    font-size: 0.85rem;
    color: #555;
}
.care-select {
    width: 100%;
    padding: 12px;
    margin-bottom: 12px;
    border: 2px solid #e5e5e5;
    border-radius: 12px;
    font-size: 1rem;
    background: #fafafa;
}
[data-theme="dark"] .care-card { background: #27272a; }
[data-theme="dark"] .care-row label { color: #a1a1aa; }
[data-theme="dark"] .emoji-btn { background: #3f3f46; }
[data-theme="dark"] .symptom-tag { background: #3f3f46; color: #e4e4e7; }

/* ========== ë”ë³´ê¸° ë©”ë‰´ ìŠ¤íƒ€ì¼ ========== */
.more-menu {
    background: white;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
}
.more-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 18px 20px;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
}
.more-item:last-child { border-bottom: none; }
.more-item:active { background: #f8f8f8; }
.more-icon {
    width: 46px;
    height: 46px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.3rem;
    color: white;
}
.more-icon.purple { background: linear-gradient(135deg, #8b5cf6, #a78bfa); }
.more-icon.cyan { background: linear-gradient(135deg, #0891b2, #06b6d4); }
.more-icon.blue { background: linear-gradient(135deg, #3b82f6, #60a5fa); }
.more-icon.orange { background: linear-gradient(135deg, #f59e0b, #fbbf24); }
.more-icon.pink { background: linear-gradient(135deg, #ec4899, #f472b6); }
.more-info { flex: 1; }
.more-title { font-weight: 600; color: #333; font-size: 1rem; }
.more-desc { font-size: 0.8rem; color: #888; margin-top: 3px; }
.more-arrow { color: #ccc; }
[data-theme="dark"] .more-menu { background: #27272a; }
[data-theme="dark"] .more-title { color: #e4e4e7; }
[data-theme="dark"] .more-item:active { background: #3f3f46; }

/* ========== í•™ìŠµì„±í–¥/ë¡œë“œë§µ/ì„±ì·¨ë„ ìŠ¤íƒ€ì¼ ========== */
.style-intro, .roadmap-intro {
    text-align: center;
    padding: 40px 20px;
}
.style-icon {
    font-size: 4rem;
    margin-bottom: 16px;
}
.style-intro h3, .roadmap-intro h3 {
    font-size: 1.3rem;
    color: var(--primary);
    margin-bottom: 10px;
}
.style-intro p, .roadmap-intro p {
    color: #666;
    font-size: 0.95rem;
    margin-bottom: 24px;
    line-height: 1.5;
}
.style-start-btn {
    padding: 16px 40px;
    background: linear-gradient(135deg, #8b5cf6, #a78bfa);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
}
.style-result-card {
    background: white;
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 16px;
    text-align: center;
}
.style-code-badge {
    width: 80px;
    height: 80px;
    background: linear-gradient(135deg, #8b5cf6, #a78bfa);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 16px;
    color: white;
    font-size: 1.5rem;
    font-weight: 800;
}
.style-name {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--primary);
}
.style-desc {
    font-size: 0.9rem;
    color: #666;
    margin-top: 8px;
}
.achieve-grade-badge {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    margin: 0 auto 20px;
    color: white;
}
.achieve-grade-badge.S { background: linear-gradient(135deg, #10b981, #22c55e); }
.achieve-grade-badge.A { background: linear-gradient(135deg, #3b82f6, #60a5fa); }
.achieve-grade-badge.B { background: linear-gradient(135deg, #f59e0b, #fbbf24); }
.achieve-grade-badge.C { background: linear-gradient(135deg, #6b7280, #9ca3af); }
.achieve-grade-badge.D { background: linear-gradient(135deg, #ef4444, #f87171); }
.achieve-grade-letter {
    font-size: 2.5rem;
    font-weight: 800;
    line-height: 1;
}
.achieve-grade-score {
    font-size: 0.8rem;
    opacity: 0.9;
}
[data-theme="dark"] .style-result-card { background: #27272a; }
        // ========== ë„¤ë¹„ê²Œì´ì…˜ ìˆ˜ì • ==========
function switchNav(tab) {
    document.querySelectorAll('.nav-item').forEach((item, idx) => {
        item.classList.toggle('active', 
            (tab === 'planner' && idx === 0) ||
            (tab === 'care' && idx === 1) ||
            (tab === 'ranking' && idx === 2) ||
            (tab === 'more' && idx === 3)
        );
    });
    
    if (tab === 'planner') {
        closeModal('careModal');
        closeModal('rankingModal');
        closeModal('moreModal');
        closeModal('mystatsModal');
        closeModal('liveModal');
    } else if (tab === 'care') {
        openModal('careModal');
        loadSavedCondition();
    } else if (tab === 'ranking') {
        openModal('rankingModal');
        loadRanking();
    } else if (tab === 'more') {
        openModal('moreModal');
    }
}

// ========== ì»¨ë””ì…˜(ì—„ë§ˆì†ì¼€ì–´) ==========
let conditionData = {
    sleepHours: 7,
    sleepQuality: 3,
    condition: 5,
    stress: 1,
    symptoms: ['none'],
    breakfast: 2
};

function setupCareListeners() {
    // ì»¨ë””ì…˜ ìŠ¬ë¼ì´ë”
    const slider = document.getElementById('conditionSlider');
    if (slider) {
        slider.addEventListener('input', function() {
            document.getElementById('conditionValue').textContent = this.value;
            conditionData.condition = parseInt(this.value);
        });
    }
    
    // ì´ëª¨ì§€ ë²„íŠ¼ë“¤
    ['sleepQuality', 'stressLevel', 'breakfast'].forEach(groupId => {
        document.querySelectorAll(`#${groupId} .emoji-btn`).forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll(`#${groupId} .emoji-btn`).forEach(b => b.classList.remove('selected'));
                this.classList.add('selected');
                const value = parseInt(this.dataset.value);
                if (groupId === 'sleepQuality') conditionData.sleepQuality = value;
                else if (groupId === 'stressLevel') conditionData.stress = value;
                else if (groupId === 'breakfast') conditionData.breakfast = value;
            });
        });
    });
    
    // ì¦ìƒ íƒœê·¸
    document.querySelectorAll('#symptoms .symptom-tag').forEach(tag => {
        tag.addEventListener('click', function() {
            const symptom = this.dataset.symptom;
            if (symptom === 'none') {
                document.querySelectorAll('#symptoms .symptom-tag').forEach(t => t.classList.remove('selected'));
                this.classList.add('selected');
                conditionData.symptoms = ['none'];
            } else {
                document.querySelector('#symptoms .symptom-tag[data-symptom="none"]').classList.remove('selected');
                this.classList.toggle('selected');
                conditionData.symptoms = Array.from(document.querySelectorAll('#symptoms .symptom-tag.selected'))
                    .map(t => t.dataset.symptom).filter(s => s !== 'none');
                if (conditionData.symptoms.length === 0) {
                    document.querySelector('#symptoms .symptom-tag[data-symptom="none"]').classList.add('selected');
                    conditionData.symptoms = ['none'];
                }
            }
        });
    });
}

function loadSavedCondition() {
    if (!user) return;
    const saved = localStorage.getItem(`condition_${user.name}_${fmt(new Date())}`);
    if (saved) {
        const data = JSON.parse(saved);
        displayCareResult(data);
    }
}

function submitCondition() {
    conditionData.sleepHours = parseInt(document.getElementById('sleepHours').value) || 0;
    
    let score = 50;
    if (conditionData.sleepHours >= 7) score += 25;
    else if (conditionData.sleepHours >= 6) score += 20;
    else if (conditionData.sleepHours >= 5) score += 10;
    else score -= 5;
    
    score += (conditionData.condition - 5) * 4;
    score -= (conditionData.stress - 1) * 3;
    score -= conditionData.symptoms.filter(s => s !== 'none').length * 5;
    score += conditionData.breakfast * 2;
    score = Math.max(0, Math.min(100, Math.round(score)));
    
    const result = { date: fmt(new Date()), ...conditionData, score };
    localStorage.setItem(`condition_${user.name}_${fmt(new Date())}`, JSON.stringify(result));
    displayCareResult(result);
    toast('ì»¨ë””ì…˜ ì²´í¬ ì™„ë£Œ!', 'success');
}

function displayCareResult(data) {
    let status, message, tips = [];
    
    if (data.score >= 80) {
        status = ''; message = 'ì»¨ë””ì…˜ ìµœê³ ! ğŸ’ª';
        tips = ['ğŸ”¥ ì–´ë ¤ìš´ ê³¼ëª©ì— ë„ì „í•˜ì„¸ìš”!', 'â° 90ë¶„ ì§‘ì¤‘ + 10ë¶„ íœ´ì‹ ì¶”ì²œ'];
    } else if (data.score >= 60) {
        status = ''; message = 'ì»¨ë””ì…˜ ì–‘í˜¸! ğŸ˜Š';
        tips = ['ğŸ“š ê³„íšëŒ€ë¡œ ì§„í–‰í•˜ì„¸ìš”', 'â° 50ë¶„ ì§‘ì¤‘ + 10ë¶„ íœ´ì‹ ì¶”ì²œ'];
    } else if (data.score >= 40) {
        status = 'warning'; message = 'ì¡°ê¸ˆ í”¼ê³¤í•´ìš” ğŸ˜';
        tips = ['â˜• ë”°ëœ»í•œ ì°¨ í•œ ì” ì–´ë•Œìš”?', 'ğŸ§˜ ìŠ¤íŠ¸ë ˆì¹­ì„ í•´ë³´ì„¸ìš”'];
    } else {
        status = 'danger'; message = 'ì˜¤ëŠ˜ì€ ë¬´ë¦¬í•˜ì§€ ë§ˆì„¸ìš” ğŸ˜¢';
        tips = ['ğŸ’¤ ì¶©ë¶„í•œ íœ´ì‹ì´ í•„ìš”í•´ìš”', 'ğŸ“– ê°€ë²¼ìš´ ë³µìŠµë§Œ í•˜ì„¸ìš”'];
    }
    
    if (data.symptoms.includes('headache')) tips.push('ğŸ¤• ë‘í†µ: ëˆˆ ê°ê³  5ë¶„ íœ´ì‹');
    if (data.symptoms.includes('eyestrain')) tips.push('ğŸ‘€ ëˆˆí”¼ë¡œ: ë¨¼ ê³³ ë°”ë¼ë³´ê¸°');
    
    const card = document.getElementById('careResultCard');
    card.className = 'care-result-card ' + status;
    card.style.display = 'block';
    document.getElementById('careResultContent').innerHTML = `
        <div class="care-score">${data.score}ì </div>
        <div class="care-message">${message}</div>
        <div class="care-tips">${tips.map(t => `<div class="care-tip">${t}</div>`).join('')}</div>
    `;
}

// ========== ë”ë³´ê¸° ì„œë¸Œëª¨ë‹¬ ==========
function openSubModal(id) {
    document.getElementById(id).classList.add('show');
    if (id === 'mystatsModal') loadMyStats();
    if (id === 'liveModal') loadLiveStatus();
    if (id === 'achieveModal') loadAchievement();
    if (id === 'styleModal') loadSavedStyle();
    if (id === 'roadmapModal') loadSavedRoadmap();
}

function closeSubModal(id) {
    document.getElementById(id).classList.remove('show');
}

// ========== í•™ìŠµì„±í–¥ ì§„ë‹¨ ==========
let styleData = null;

function loadSavedStyle() {
    if (!user) return;
    const saved = localStorage.getItem(`style_${user.name}`);
    if (saved) {
        styleData = JSON.parse(saved);
        displayStyleResult();
    }
}

// ========== í•™ìŠµì„±í–¥ ì§„ë‹¨ (ì§ˆë¬¸ ê¸°ë°˜) ==========
const styleQuestions = [
    {
        q: "ìƒˆë¡œìš´ ë‚´ìš©ì„ ë°°ìš¸ ë•Œ ì„ í˜¸í•˜ëŠ” ë°©ì‹ì€?",
        a: [
            { text: "ğŸ“Š ê·¸ë¦¼, ë„í‘œ, ì˜ìƒìœ¼ë¡œ ë³´ê¸°", type: "V" },
            { text: "ğŸ§ ì„¤ëª…ì„ ë“£ê±°ë‚˜ ê°•ì˜ ë“£ê¸°", type: "A" },
            { text: "âœï¸ ì§ì ‘ í•´ë³´ë©° ìµíˆê¸°", type: "K" }
        ]
    },
    {
        q: "ê³µë¶€í•  ë•Œ ì§‘ì¤‘ì´ ì˜ ë˜ëŠ” í™˜ê²½ì€?",
        a: [
            { text: "ğŸ¤« í˜¼ì ì¡°ìš©íˆ", type: "S" },
            { text: "ğŸ‘¥ ì¹œêµ¬ë“¤ê³¼ í•¨ê»˜", type: "G" }
        ]
    },
    {
        q: "í•™ìŠµ ê³„íšì„ ì„¸ìš¸ ë•Œ ë‚˜ëŠ”?",
        a: [
            { text: "ğŸ“‹ ì„¸ë¶€ ê³„íšì„ ê¼¼ê¼¼íˆ ì„¸ìš´ë‹¤", type: "P" },
            { text: "ğŸ”€ ìœ ì—°í•˜ê²Œ ìƒí™©ì— ë§ì¶° í•œë‹¤", type: "F" }
        ]
    },
    {
        q: "ì–´ë ¤ìš´ ë¬¸ì œë¥¼ ë§Œë‚¬ì„ ë•Œ ë‚˜ëŠ”?",
        a: [
            { text: "ğŸ¯ ëê¹Œì§€ í˜¼ì í•´ê²°í•˜ë ¤ í•œë‹¤", type: "S" },
            { text: "ğŸ™‹ ë°”ë¡œ ì§ˆë¬¸í•˜ê±°ë‚˜ ë„ì›€ì„ êµ¬í•œë‹¤", type: "G" }
        ]
    },
    {
        q: "ì‹œí—˜ ê³µë¶€í•  ë•Œ íš¨ê³¼ì ì¸ ë°©ë²•ì€?",
        a: [
            { text: "ğŸ“ ìš”ì•½ ë…¸íŠ¸, ë§ˆì¸ë“œë§µ ë§Œë“¤ê¸°", type: "V" },
            { text: "ğŸ—£ï¸ ì†Œë¦¬ ë‚´ì–´ ì½ê±°ë‚˜ ì„¤ëª…í•˜ê¸°", type: "A" },
            { text: "ğŸ“š ë¬¸ì œë¥¼ ë§ì´ í’€ì–´ë³´ê¸°", type: "K" }
        ]
    }
];

let currentQuestion = 0;
let styleAnswers = { V: 0, A: 0, K: 0, S: 0, G: 0, P: 0, F: 0 };

function startStyleTest() {
    currentQuestion = 0;
    styleAnswers = { V: 0, A: 0, K: 0, S: 0, G: 0, P: 0, F: 0 };
    document.getElementById('styleIntro').style.display = 'none';
    document.getElementById('styleResult').style.display = 'block';
    showQuestion();
}

function showQuestion() {
    if (currentQuestion >= styleQuestions.length) {
        finishStyleTest();
        return;
    }
    
    const q = styleQuestions[currentQuestion];
    document.getElementById('styleResult').innerHTML = `
        <div class="my-stats-card">
            <div style="text-align:center;margin-bottom:20px;">
                <div style="font-size:0.9rem;color:#888;">ì§ˆë¬¸ ${currentQuestion + 1} / ${styleQuestions.length}</div>
                <div style="height:6px;background:#e5e5e5;border-radius:3px;margin-top:8px;">
                    <div style="height:100%;width:${((currentQuestion + 1) / styleQuestions.length) * 100}%;background:linear-gradient(90deg,#8b5cf6,#a78bfa);border-radius:3px;"></div>
                </div>
            </div>
            <div style="font-size:1.1rem;font-weight:600;color:var(--primary);text-align:center;margin-bottom:20px;">${q.q}</div>
            <div class="style-answers">
                ${q.a.map((ans, i) => `
                    <button onclick="selectAnswer('${ans.type}')" class="style-answer-btn">${ans.text}</button>
                `).join('')}
            </div>
        </div>
    `;
}

function selectAnswer(type) {
    styleAnswers[type]++;
    currentQuestion++;
    showQuestion();
}

function finishStyleTest() {
    const learning = styleAnswers.V >= styleAnswers.A && styleAnswers.V >= styleAnswers.K ? 'V' :
                     styleAnswers.A >= styleAnswers.K ? 'A' : 'K';
    const social = styleAnswers.S >= styleAnswers.G ? 'S' : 'G';
    const planning = styleAnswers.P >= styleAnswers.F ? 'P' : 'F';
    
    const code = learning + social + planning + 'G';
    
    const typeNames = {
        'VSPG': 'ì‹œê°ì  ê³„íší˜• í•™ìŠµì', 'VSFG': 'ì‹œê°ì  ìœ ì—°í˜• í•™ìŠµì',
        'VGPG': 'ì‹œê°ì  í˜‘ë ¥í˜• í•™ìŠµì', 'VGFG': 'ì‹œê°ì  ììœ í˜• í•™ìŠµì',
        'ASPG': 'ì²­ê°ì  ê³„íší˜• í•™ìŠµì', 'ASFG': 'ì²­ê°ì  ìœ ì—°í˜• í•™ìŠµì',
        'AGPG': 'ì²­ê°ì  í˜‘ë ¥í˜• í•™ìŠµì', 'AGFG': 'ì²­ê°ì  ììœ í˜• í•™ìŠµì',
        'KSPG': 'ì²´í—˜ì  ê³„íší˜• í•™ìŠµì', 'KSFG': 'ì²´í—˜ì  ìœ ì—°í˜• í•™ìŠµì',
        'KGPG': 'ì²´í—˜ì  í˜‘ë ¥í˜• í•™ìŠµì', 'KGFG': 'ì²´í—˜ì  ììœ í˜• í•™ìŠµì'
    };
    
    const allTips = {
        'V': ['ğŸ“Š ë„í‘œì™€ ê·¸ë˜í”„ í™œìš©', 'ğŸ“ ìƒ‰ê¹” íœìœ¼ë¡œ ì •ë¦¬', 'ğŸ¬ ì˜ìƒ ê°•ì˜ í™œìš©'],
        'A': ['ğŸ§ ê°•ì˜ ë“¤ìœ¼ë©° ê³µë¶€', 'ğŸ—£ï¸ ì†Œë¦¬ ë‚´ì–´ ì½ê¸°', 'ğŸ‘¥ ìŠ¤í„°ë”” í† ë¡ '],
        'K': ['âœï¸ ì§ì ‘ ë¬¸ì œ í’€ê¸°', 'ğŸ“‹ ì†ìœ¼ë¡œ í•„ê¸°', 'ğŸ”¬ ì‹¤ìŠµ/ì‹¤í—˜ ì°¸ì—¬'],
        'S': ['ğŸ¤« ì¡°ìš©í•œ í™˜ê²½ í™•ë³´', 'â° í˜¼ìë§Œì˜ ì‹œê°„ í™•ë³´'],
        'G': ['ğŸ‘¥ ìŠ¤í„°ë”” ê·¸ë£¹ í™œìš©', 'ğŸ™‹ ì ê·¹ì  ì§ˆë¬¸'],
        'P': ['ğŸ“… ì„¸ë¶€ ê³„íš ìˆ˜ë¦½', 'âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸ í™œìš©'],
        'F': ['ğŸ”€ ìœ ì—°í•œ ì¼ì • ê´€ë¦¬', 'ğŸ¯ í•µì‹¬ ìœ„ì£¼ í•™ìŠµ']
    };
    
    const tips = [...allTips[learning], ...allTips[social], ...allTips[planning]].slice(0, 4);
    
    styleData = { code, name: typeNames[code] || code + ' í•™ìŠµì', tips };
    localStorage.setItem(`style_${user.name}`, JSON.stringify(styleData));
    api({ action: 'saveStyle', floor: user.floor, name: user.name, ...styleData, date: fmt(new Date()) });
    
    displayStyleResult();
    toast('ì„±í–¥ ì§„ë‹¨ ì™„ë£Œ!', 'success');
}

function displayStyleResult() {
    if (!styleData) return;
    document.getElementById('styleIntro').style.display = 'none';
    document.getElementById('styleResult').style.display = 'block';
    document.getElementById('styleResult').innerHTML = `
        <div class="style-result-card">
            <div class="style-code-badge">${styleData.code}</div>
            <div class="style-name">${styleData.name}</div>
            <div class="style-desc">ë‹¹ì‹ ë§Œì˜ í•™ìŠµ ìŠ¤íƒ€ì¼ì…ë‹ˆë‹¤!</div>
    <button onclick="resetStyleTest()" style="margin-top:15px;padding:10px 20px;background:#f0f0f0;border:none;border-radius:8px;cursor:pointer;">ğŸ”„ ë‹¤ì‹œ ì§„ë‹¨í•˜ê¸°</button>
        </div>
        <div class="my-stats-card">
            <div class="my-stats-title"><i class="fas fa-lightbulb" style="color:#f59e0b;"></i> ë§ì¶¤ í•™ìŠµ íŒ</div>
            ${styleData.tips.map(t => `<div class="care-tip">${t}</div>`).join('')}
        </div>
    `;
}

// ========== í•™ìŠµ ë¡œë“œë§µ ==========
let roadmapData = null;

function loadSavedRoadmap() {
    if (!user) return;
    const saved = localStorage.getItem(`roadmap_${user.name}`);
    if (saved) {
        roadmapData = JSON.parse(saved);
        displayRoadmapResult();
    }
}

function showRoadmapSetup() {
    document.getElementById('roadmapIntro').style.display = 'none';
    document.getElementById('roadmapSetup').style.display = 'block';
}

function createRoadmap() {
    const goal = document.getElementById('rmGoal').value;
    const period = document.getElementById('rmPeriod').value;
    const hours = document.getElementById('rmHours').value;
    
    if (!goal || !period || !hours) { toast('ëª¨ë“  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”', 'warning'); return; }
    
    const goalNames = { 'top10': 'ìƒìœ„ê¶Œ ëŒ€í•™', 'mid': 'ì¤‘ìƒìœ„ê¶Œ ëŒ€í•™', 'improve': 'ì„±ì  í–¥ìƒ', 'weak': 'ì·¨ì•½ ê³¼ëª© ê·¹ë³µ' };
    roadmapData = { goal: goalNames[goal], period: parseInt(period), dailyHours: parseInt(hours), startDate: fmt(new Date()) };
    localStorage.setItem(`roadmap_${user.name}`, JSON.stringify(roadmapData));
                                     // API ì €ì¥
    api({ action: 'saveRoadmap', floor: user.floor, name: user.name, ...roadmapData });
    displayRoadmapResult();
    toast('ë¡œë“œë§µ ìƒì„± ì™„ë£Œ!', 'success');
}

function displayRoadmapResult() {
    if (!roadmapData) return;
    document.getElementById('roadmapIntro').style.display = 'none';
    document.getElementById('roadmapSetup').style.display = 'none';
    document.getElementById('roadmapResult').style.display = 'block';
    
    const startDate = new Date(roadmapData.startDate);
    const endDate = new Date(startDate);
    endDate.setMonth(endDate.getMonth() + roadmapData.period);
    const daysLeft = Math.max(0, Math.ceil((endDate - new Date()) / (1000 * 60 * 60 * 24)));
    const progress = Math.round(((roadmapData.period * 30 - daysLeft) / (roadmapData.period * 30)) * 100);
    
    document.getElementById('roadmapResult').innerHTML = `
        <div class="my-stats-card">
            <div style="text-align:center;padding-bottom:15px;border-bottom:1px solid #f0f0f0;">
                <div style="font-size:1.3rem;font-weight:700;color:var(--primary);">${roadmapData.goal}</div>
                <div style="font-size:0.9rem;color:#888;">${roadmapData.period}ê°œì›” ë¡œë“œë§µ</div>
            </div>
            <div class="stats-summary-row" style="margin-top:15px;">
                <div class="summary-box"><div class="value">${roadmapData.dailyHours}h</div><div class="label">ì¼ì¼ ëª©í‘œ</div></div>
                <div class="summary-box"><div class="value" style="color:#10b981;">${progress}%</div><div class="label">ì§„í–‰ë¥ </div></div>
                <div class="summary-box"><div class="value">${daysLeft}</div><div class="label">ë‚¨ì€ ì¼</div></div>
            </div>
    <button onclick="resetRoadmap()" style="margin-top:15px;padding:10px 20px;background:#f0f0f0;border:none;border-radius:8px;cursor:pointer;width:100%;">ğŸ”„ ë‹¤ì‹œ ì„¤ì •í•˜ê¸°</button>
        </div>
    `;
}

// ========== í•™ìŠµ ì„±ì·¨ë„ ==========
function loadAchievement() {
    const weekDates = getWeekDates();
    const weekStart = fmt(weekDates[0]);
    const weekEnd = fmt(weekDates[6]);
    
    const weekPlans = plans.filter(p => p.date >= weekStart && p.date <= weekEnd);
    const completed = weekPlans.filter(p => ['approved', 'O'].includes(p.status));
    const rate = weekPlans.length > 0 ? Math.round((completed.length / weekPlans.length) * 100) : 0;
    
    let grade, title, message;
    if (rate >= 90) { grade = 'S'; title = 'ìµœìš°ìˆ˜!'; message = 'ì •ë§ í›Œë¥­í•´ìš”! ğŸ”¥'; }
    else if (rate >= 80) { grade = 'A'; title = 'ìš°ìˆ˜!'; message = 'ì˜í•˜ê³  ìˆì–´ìš”! ğŸ‘'; }
    else if (rate >= 70) { grade = 'B'; title = 'ì–‘í˜¸'; message = 'ì¢‹ì€ ë°©í–¥ì´ì—ìš”! ğŸ’ª'; }
    else if (rate >= 60) { grade = 'C'; title = 'ë³´í†µ'; message = 'ì¡°ê¸ˆ ë” ë…¸ë ¥í•´ë´ìš”!'; }
    else { grade = 'D'; title = 'ë¶„ë°œ í•„ìš”'; message = 'í•¨ê»˜ ë°©ë²•ì„ ì°¾ì•„ë´ìš”! ğŸ“š'; }
    
    const totalTime = completed.reduce((sum, p) => sum + (p.actualTime || 0), 0);
    
    document.getElementById('achieveContent').innerHTML = `
        <div class="my-stats-card" style="text-align:center;">
            <div class="achieve-grade-badge ${grade}">
                <div class="achieve-grade-letter">${grade}</div>
                <div class="achieve-grade-score">${rate}ì </div>
            </div>
            <div style="font-size:1.2rem;font-weight:700;color:var(--primary);">${title}</div>
            <div style="color:#666;margin-top:5px;">${message}</div>
            <div class="stats-summary-row" style="margin-top:20px;">
                <div class="summary-box"><div class="value">${completed.length}</div><div class="label">ì™„ë£Œ</div></div>
                <div class="summary-box"><div class="value">${weekPlans.length}</div><div class="label">ê³„íš</div></div>
                <div class="summary-box"><div class="value">${(totalTime/60).toFixed(1)}h</div><div class="label">í•™ìŠµì‹œê°„</div></div>
            </div>
        </div>
    `;
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì»¨ë””ì…˜ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(setupCareListeners, 500);
});
    /* í•™ìŠµì„±í–¥ ì§„ë‹¨ ë²„íŠ¼ */
.style-answer-btn {
    display: block;
    width: 100%;
    padding: 15px;
    margin-bottom: 10px;
    background: #f8f8f8;
    border: 2px solid #e5e5e5;
    border-radius: 12px;
    font-size: 1rem;
    text-align: left;
    cursor: pointer;
    transition: all 0.2s;
}
.style-answer-btn:hover {
    background: #f0f0ff;
    border-color: #8b5cf6;
}
.style-answer-btn:active {
    background: #e8e8ff;
}
[data-theme="dark"] .style-answer-btn {
    background: #3f3f46;
    border-color: #52525b;
}
    </style>
</head>
<body data-theme="ocean">
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <h1>ğŸ“š ê¹€ì—„ë§ˆë…ì„œì‹¤</h1>
            <p class="subtitle">ì¼ì¼ í”Œë˜ë„ˆ</p>
            <select id="loginFloor" onchange="loadStudents()">
                <option value="">ì¸µ ì„ íƒ</option>
                <option value="7ì¸µ">7ì¸µ</option>
                <option value="8ì¸µ">8ì¸µ</option>
            </select>
            <select id="loginName">
                <option value="">ì´ë¦„ ì„ íƒ</option>
            </select>
            <button onclick="login()">ì‹œì‘í•˜ê¸°</button>
        </div>
    </div>

    <div class="container" id="container">
        <div class="header">
            <div class="header-left">
                <span class="mood" id="mood">ğŸ˜Š</span>
                <span class="name" id="userName">í•™ìƒ</span>
            </div>
            <div class="header-right">
                <button class="header-btn" onclick="openThemeModal()" title="í…Œë§ˆ"><i class="fas fa-palette"></i></button>
                <button class="header-btn" onclick="toggleStats()" title="í†µê³„"><i class="fas fa-chart-bar"></i></button>
                <button class="header-btn" onclick="captureShare()" title="ê³µìœ "><i class="fas fa-camera"></i></button>
                <button class="header-btn" onclick="logout()" title="ë¡œê·¸ì•„ì›ƒ"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>

        <div class="week-bar">
            <button class="week-nav" onclick="changeWeek(-1)"><i class="fas fa-chevron-left"></i></button>
            <div class="week-info">
                <div class="week-title" id="weekTitle">2ì›” 1ì£¼ì°¨</div>
                <div class="week-range" id="weekRange">2/3(ì›”)~2/9(ì¼)</div>
            </div>
            <button class="week-nav" onclick="changeWeek(1)"><i class="fas fa-chevron-right"></i></button>
        </div>

        <!-- ì—°ì† í•™ìŠµì¼ & ëˆ„ì  ì‹œê°„ -->
        <div class="streak-bar">
            <div class="streak-item">
                <span class="streak-icon">ğŸ”¥</span>
                <span class="streak-value" id="streakDays">0</span>
                <span class="streak-label">ì¼ ì—°ì†</span>
            </div>
            <div class="streak-divider"></div>
            <div class="streak-item">
                <span class="streak-icon">â±ï¸</span>
                <span class="streak-value" id="totalStudyTime">0h</span>
                <span class="streak-label">ëˆ„ì </span>
            </div>
        </div>

        <div class="table-wrapper">
            <div id="captureArea">
                <div class="capture-header" id="captureHeader">
                    <div class="capture-title">ğŸ“š ê¹€ì—„ë§ˆë…ì„œì‹¤ ì£¼ê°„ê³„íší‘œ</div>
                    <div class="capture-info" id="captureInfo">í•™ìƒ Â· ì¸µ Â· ì£¼ì°¨</div>
                </div>
                <table class="plan-table">
                <thead id="tableHead"></thead>
                <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>

        <div class="check-bar">
            <div class="check-bar-info">
                <div class="check-bar-title">ì˜¤ëŠ˜ì˜ í•™ìŠµ</div>
                <div class="check-bar-status" id="checkBarStatus">ì™„ë£Œ: 0ê°œ Â· 0ë¶„</div>
            </div>
            <div class="check-bar-btns">
                <button class="check-btn cancel" onclick="cancelAllChecks()" id="cancelCheckBtn" style="display:none;">
                    <i class="fas fa-times"></i>ì·¨ì†Œ
                </button>
                <button class="check-btn request" onclick="openCheckModal()" id="requestCheckBtn" disabled>
                    <i class="fas fa-bell"></i>ê²€ì‚¬ ìš”ì²­
                </button>
            </div>
        </div>

        <div class="stats-panel" id="statsPanel">
            <button class="close-stats" onclick="toggleStats()"><i class="fas fa-times"></i></button>
            <div class="stats-grid">
                <div class="stat-item"><div class="stat-value" id="statTotal">0</div><div class="stat-label">ì´ ê³„íš</div></div>
                <div class="stat-item"><div class="stat-value" id="statDone" style="color:#10b981">0</div><div class="stat-label">ì™„ë£Œ</div></div>
                <div class="stat-item"><div class="stat-value" id="statTime" style="color:var(--accent)">0h</div><div class="stat-label">ê³µë¶€ì‹œê°„</div></div>
                <div class="stat-item"><div class="stat-value" id="statRate" style="color:#f59e0b">0%</div><div class="stat-label">ì‹¤ì²œìœ¨</div></div>
            </div>
        </div>
    </div>

    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="editBook()">
            <i class="fas fa-edit"></i>
            <span>ìˆ˜ì •</span>
        </div>
        <div class="context-menu-item danger" onclick="deleteBook()">
            <i class="fas fa-trash"></i>
            <span>ì‚­ì œ</span>
        </div>
    </div>

    <!-- ê³„íš ì‚­ì œ ë©”ë‰´ -->
    <div class="context-menu" id="planMenu">
        <div class="context-menu-item danger" onclick="deletePlan()">
            <i class="fas fa-trash"></i>
            <span>ê³„íš ì‚­ì œ</span>
        </div>
    </div>

    <div class="modal" id="bookModal">
        <div class="modal-box">
            <h3 id="bookModalTitle">ğŸ“š êµì¬/ì¸ê°• ì¶”ê°€</h3>
            <select id="bookSubject">
                <option value="">ê³¼ëª© ì„ íƒ</option>
                <option value="êµ­ì–´">êµ­ì–´</option>
                <option value="ìˆ˜í•™">ìˆ˜í•™</option>
                <option value="ì˜ì–´">ì˜ì–´</option>
                <option value="íƒêµ¬">íƒêµ¬</option>
            </select>
            <div class="type-selector">
                <div class="type-option">
                    <input type="radio" name="bookType" id="typeTextbook" value="textbook" checked>
                    <label for="typeTextbook"><i class="fas fa-book"></i><span>êµì¬</span></label>
                </div>
                <div class="type-option">
                    <input type="radio" name="bookType" id="typeLecture" value="lecture">
                    <label for="typeLecture"><i class="fas fa-video"></i><span>ì¸ê°•</span></label>
                </div>
            </div>
            <input type="text" id="bookName" placeholder="êµì¬ëª… ë˜ëŠ” ê°•ì˜ëª…">
            <div class="modal-btns">
                <button class="cancel" onclick="closeBookModal()">ì·¨ì†Œ</button>
                <button class="confirm" onclick="saveBook()">ì €ì¥</button>
            </div>
        </div>
    </div>

    <div class="modal" id="themeModal">
        <div class="modal-box">
            <h3>ğŸ¨ í”Œë˜ë„ˆ í…Œë§ˆ</h3>
            <div class="theme-grid">
                <div class="theme-option active" data-theme="ocean" onclick="selectTheme('ocean')">
                    <div class="theme-preview" style="background: linear-gradient(135deg, #1e3a5f, #3b82f6);"></div>
                    <div class="theme-name">ğŸŒŠ ì˜¤ì…˜ ë¸”ë£¨</div>
                </div>
                <div class="theme-option" data-theme="cherry" onclick="selectTheme('cherry')">
                    <div class="theme-preview" style="background: linear-gradient(135deg, #db2777, #f472b6);"></div>
                    <div class="theme-name">ğŸŒ¸ ì²´ë¦¬ ë¸”ë¼ì¸</div>
                </div>
                <div class="theme-option" data-theme="mint" onclick="selectTheme('mint')">
                    <div class="theme-preview" style="background: linear-gradient(135deg, #059669, #34d399);"></div>
                    <div class="theme-name">ğŸŒ¿ ë¯¼íŠ¸ ê·¸ë¦°</div>
                </div>
                <div class="theme-option" data-theme="violet" onclick="selectTheme('violet')">
                    <div class="theme-preview" style="background: linear-gradient(135deg, #7c3aed, #a78bfa);"></div>
                    <div class="theme-name">ğŸ’œ ë°”ì´ì˜¬ë ›</div>
                </div>
                <div class="theme-option" data-theme="sunset" onclick="selectTheme('sunset')">
                    <div class="theme-preview" style="background: linear-gradient(135deg, #ea580c, #f97316);"></div>
                    <div class="theme-name">ğŸŠ ì„ ì…‹</div>
                </div>
                <div class="theme-option" data-theme="dark" onclick="selectTheme('dark')">
                    <div class="theme-preview" style="background: linear-gradient(135deg, #1f1f1f, #8b5cf6);"></div>
                    <div class="theme-name">ğŸŒ™ ë‹¤í¬ ë‚˜ì´íŠ¸</div>
                </div>
            </div>
            <div class="modal-btns">
                <button class="confirm" onclick="closeThemeModal()" style="flex:1;">í™•ì¸</button>
            </div>
        </div>
    </div>

    <div class="modal check-modal" id="checkModal">
        <div class="modal-box">
            <h3>ğŸ“‹ ê²€ì‚¬ ìš”ì²­</h3>
            <div class="check-summary" id="checkSummary"></div>
            <div class="photo-section">
                <div class="photo-label">ğŸ“¸ ì¸ì¦ ì‚¬ì§„ (ì„ íƒ)</div>
                <div class="photo-preview" id="photoPreview" onclick="document.getElementById('photoInput').click()">
                    <i class="fas fa-camera"></i>
                    <span>í„°ì¹˜í•˜ì—¬ ì‚¬ì§„ ì´¬ì˜</span>
                </div>
                <input type="file" id="photoInput" accept="image/*" capture="environment" onchange="handlePhoto(this)">
            </div>
            <div class="modal-btns">
                <button class="cancel" onclick="closeCheckModal(false)">ì·¨ì†Œ</button>
                <button class="confirm" onclick="closeCheckModal(true)">ìš”ì²­í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
    <nav class="bottom-nav" id="bottomNav" style="display:none;">
    <button class="nav-item active" onclick="switchNav('planner')">
        <i class="fas fa-calendar-alt"></i>
        <span>í”Œë˜ë„ˆ</span>
    </button>
    <button class="nav-item" onclick="switchNav('care')">
        <i class="fas fa-heart-pulse"></i>
        <span>ì»¨ë””ì…˜</span>
    </button>
    <button class="nav-item" onclick="switchNav('ranking')">
        <i class="fas fa-trophy"></i>
        <span>ë­í‚¹</span>
    </button>
    <button class="nav-item" onclick="switchNav('more')">
        <i class="fas fa-ellipsis-h"></i>
        <span>ë”ë³´ê¸°</span>
    </button>
</nav>

    <!-- ë­í‚¹ ëª¨ë‹¬ -->
    <div class="fullscreen-modal" id="rankingModal">
        <div class="fm-header">
            <h2><i class="fas fa-trophy"></i> ì˜¤ëŠ˜ì˜ ë­í‚¹</h2>
            <button class="fm-close" onclick="closeModal('rankingModal')"><i class="fas fa-times"></i></button>
        </div>
        <div class="fm-body">
            <div class="ranking-card">
                <div class="ranking-card-title"><i class="fas fa-clock"></i> í•™ìŠµì‹œê°„ TOP 10</div>
                <ul class="ranking-list" id="timeRankingList"></ul>
            </div>
            <div class="ranking-card">
                <div class="ranking-card-title"><i class="fas fa-check-circle"></i> ì™„ë£Œ ê³¼ëª© TOP 10</div>
                <ul class="ranking-list" id="completeRankingList"></ul>
            </div>
        </div>
    </div>

    <!-- ë‚´ í†µê³„ ëª¨ë‹¬ -->
    <div class="fullscreen-modal" id="mystatsModal">
        <div class="fm-header">
            <h2><i class="fas fa-chart-pie"></i> ë‚´ í•™ìŠµ í†µê³„</h2>
            <button class="fm-close" onclick="closeModal('mystatsModal')"><i class="fas fa-times"></i></button>
        </div>
        <div class="fm-body">
            <!-- ì—°ì† í•™ìŠµì¼ & ëˆ„ì  ì‹œê°„ -->
            <div class="my-stats-card" style="background: linear-gradient(135deg, #fef3c7, #fde68a);">
                <div class="stats-summary-row" style="grid-template-columns: 1fr 1fr;">
                    <div class="summary-box" style="background: rgba(255,255,255,0.7);">
                        <div class="value" style="color:#92400e;">ğŸ”¥ <span id="myStreakDays">0</span></div>
                        <div class="label" style="color:#a16207;">ì¼ ì—°ì† í•™ìŠµ</div>
                    </div>
                    <div class="summary-box" style="background: rgba(255,255,255,0.7);">
                        <div class="value" style="color:#92400e;">â±ï¸ <span id="myTotalTime">0h</span></div>
                        <div class="label" style="color:#a16207;">ëˆ„ì  í•™ìŠµì‹œê°„</div>
                    </div>
                </div>
            </div>
            <div class="my-stats-card">
                <div class="my-stats-title"><i class="fas fa-calendar-week"></i> ì´ë²ˆ ì£¼ ìš”ì•½</div>
                <div class="stats-summary-row">
                    <div class="summary-box">
                        <div class="value" id="myWeekCompleted">0</div>
                        <div class="label">ì™„ë£Œ</div>
                    </div>
                    <div class="summary-box">
                        <div class="value" id="myWeekTime">0h</div>
                        <div class="label">í•™ìŠµì‹œê°„</div>
                    </div>
                    <div class="summary-box">
                        <div class="value" id="myWeekRate">0%</div>
                        <div class="label">ì‹¤ì²œìœ¨</div>
                    </div>
                </div>
            </div>
            <div class="my-stats-card">
                <div class="my-stats-title"><i class="fas fa-book"></i> ê³¼ëª©ë³„ í•™ìŠµì‹œê°„</div>
                <div id="subjectBars"></div>
            </div>
        </div>
    </div>

    <!-- ì‹¤ì‹œê°„ í˜„í™© ëª¨ë‹¬ -->
    <div class="fullscreen-modal" id="liveModal">
        <div class="fm-header">
            <h2><i class="fas fa-users"></i> ì‹¤ì‹œê°„ ê³µë¶€ í˜„í™©</h2>
            <button class="fm-close" onclick="closeModal('liveModal')"><i class="fas fa-times"></i></button>
        </div>
        <div class="fm-body">
            <div class="live-count">
                <div class="number" id="liveStudyingCount">0</div>
                <div class="label">ëª…ì´ ì§€ê¸ˆ ê³µë¶€ì¤‘!</div>
            </div>
            <div id="liveList"></div>
        </div>
    </div>
<!-- ì»¨ë””ì…˜(ì—„ë§ˆì†ì¼€ì–´) ëª¨ë‹¬ -->
<div class="fullscreen-modal" id="careModal">
    <div class="fm-header">
        <h2><i class="fas fa-heart-pulse"></i> ì˜¤ëŠ˜ì˜ ì»¨ë””ì…˜</h2>
        <button class="fm-close" onclick="closeModal('careModal')"><i class="fas fa-times"></i></button>
    </div>
    <div class="fm-body">
        <div class="care-card">
            <div class="care-title"><i class="fas fa-moon"></i> ìˆ˜ë©´</div>
            <div class="care-row">
                <label>ì–´ì ¯ë°¤ ìˆ˜ë©´ì‹œê°„</label>
                <div class="care-input-row">
                    <input type="number" id="sleepHours" min="0" max="12" value="7">
                    <span>ì‹œê°„</span>
                </div>
            </div>
            <div class="care-row">
                <label>ìˆ˜ë©´ì˜ ì§ˆ</label>
                <div class="emoji-rating" id="sleepQuality">
                    <button class="emoji-btn" data-value="1">ğŸ˜«</button>
                    <button class="emoji-btn" data-value="2">ğŸ˜”</button>
                    <button class="emoji-btn selected" data-value="3">ğŸ˜</button>
                    <button class="emoji-btn" data-value="4">ğŸ˜Š</button>
                    <button class="emoji-btn" data-value="5">ğŸ˜´</button>
                </div>
            </div>
        </div>
        <div class="care-card">
            <div class="care-title"><i class="fas fa-battery-half"></i> ì»¨ë””ì…˜</div>
            <div class="care-row">
                <label>í˜„ì¬ ì»¨ë””ì…˜ (1~10)</label>
                <div class="care-slider-wrap">
                    <input type="range" id="conditionSlider" min="1" max="10" value="5">
                    <span id="conditionValue">5</span>
                </div>
            </div>
            <div class="care-row">
                <label>ìŠ¤íŠ¸ë ˆìŠ¤ ìˆ˜ì¤€</label>
                <div class="emoji-rating" id="stressLevel">
                    <button class="emoji-btn selected" data-value="1">ğŸ˜Œ</button>
                    <button class="emoji-btn" data-value="2">ğŸ™‚</button>
                    <button class="emoji-btn" data-value="3">ğŸ˜</button>
                    <button class="emoji-btn" data-value="4">ğŸ˜Ÿ</button>
                    <button class="emoji-btn" data-value="5">ğŸ˜µ</button>
                </div>
            </div>
        </div>
        <div class="care-card">
            <div class="care-title"><i class="fas fa-stethoscope"></i> ë¶ˆí¸í•œ ì¦ìƒ</div>
            <div class="symptom-grid" id="symptoms">
                <span class="symptom-tag" data-symptom="headache">ğŸ¤• ë‘í†µ</span>
                <span class="symptom-tag" data-symptom="fatigue">ğŸ˜© í”¼ë¡œ</span>
                <span class="symptom-tag" data-symptom="eyestrain">ğŸ‘€ ëˆˆí”¼ë¡œ</span>
                <span class="symptom-tag" data-symptom="neck">ğŸ¦´ ëª©ê²°ë¦¼</span>
                <span class="symptom-tag" data-symptom="stomach">ğŸ¤¢ ì†Œí™”ë¶ˆëŸ‰</span>
                <span class="symptom-tag" data-symptom="cold">ğŸ¤§ ê°ê¸°ê¸°ìš´</span>
                <span class="symptom-tag selected" data-symptom="none">âœ¨ ì—†ìŒ</span>
            </div>
        </div>
        <div class="care-card">
            <div class="care-title"><i class="fas fa-utensils"></i> ì•„ì¹¨ì‹ì‚¬</div>
            <div class="emoji-rating" id="breakfast">
                <button class="emoji-btn" data-value="0">âŒ<br><small>ì•ˆë¨¹ìŒ</small></button>
                <button class="emoji-btn" data-value="1">ğŸŒ<br><small>ê°„ë‹¨íˆ</small></button>
                <button class="emoji-btn selected" data-value="2">ğŸ™<br><small>ì ë‹¹íˆ</small></button>
                <button class="emoji-btn" data-value="3">ğŸ±<br><small>ë“ ë“ íˆ</small></button>
            </div>
        </div>
        <button class="care-submit-btn" onclick="submitCondition()">
            <i class="fas fa-check"></i> ì»¨ë””ì…˜ ì²´í¬ ì™„ë£Œ
        </button>
        <div class="care-result-card" id="careResultCard" style="display:none;">
            <div class="care-result-title">ì˜¤ëŠ˜ì˜ ë§ì¶¤ ì¼€ì–´</div>
            <div id="careResultContent"></div>
        </div>
    </div>
</div>
    <!-- ë”ë³´ê¸° ëª¨ë‹¬ -->
<div class="fullscreen-modal" id="moreModal">
    <div class="fm-header">
        <h2><i class="fas fa-ellipsis-h"></i> ë”ë³´ê¸°</h2>
        <button class="fm-close" onclick="closeModal('moreModal')"><i class="fas fa-times"></i></button>
    </div>
    <div class="fm-body">
        <div class="more-menu">
            <div class="more-item" onclick="openSubModal('styleModal')">
                <div class="more-icon purple"><i class="fas fa-brain"></i></div>
                <div class="more-info">
                    <div class="more-title">í•™ìŠµì„±í–¥ ì§„ë‹¨</div>
                    <div class="more-desc">ë‚˜ì—ê²Œ ë§ëŠ” í•™ìŠµ ìŠ¤íƒ€ì¼ ì°¾ê¸°</div>
                </div>
                <i class="fas fa-chevron-right more-arrow"></i>
            </div>
            <div class="more-item" onclick="openSubModal('roadmapModal')">
                <div class="more-icon cyan"><i class="fas fa-route"></i></div>
                <div class="more-info">
                    <div class="more-title">í•™ìŠµ ë¡œë“œë§µ</div>
                    <div class="more-desc">ëª©í‘œ ë‹¬ì„±ì„ ìœ„í•œ ë‹¨ê³„ë³„ ê³„íš</div>
                </div>
                <i class="fas fa-chevron-right more-arrow"></i>
            </div>
            <div class="more-item" onclick="openSubModal('achieveModal')">
                <div class="more-icon blue"><i class="fas fa-chart-line"></i></div>
                <div class="more-info">
                    <div class="more-title">í•™ìŠµ ì„±ì·¨ë„</div>
                    <div class="more-desc">ì£¼ê°„ í•™ìŠµ ì„±ê³¼ í™•ì¸</div>
                </div>
                <i class="fas fa-chevron-right more-arrow"></i>
            </div>
            <div class="more-item" onclick="openSubModal('mystatsModal')">
                <div class="more-icon orange"><i class="fas fa-chart-pie"></i></div>
                <div class="more-info">
                    <div class="more-title">ë‚´ í†µê³„</div>
                    <div class="more-desc">ê³¼ëª©ë³„ í•™ìŠµì‹œê°„ ë¶„ì„</div>
                </div>
                <i class="fas fa-chevron-right more-arrow"></i>
            </div>
            <div class="more-item" onclick="openSubModal('liveModal')">
                <div class="more-icon pink"><i class="fas fa-users"></i></div>
                <div class="more-info">
                    <div class="more-title">ì‹¤ì‹œê°„ í˜„í™©</div>
                    <div class="more-desc">ì§€ê¸ˆ ê³µë¶€í•˜ëŠ” ì¹œêµ¬ë“¤</div>
                </div>
                <i class="fas fa-chevron-right more-arrow"></i>
            </div>
        </div>
    </div>
</div>

<!-- í•™ìŠµì„±í–¥ ì§„ë‹¨ ëª¨ë‹¬ -->
<div class="fullscreen-modal" id="styleModal">
    <div class="fm-header">
        <h2><i class="fas fa-brain"></i> í•™ìŠµì„±í–¥ ì§„ë‹¨</h2>
        <button class="fm-close" onclick="closeSubModal('styleModal')"><i class="fas fa-times"></i></button>
    </div>
    <div class="fm-body">
        <div class="style-intro" id="styleIntro">
            <div class="style-icon">ğŸ§ </div>
            <h3>ë‚˜ì˜ í•™ìŠµ ìŠ¤íƒ€ì¼ ì°¾ê¸°</h3>
            <p>ê°„ë‹¨í•œ ì§ˆë¬¸ì— ë‹µí•˜ê³ <br>ë§ì¶¤ í•™ìŠµ ì „ëµì„ ë°›ì•„ë³´ì„¸ìš”!</p>
            <button class="style-start-btn" onclick="startStyleTest()">ì§„ë‹¨ ì‹œì‘í•˜ê¸°</button>
        </div>
        <div id="styleResult" style="display:none;"></div>
    </div>
</div>

<!-- í•™ìŠµ ë¡œë“œë§µ ëª¨ë‹¬ -->
<div class="fullscreen-modal" id="roadmapModal">
    <div class="fm-header">
        <h2><i class="fas fa-route"></i> í•™ìŠµ ë¡œë“œë§µ</h2>
        <button class="fm-close" onclick="closeSubModal('roadmapModal')"><i class="fas fa-times"></i></button>
    </div>
    <div class="fm-body">
        <div class="roadmap-intro" id="roadmapIntro">
            <div class="style-icon">ğŸ—ºï¸</div>
            <h3>í•™ìŠµ ë¡œë“œë§µ ì„¤ì •</h3>
            <p>ëª©í‘œì— ë§ëŠ” ë§ì¶¤í˜• í•™ìŠµ ê³„íšì„<br>ì„¸ì›Œë³´ì„¸ìš”!</p>
            <button class="style-start-btn" onclick="showRoadmapSetup()" style="background:linear-gradient(135deg,#0891b2,#06b6d4);">ë¡œë“œë§µ ë§Œë“¤ê¸°</button>
        </div>
        <div id="roadmapSetup" style="display:none;">
            <div class="my-stats-card">
                <div class="my-stats-title">ğŸ¯ ëª©í‘œ ì„¤ì •</div>
                <select id="rmGoal" class="care-select">
                    <option value="">ëª©í‘œ ì„ íƒ</option>
                    <option value="top10">ìƒìœ„ê¶Œ ëŒ€í•™ ì§„í•™</option>
                    <option value="mid">ì¤‘ìƒìœ„ê¶Œ ëŒ€í•™ ì§„í•™</option>
                    <option value="improve">ì„±ì  í–¥ìƒ</option>
                    <option value="weak">ì·¨ì•½ ê³¼ëª© ê·¹ë³µ</option>
                </select>
                <select id="rmPeriod" class="care-select">
                    <option value="">ê¸°ê°„ ì„ íƒ</option>
                    <option value="1">1ê°œì›”</option>
                    <option value="3">3ê°œì›”</option>
                    <option value="6">6ê°œì›”</option>
                </select>
                <select id="rmHours" class="care-select">
                    <option value="">ì¼ì¼ ëª©í‘œ í•™ìŠµì‹œê°„</option>
                    <option value="4">4ì‹œê°„</option>
                    <option value="6">6ì‹œê°„</option>
                    <option value="8">8ì‹œê°„</option>
                    <option value="10">10ì‹œê°„</option>
                </select>
                <button class="care-submit-btn" onclick="createRoadmap()" style="background:linear-gradient(135deg,#0891b2,#06b6d4);">ë¡œë“œë§µ ìƒì„±</button>
            </div>
        </div>
        <div id="roadmapResult" style="display:none;"></div>
    </div>
</div>

<!-- í•™ìŠµ ì„±ì·¨ë„ ëª¨ë‹¬ -->
<div class="fullscreen-modal" id="achieveModal">
    <div class="fm-header">
        <h2><i class="fas fa-chart-line"></i> í•™ìŠµ ì„±ì·¨ë„</h2>
        <button class="fm-close" onclick="closeSubModal('achieveModal')"><i class="fas fa-times"></i></button>
    </div>
    <div class="fm-body">
        <div id="achieveContent"></div>
    </div>
</div>
    <div class="toast" id="toast"></div>

    <script>
        const API = 'https://script.google.com/macros/s/AKfycbwGFbsj8FgFIuF-iFkJ4ekyS76MWQf9UrUysJ-Fs12vuVByJwenoYRgOJeOZiPOa6gzkg/exec';
        
        let user = null;
        let books = [];
        let plans = [];
        let weekStart = getMonday(new Date());
        let timers = {};
        let completedToday = [];
        
        let selectedBook = null;
        let editMode = false;
        let editingBookData = null;
        let longPressTimer = null;
        let contextMenuJustOpened = false;
        let currentPhotoData = null;
        
        // ê³„íš ì‚­ì œìš© ë³€ìˆ˜
        let selectedPlan = null;
        let planLongPressTimer = null;

        const SUBJECTS = ['êµ­ì–´', 'ìˆ˜í•™', 'ì˜ì–´', 'íƒêµ¬'];

        document.addEventListener('DOMContentLoaded', () => {
            loadTheme();
            document.addEventListener('click', (e) => {
                if (contextMenuJustOpened) { contextMenuJustOpened = false; return; }
                if (!e.target.closest('.context-menu')) hideContextMenu();
            });
        });

        function getMonday(d) {
            const date = new Date(d);
            const day = date.getDay();
            return new Date(date.setDate(date.getDate() - day + (day === 0 ? -6 : 1)));
        }
        function fmt(d) { return d.toISOString().split('T')[0]; }
        function fmtKR(d) { return `${d.getMonth()+1}/${d.getDate()}`; }
        function dayName(i) { return ['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† ','ì¼'][i]; }
        function getWeekDates() {
            const arr = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(weekStart);
                d.setDate(weekStart.getDate() + i);
                arr.push(d);
            }
            return arr;
        }

        async function api(data) {
            try {
                const res = await fetch(API, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(data) });
                return await res.json();
            } catch { return { success: false }; }
        }

        function loadTheme() { applyTheme(localStorage.getItem('plannerTheme') || 'ocean'); }
        function applyTheme(theme) {
            document.body.setAttribute('data-theme', theme);
            document.querySelectorAll('.theme-option').forEach(opt => opt.classList.toggle('active', opt.dataset.theme === theme));
        }
        function selectTheme(theme) { applyTheme(theme); localStorage.setItem('plannerTheme', theme); }
        function openThemeModal() { document.getElementById('themeModal').classList.add('active'); }
        function closeThemeModal() { document.getElementById('themeModal').classList.remove('active'); }

        async function loadStudents() {
            const floor = document.getElementById('loginFloor').value;
            const sel = document.getElementById('loginName');
            if (!floor) return;
            sel.innerHTML = '<option>ë¡œë”©ì¤‘...</option>';
            const res = await api({ action: 'getStudents', floor });
            if (res.success) sel.innerHTML = '<option value="">ì´ë¦„ ì„ íƒ</option>' + res.students.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
        }

        async function login() {
            const floor = document.getElementById('loginFloor').value;
            const name = document.getElementById('loginName').value;
            if (!floor || !name) return toast('ì¸µê³¼ ì´ë¦„ì„ ì„ íƒí•˜ì„¸ìš”', 'warning');
            user = { floor, name };
            document.getElementById('userName').textContent = name;
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('container').classList.add('active');
            document.getElementById('bottomNav').style.display = 'flex';
            await loadData();
        }

        function logout() {
            // ë¡œê·¸ì•„ì›ƒ ì „ ì‹¤ì‹œê°„ ìƒíƒœ idleë¡œ ì—…ë°ì´íŠ¸
            if (user) {
                updateLiveStatusAPI('idle', '');
            }
            user = null; timers = {}; completedToday = [];
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('container').classList.remove('active');
            document.getElementById('bottomNav').style.display = 'none';
            // ëª¨ë‹¬ë„ ë‹«ê¸°
            closeModal('rankingModal');
            closeModal('mystatsModal');
            closeModal('liveModal');
        }

        async function loadData() {
            const bRes = await api({ action: 'getBooks', floor: user.floor, name: user.name });
            if (bRes.success) books = bRes.books || [];
            await loadPlans();
            renderWeek(); renderTable(); updateMood(); updateCheckBar();
            updateStreakAndTotal(); // ì—°ì† í•™ìŠµì¼ & ëˆ„ì  ì‹œê°„ ì—…ë°ì´íŠ¸
        }

        async function loadPlans() {
            const dates = getWeekDates();
            const res = await api({ action: 'getWeekPlans', floor: user.floor, name: user.name, startDate: fmt(dates[0]), endDate: fmt(dates[6]) });
            if (res.success) plans = res.plans || [];
        }

        function changeWeek(delta) {
            weekStart.setDate(weekStart.getDate() + delta * 7);
            loadPlans().then(() => { renderWeek(); renderTable(); });
        }

        function renderWeek() {
            const dates = getWeekDates();
            const m = dates[0].getMonth() + 1;
            const w = Math.ceil(dates[0].getDate() / 7);
            document.getElementById('weekTitle').textContent = `${m}ì›” ${w}ì£¼ì°¨`;
            document.getElementById('weekRange').textContent = `${fmtKR(dates[0])}(ì›”)~${fmtKR(dates[6])}(ì¼)`;
        }

        function renderTable() {
            const dates = getWeekDates();
            const today = fmt(new Date());

            let hHtml = '<tr><th class="subject-col">ê³¼ëª©</th><th class="add-col">+</th><th class="book-col">êµì¬</th>';
            for (let i = 0; i < 7; i++) {
                const d = dates[i];
                const cls = fmt(d) === today ? 'today' : (i === 5 ? 'sat' : (i === 6 ? 'sun' : ''));
                hHtml += `<th class="${cls}"><div class="day-header ${cls}"><div class="day-name">${dayName(i)}</div><div class="day-num">${d.getDate()}</div></div></th>`;
            }
            hHtml += '</tr>';
            document.getElementById('tableHead').innerHTML = hHtml;

            let bHtml = '';
            SUBJECTS.forEach(subject => {
                const sBooks = books.filter(b => b.subject === subject);
                
                if (sBooks.length === 0) {
                    bHtml += `<tr><td class="subject-cell">${subject}</td><td class="add-cell"><button class="add-btn" onclick="openBookModal('${subject}')">+</button></td><td class="book-cell">-</td>`;
                    for (let i = 0; i < 7; i++) bHtml += `<td class="day-cell"><button class="cell-add" onclick="quickAdd('${subject}','${subject}','${fmt(dates[i])}','textbook')">+</button></td>`;
                    bHtml += '</tr>';
                } else {
                    sBooks.forEach((book, idx) => {
                        bHtml += '<tr>';
                        if (idx === 0) {
                            bHtml += `<td class="subject-cell" rowspan="${sBooks.length}">${subject}</td>`;
                            bHtml += `<td class="add-cell" rowspan="${sBooks.length}"><button class="add-btn" onclick="openBookModal('${subject}')">+</button></td>`;
                        }
                        
                        const typeLabel = book.type === 'lecture' ? 'ğŸ¬ ì¸ê°•' : 'ğŸ“– êµì¬';
                        const typeClass = book.type === 'lecture' ? 'lecture' : 'textbook';
                        bHtml += `<td class="book-cell" onpointerdown="startLongPress(event,'${subject}','${book.name}','${book.type||'textbook'}')" onpointerup="endLongPress(event)" onpointerleave="endLongPress(event)">
                            <span class="book-type ${typeClass}">${typeLabel}</span><div class="book-name">${book.name}</div></td>`;
                        
                        for (let i = 0; i < 7; i++) {
                            const dateStr = fmt(dates[i]);
                            const dayPlans = plans.filter(p => p.date === dateStr && p.subject === subject && p.book === book.name);
                            
                            bHtml += '<td class="day-cell">';
                            if (dayPlans.length > 0) {
                                const plan = dayPlans[0];
                                const key = `${subject}-${book.name}-${dateStr}`;
                                const timer = timers[key] || { state: 'idle', elapsed: 0 };
                                const bookType = book.type || 'textbook';
                                
                                const isCompletedLocal = completedToday.some(c => c.key === key);
                                const completedData = completedToday.find(c => c.key === key);
                                
                                // ì˜¤ëŠ˜ ë‚ ì§œì™€ ë¹„êµ (todayëŠ” ì´ë¯¸ ìœ„ì—ì„œ ì •ì˜ë¨)
                                const isPastDate = dateStr < today;
                                
                                let cardCls = '', statusIcon = '';
                                if (plan.status === 'approved' || plan.status === 'O') { cardCls = 'completed'; statusIcon = 'âœ…'; }
                                else if (plan.status === 'failed' || plan.status === 'X' || plan.status === 'rejected') { cardCls = 'failed'; statusIcon = 'âŒ'; }
                                else if (plan.status === 'requested') { cardCls = 'pending'; statusIcon = 'â³'; }
                                else if (isCompletedLocal) { cardCls = 'done-local'; statusIcon = 'âœ”ï¸'; }
                                else if (isPastDate) { cardCls = 'missed'; statusIcon = 'âŒ'; } // ë‚ ì§œ ì§€ë‚¨ + ë¯¸ì™„ë£Œ
                                
                                if (timer.state === 'running') cardCls = 'running';
                                if (timer.state === 'paused') cardCls = 'paused';
                                
                                const isServerComplete = ['approved', 'O', 'requested'].includes(plan.status);
                                const isRunning = timer.state === 'running';
                                const isPaused = timer.state === 'paused';
                                
                                let displaySeconds = timer.elapsed || 0;
                                if (completedData) displaySeconds = completedData.elapsed;
                                else if (plan.actualTime) displaySeconds = plan.actualTime * 60;
                                const timerDisplay = formatTime(displaySeconds);
                                const timerDone = isCompletedLocal || isServerComplete;
                                
                                const startVal = completedData?.startPage || plan.startPage || '';
                                const endVal = completedData?.endPage || plan.endPage || '';
                                const timeVal = completedData ? Math.ceil(completedData.elapsed / 60) : (plan.actualTime || '');
                                
                                const unit = bookType === 'lecture' ? 'ê°•' : 'p';
                                const inputDisabled = isServerComplete ? 'disabled' : '';
                                
                                // ì‚­ì œ ê°€ëŠ¥ ì—¬ë¶€ (ì˜¤ëŠ˜ ë‚ ì§œ + ì„œë²„ì—ì„œ ì™„ë£Œ/ìš”ì²­ ì•ˆ ëœ ê³„íš)
                                const canDelete = !isServerComplete && !isPastDate;
                                
                                bHtml += `<div class="plan-card ${cardCls}" 
                                    oncontextmenu="event.preventDefault(); ${canDelete ? `showPlanMenu(event,'${subject}','${book.name}','${dateStr}')` : ''}"
                                    ontouchstart="${canDelete ? `startPlanLongPress(event,'${subject}','${book.name}','${dateStr}')` : ''}"
                                    ontouchend="endPlanLongPress()"
                                    ontouchcancel="endPlanLongPress()">
                                    <div class="card-top">
                                        <button class="timer-btn play-btn ${isRunning ? 'active' : ''}" onclick="timerPlay('${subject}','${book.name}','${dateStr}')" ${isServerComplete || isCompletedLocal || isRunning ? 'disabled' : ''}><i class="fas fa-play"></i></button>
                                        <button class="timer-btn pause-btn ${isPaused ? 'active' : ''}" onclick="timerPause('${subject}','${book.name}','${dateStr}')" ${isServerComplete || isCompletedLocal || timer.state === 'idle' ? 'disabled' : ''}><i class="fas fa-pause"></i></button>
                                        <button class="timer-btn stop-btn" onclick="timerStop('${subject}','${book.name}','${dateStr}','${bookType}')" ${isServerComplete || isCompletedLocal ? 'disabled' : ''}><i class="fas fa-check"></i></button>
                                        <span class="card-timer ${timerDone ? 'done' : ''}" id="timer-${key}">${timerDisplay}</span>
                                        <span class="card-status">${statusIcon}</span>
                                    </div>
                                    <div class="card-bottom">
                                        <div class="card-inputs">
                                            <span class="input-label">${unit}</span>
                                            <input class="card-input" value="${startVal}" placeholder="-" ${inputDisabled} onchange="updateInput('${key}','${dateStr}','${subject}','${book.name}','start',this.value)">
                                            <span class="input-sep">~</span>
                                            <input class="card-input" value="${endVal}" placeholder="-" ${inputDisabled} onchange="updateInput('${key}','${dateStr}','${subject}','${book.name}','end',this.value)">
                                            <span class="input-sep">|</span>
                                            <input class="card-input time-input" value="${timeVal}" placeholder="ë¶„" ${inputDisabled} onchange="updateInput('${key}','${dateStr}','${subject}','${book.name}','time',this.value)">
                                            <span class="input-label">ë¶„</span>
                                        </div>
                                    </div>
                                </div>`;
                            } else {
                                bHtml += `<button class="cell-add" onclick="quickAdd('${subject}','${book.name}','${dateStr}','${book.type||'textbook'}')">+</button>`;
                            }
                            bHtml += '</td>';
                        }
                        bHtml += '</tr>';
                    });
                }
            });
            document.getElementById('tableBody').innerHTML = bHtml;
        }

        function formatTime(seconds) {
            const m = Math.floor(seconds / 60), s = seconds % 60;
            return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        }

        function updateInput(key, dateStr, subject, book, type, value) {
            const plan = plans.find(p => p.date === dateStr && p.subject === subject && p.book === book);
            if (!plan) return;
            
            if (type === 'start') plan.startPage = value;
            else if (type === 'end') plan.endPage = value;
            else if (type === 'time') plan.actualTime = parseInt(value) || 0;
            
            const completed = completedToday.find(c => c.key === key);
            if (completed) {
                if (type === 'start') completed.startPage = value;
                else if (type === 'end') completed.endPage = value;
                else if (type === 'time') completed.elapsed = (parseInt(value) || 0) * 60;
            }
            
            api({ action: 'updatePlanPage', floor: user.floor, name: user.name, date: dateStr, subject, bookName: book, startPage: plan.startPage, endPage: plan.endPage, actualTime: plan.actualTime });
            updateCheckBar();
        }

        async function quickAdd(subject, book, dateStr, bookType) {
            if (plans.some(p => p.date === dateStr && p.subject === subject && p.book === book)) {
                toast('âš ï¸ ì´ë¯¸ ê³„íšì´ ìˆìŠµë‹ˆë‹¤', 'warning'); return;
            }
            const res = await api({ action: 'addPlan', floor: user.floor, name: user.name, date: dateStr, subject, bookName: book, time: 60, bookType });
            if (res.success) { plans.push({ date: dateStr, subject, book, status: 'pending' }); renderTable(); toast('âœ… ê³„íš ì¶”ê°€ë¨', 'success'); }
        }

        function timerPlay(subject, book, dateStr) {
            const key = `${subject}-${book}-${dateStr}`;
            if (!timers[key]) timers[key] = { state: 'idle', elapsed: 0, start: null, interval: null };
            const timer = timers[key];
            if (timer.state === 'running') return;
            
            timer.state = 'running';
            timer.start = Date.now() - timer.elapsed * 1000;
            timer.interval = setInterval(() => {
                timer.elapsed = Math.floor((Date.now() - timer.start) / 1000);
                const el = document.getElementById(`timer-${key}`);
                if (el) el.textContent = formatTime(timer.elapsed);
            }, 1000);
            renderTable(); toast('â±ï¸ í•™ìŠµ ì‹œì‘!');
            
            // ì‹¤ì‹œê°„ ìƒíƒœ ì—…ë°ì´íŠ¸
            updateLiveStatusAPI('studying', subject);
        }
        
        function timerPause(subject, book, dateStr) {
            const key = `${subject}-${book}-${dateStr}`;
            const timer = timers[key];
            if (!timer || timer.state !== 'running') return;
            clearInterval(timer.interval); timer.interval = null; timer.state = 'paused';
            renderTable(); toast('â¸ï¸ ì¼ì‹œì •ì§€');
            
            // ì‹¤ì‹œê°„ ìƒíƒœ ì—…ë°ì´íŠ¸
            updateLiveStatusAPI('idle', '');
        }
        
        function timerStop(subject, book, dateStr, bookType) {
            const key = `${subject}-${book}-${dateStr}`;
            const timer = timers[key] || { state: 'idle', elapsed: 0 };
            const plan = plans.find(p => p.date === dateStr && p.subject === subject && p.book === book);
            
            if (timer.interval) { clearInterval(timer.interval); timer.interval = null; }
            
            // íƒ€ì´ë¨¸ ì‹œê°„ ë˜ëŠ” ì§ì ‘ ì…ë ¥í•œ ì‹œê°„ ì‚¬ìš©
            let elapsed = timer.elapsed || 0;
            if (elapsed === 0 && plan?.actualTime) elapsed = plan.actualTime * 60;
            
            const startPage = plan?.startPage || '';
            const endPage = plan?.endPage || '';
            
            // ì™„ë£Œ ëª©ë¡ì— ì¶”ê°€ (ê²€ì¦ì€ ê²€ì‚¬ìš”ì²­ ì‹œ)
            const existing = completedToday.findIndex(c => c.key === key);
            const data = { key, subject, book, dateStr, elapsed, bookType, startPage, endPage };
            
            if (existing >= 0) completedToday[existing] = data;
            else completedToday.push(data);
            
            timers[key] = { state: 'idle', elapsed: elapsed, start: null, interval: null };
            renderTable(); updateCheckBar(); 
            toast('âœ”ï¸ ì™„ë£Œ! ê²€ì‚¬ ìš”ì²­ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”', 'success');
            
            // ì‹¤ì‹œê°„ ìƒíƒœ ì—…ë°ì´íŠ¸ (ì˜¤ëŠ˜ ì´ ì‹œê°„ ê³„ì‚°)
            const todayTotalMin = completedToday.reduce((sum, c) => sum + Math.ceil(c.elapsed / 60), 0);
            updateLiveStatusAPI('idle', '', todayTotalMin);
        }
        
        // ì‹¤ì‹œê°„ ìƒíƒœ ì—…ë°ì´íŠ¸ API (ë¹„ë™ê¸°)
        async function updateLiveStatusAPI(status, subject, todayTime = 0) {
            try {
                await api({
                    action: 'updateLiveStatus',
                    floor: user.floor,
                    name: user.name,
                    status: status,
                    subject: subject,
                    todayTime: todayTime
                });
            } catch (e) {
                console.log('Live status update failed:', e);
            }
        }

        function handlePhoto(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    currentPhotoData = e.target.result;
                    document.getElementById('photoPreview').innerHTML = `<img src="${currentPhotoData}" alt="ì¸ì¦ì‚¬ì§„">`;
                    document.getElementById('photoPreview').classList.add('has-photo');
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function updateCheckBar() {
            const count = completedToday.length;
            const totalMin = completedToday.reduce((sum, c) => sum + Math.ceil(c.elapsed / 60), 0);
            document.getElementById('checkBarStatus').textContent = `ì™„ë£Œ: ${count}ê°œ Â· ${totalMin}ë¶„`;
            document.getElementById('requestCheckBtn').disabled = count === 0;
            document.getElementById('cancelCheckBtn').style.display = count > 0 ? 'inline-flex' : 'none';
        }

        function openCheckModal() {
            if (completedToday.length === 0) return;
            
            // ìµœì‹  plan ë°ì´í„°ë¡œ ì—…ë°ì´íŠ¸
            completedToday.forEach(c => {
                const plan = plans.find(p => p.date === c.dateStr && p.subject === c.subject && p.book === c.book);
                if (plan) {
                    c.startPage = c.startPage || plan.startPage || '';
                    c.endPage = c.endPage || plan.endPage || '';
                    if (c.elapsed === 0 && plan.actualTime) c.elapsed = plan.actualTime * 60;
                }
            });
            
            let html = '', totalSec = 0, hasWarning = false;
            completedToday.forEach(c => {
                const range = c.bookType === 'lecture' ? `${c.startPage || '?'}ê°•~${c.endPage || '?'}ê°•` : `p.${c.startPage || '?'}~${c.endPage || '?'}`;
                const mins = Math.ceil(c.elapsed / 60);
                const warning = (!c.startPage || !c.endPage || c.elapsed === 0);
                if (warning) hasWarning = true;
                
                html += `<div class="check-item ${warning ? 'warning' : ''}">
                    <div>
                        <span class="subject">${c.subject}</span>
                        <span style="color:#888;font-size:0.8rem;"> Â· ${c.book}</span>
                        <div style="font-size:0.75rem;color:${warning ? '#f59e0b' : '#888'};">${range} ${warning ? 'âš ï¸' : ''}</div>
                    </div>
                    <span class="time">${mins > 0 ? mins + 'ë¶„' : '?ë¶„'}</span>
                </div>`;
                totalSec += c.elapsed;
            });
            
            const totalMin = Math.ceil(totalSec / 60);
            const h = Math.floor(totalMin / 60), m = totalMin % 60;
            html += `<div class="check-total">ì´ ${h > 0 ? h + 'ì‹œê°„ ' : ''}${m}ë¶„</div>`;
            
            if (hasWarning) {
                html += `<div style="color:#f59e0b;font-size:0.8rem;text-align:center;margin-top:10px;">âš ï¸ í˜ì´ì§€/ì‹œê°„ì´ ë¹„ì–´ìˆëŠ” í•­ëª©ì´ ìˆìŠµë‹ˆë‹¤</div>`;
            }
            
            document.getElementById('checkSummary').innerHTML = html;
            currentPhotoData = null;
            document.getElementById('photoPreview').innerHTML = '<i class="fas fa-camera"></i><span>í„°ì¹˜í•˜ì—¬ ì‚¬ì§„ ì´¬ì˜</span>';
            document.getElementById('photoPreview').classList.remove('has-photo');
            document.getElementById('checkModal').classList.add('active');
        }

        async function closeCheckModal(confirm) {
            document.getElementById('checkModal').classList.remove('active');
            if (!confirm || completedToday.length === 0) return;
            for (const c of completedToday) {
                await api({ 
                    action: 'requestCheck', 
                    floor: user.floor, 
                    name: user.name, 
                    date: c.dateStr, 
                    subject: c.subject, 
                    bookName: c.book, 
                    actualTime: Math.ceil(c.elapsed / 60), 
                    startPage: c.startPage, 
                    endPage: c.endPage, 
                    bookType: c.bookType,
                    photoData: currentPhotoData 
                });
            }
            completedToday = []; currentPhotoData = null;
            await loadPlans(); renderTable(); updateMood(); updateCheckBar();
            toast('ğŸ”” ê²€ì‚¬ ìš”ì²­ ì™„ë£Œ!', 'success');
        }

        function cancelAllChecks() {
            if (completedToday.length === 0) return;
            if (confirm('ì™„ë£Œëœ í•™ìŠµ ê¸°ë¡ì„ ëª¨ë‘ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                completedToday.forEach(c => { timers[c.key] = { state: 'idle', elapsed: 0, start: null, interval: null }; });
                completedToday = []; renderTable(); updateCheckBar(); toast('í•™ìŠµ ê¸°ë¡ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤');
            }
        }

        function startLongPress(e, subject, name, type) {
            longPressTimer = setTimeout(() => { selectedBook = { subject, name, type }; showContextMenu(e.clientX, e.clientY); longPressTimer = null; }, 500);
        }
        function endLongPress(e) { if (longPressTimer) { clearTimeout(longPressTimer); longPressTimer = null; } if (contextMenuJustOpened) { e.preventDefault(); e.stopPropagation(); } }
        function showContextMenu(x, y) {
            const menu = document.getElementById('contextMenu');
            menu.style.left = Math.min(x, window.innerWidth - 160) + 'px';
            menu.style.top = Math.min(y, window.innerHeight - 120) + 'px';
            menu.classList.add('active'); contextMenuJustOpened = true;
            if (navigator.vibrate) navigator.vibrate(50);
        }
        function hideContextMenu() { 
            document.getElementById('contextMenu').classList.remove('active'); 
            document.getElementById('planMenu').classList.remove('active');
            contextMenuJustOpened = false; 
        }
        
        // ê³„íš ì‚­ì œ ê´€ë ¨ í•¨ìˆ˜
        function startPlanLongPress(e, subject, book, dateStr) {
            planLongPressTimer = setTimeout(() => {
                selectedPlan = { subject, book, dateStr };
                showPlanMenu(e.touches ? e.touches[0].clientX : e.clientX, e.touches ? e.touches[0].clientY : e.clientY);
                planLongPressTimer = null;
            }, 500);
        }
        
        function endPlanLongPress() {
            if (planLongPressTimer) {
                clearTimeout(planLongPressTimer);
                planLongPressTimer = null;
            }
        }
        
        function showPlanMenu(eOrX, y) {
            let x = eOrX, yPos = y;
            if (typeof eOrX === 'object') {
                // event object
                selectedPlan = { 
                    subject: arguments[1], 
                    book: arguments[2], 
                    dateStr: arguments[3] 
                };
                x = eOrX.clientX || eOrX.touches?.[0]?.clientX || 100;
                yPos = eOrX.clientY || eOrX.touches?.[0]?.clientY || 100;
            }
            const menu = document.getElementById('planMenu');
            menu.style.left = Math.min(x, window.innerWidth - 160) + 'px';
            menu.style.top = Math.min(yPos, window.innerHeight - 80) + 'px';
            menu.classList.add('active');
            contextMenuJustOpened = true;
            if (navigator.vibrate) navigator.vibrate(50);
        }
        
        async function deletePlan() {
            hideContextMenu();
            if (!selectedPlan) return;
            
            if (!confirm('ì´ ê³„íšì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                selectedPlan = null;
                return;
            }
            
            const res = await api({
                action: 'deletePlan',
                floor: user.floor,
                name: user.name,
                date: selectedPlan.dateStr,
                subject: selectedPlan.subject,
                bookName: selectedPlan.book
            });
            
            if (res.success) {
                plans = plans.filter(p => !(
                    p.date === selectedPlan.dateStr && 
                    p.subject === selectedPlan.subject && 
                    p.book === selectedPlan.book
                ));
                renderTable();
                toast('ğŸ—‘ï¸ ê³„íšì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            } else {
                toast('ì‚­ì œ ì‹¤íŒ¨', 'warning');
            }
            selectedPlan = null;
        }
        
        function editBook() {
            hideContextMenu(); if (!selectedBook) return;
            editMode = true; editingBookData = { ...selectedBook };
            document.getElementById('bookModalTitle').textContent = 'âœï¸ êµì¬ ìˆ˜ì •';
            document.getElementById('bookSubject').value = selectedBook.subject;
            document.getElementById('bookSubject').disabled = true;
            document.getElementById('bookName').value = selectedBook.name;
            document.getElementById(selectedBook.type === 'lecture' ? 'typeLecture' : 'typeTextbook').checked = true;
            document.getElementById('bookModal').classList.add('active');
        }
        
        async function deleteBook() {
            hideContextMenu(); if (!selectedBook) return;
            if (!confirm(`"${selectedBook.name}" êµì¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            const res = await api({ action: 'deleteBook', floor: user.floor, name: user.name, subject: selectedBook.subject, bookName: selectedBook.name });
            if (res.success) { books = books.filter(b => !(b.subject === selectedBook.subject && b.name === selectedBook.name)); renderTable(); toast('ğŸ—‘ï¸ ì‚­ì œë¨', 'success'); }
            else toast('ì‚­ì œ ì‹¤íŒ¨');
            selectedBook = null;
        }

        function openBookModal(subject) {
            editMode = false; editingBookData = null;
            document.getElementById('bookModalTitle').textContent = 'ğŸ“š êµì¬/ì¸ê°• ì¶”ê°€';
            document.getElementById('bookSubject').value = subject || '';
            document.getElementById('bookSubject').disabled = false;
            document.getElementById('bookName').value = '';
            document.getElementById('typeTextbook').checked = true;
            document.getElementById('bookModal').classList.add('active');
        }

        function closeBookModal() {
            document.getElementById('bookModal').classList.remove('active');
            editMode = false; editingBookData = null; selectedBook = null;
            document.getElementById('bookSubject').disabled = false;
        }

        async function saveBook() {
            const subject = document.getElementById('bookSubject').value;
            const name = document.getElementById('bookName').value.trim();
            const type = document.querySelector('input[name="bookType"]:checked').value;
            if (!subject || !name) return toast('ê³¼ëª©ê³¼ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”', 'warning');
            
            if (editMode && editingBookData) {
                const res = await api({ action: 'updateBook', floor: user.floor, name: user.name, subject: editingBookData.subject, oldBookName: editingBookData.name, newBookName: name, bookType: type });
                if (res.success) {
                    const idx = books.findIndex(b => b.subject === editingBookData.subject && b.name === editingBookData.name);
                    if (idx >= 0) { books[idx].name = name; books[idx].type = type; }
                    closeBookModal(); renderTable(); toast('âœï¸ ìˆ˜ì •ë¨', 'success');
                } else toast('ìˆ˜ì • ì‹¤íŒ¨');
            } else {
                const res = await api({ action: 'addBook', floor: user.floor, name: user.name, subject, bookName: name, bookType: type });
                if (res.success) { books.push({ subject, name, type }); closeBookModal(); renderTable(); toast(type === 'lecture' ? 'ğŸ¬ ì¸ê°• ì¶”ê°€ë¨' : 'ğŸ“š êµì¬ ì¶”ê°€ë¨', 'success'); }
            }
        }

        async function updateMood() {
            const res = await api({ action: 'getRecords', floor: user.floor, name: user.name, date: fmt(new Date()) });
            if (res.success) {
                const totalTime = (res.records || []).filter(r => ['approved', 'O', 'requested'].includes(r.status)).reduce((sum, r) => sum + (r.actualTime || 0), 0);
                document.getElementById('mood').textContent = totalTime >= 480 ? 'ğŸ”¥' : totalTime >= 240 ? 'ğŸ˜Š' : totalTime >= 60 ? 'ğŸ™‚' : totalTime > 0 ? 'ğŸ’ª' : 'ğŸ˜´';
            }
        }

        function toggleStats() {
            const panel = document.getElementById('statsPanel');
            panel.classList.toggle('active');
            if (panel.classList.contains('active')) loadStats();
        }

        async function loadStats() {
            const res = await api({ action: 'getStats', floor: user.floor, name: user.name });
            if (res.success) {
                const s = res.stats;
                document.getElementById('statTotal').textContent = s.totalPlans || 0;
                document.getElementById('statDone').textContent = s.completed || 0;
                document.getElementById('statTime').textContent = (s.totalTimeHours || 0) + 'h';
                document.getElementById('statRate').textContent = (s.rate || 0) + '%';
            }
        }

        async function captureShare() {
            try {
                toast('ğŸ“¸ ìº¡ì²˜ ì¤‘...');
                const captureArea = document.getElementById('captureArea');
                const captureHeader = document.getElementById('captureHeader');
                const wrapper = document.querySelector('.table-wrapper');
                const table = document.querySelector('.plan-table');
                const dates = getWeekDates();
                
                // í—¤ë”ì— ì •ë³´ í‘œì‹œ
                const weekNum = Math.ceil(dates[0].getDate() / 7);
                document.getElementById('captureInfo').textContent = `${user.name} Â· ${user.floor} Â· ${dates[0].getMonth()+1}ì›” ${weekNum}ì£¼ì°¨ (${dates[0].getMonth()+1}/${dates[0].getDate()}~${dates[6].getMonth()+1}/${dates[6].getDate()})`;
                
                // ìº¡ì²˜ ëª¨ë“œ ì„¤ì •
                captureHeader.classList.add('visible');
                captureArea.classList.add('capture-mode');
                
                // ì›ë³¸ ìŠ¤íƒ€ì¼ ì €ì¥
                const origWrapperOverflow = wrapper.style.overflow;
                const origWrapperHeight = wrapper.style.height;
                const origWrapperWidth = wrapper.style.width;
                const origTableMinWidth = table.style.minWidth;
                const origScrollLeft = wrapper.scrollLeft;
                const origScrollTop = wrapper.scrollTop;
                
                // ì „ì²´ ë³´ì´ë„ë¡ ìŠ¤íƒ€ì¼ ë³€ê²½
                wrapper.style.overflow = 'visible';
                wrapper.style.height = 'auto';
                wrapper.style.width = 'auto';
                wrapper.scrollLeft = 0;
                wrapper.scrollTop = 0;
                
                await new Promise(r => setTimeout(r, 200));
                
                // ìº¡ì²˜ ì‹¤í–‰
                const canvas = await html2canvas(captureArea, { 
                    backgroundColor: '#ffffff', 
                    scale: 2, 
                    useCORS: true,
                    scrollX: 0,
                    scrollY: 0,
                    windowWidth: table.scrollWidth + 50,
                    windowHeight: table.scrollHeight + 150
                });
                
                // ì›ë³¸ ìŠ¤íƒ€ì¼ ë³µì›
                captureHeader.classList.remove('visible');
                captureArea.classList.remove('capture-mode');
                wrapper.style.overflow = origWrapperOverflow;
                wrapper.style.height = origWrapperHeight;
                wrapper.style.width = origWrapperWidth;
                wrapper.scrollLeft = origScrollLeft;
                wrapper.scrollTop = origScrollTop;
                
                // í´ë¦½ë³´ë“œì— ë³µì‚¬ ë˜ëŠ” ë‹¤ìš´ë¡œë“œ
                canvas.toBlob(async blob => {
                    try { 
                        await navigator.clipboard.write([new ClipboardItem({'image/png': blob})]); 
                        toast('ğŸ“‹ ë³µì‚¬ ì™„ë£Œ! ì¹´í†¡ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”', 'success'); 
                    }
                    catch { 
                        const a = document.createElement('a'); 
                        a.href = URL.createObjectURL(blob); 
                        a.download = `${user.name}_ì£¼ê°„ê³„íší‘œ_${dates[0].getMonth()+1}ì›”${weekNum}ì£¼.png`; 
                        a.click(); 
                        toast('ğŸ“¥ ì´ë¯¸ì§€ ì €ì¥ë¨', 'success'); 
                    }
                }, 'image/png');
            } catch (e) { 
                console.error(e); 
                toast('ìº¡ì²˜ ì‹¤íŒ¨', 'error'); 
            }
        }

        // ========== ì—°ì† í•™ìŠµì¼ & ëˆ„ì  ì‹œê°„ ==========
        async function updateStreakAndTotal() {
            try {
                const res = await api({ 
                    action: 'getStreakAndTotal', 
                    floor: user.floor, 
                    name: user.name 
                });
                
                if (res.success) {
                    document.getElementById('streakDays').textContent = res.streak || 0;
                    const totalHours = ((res.totalTime || 0) / 60).toFixed(1);
                    document.getElementById('totalStudyTime').textContent = totalHours + 'h';
                } else {
                    // API ì—†ìœ¼ë©´ í˜„ì¬ ë°ì´í„°ë¡œ ê³„ì‚°
                    calculateStreakFromPlans();
                }
            } catch (e) {
                console.log('Streak API failed, using local calculation');
                calculateStreakFromPlans();
            }
        }
        
        function calculateStreakFromPlans() {
            // í˜„ì¬ plans ë°ì´í„°ë¡œ ê°„ë‹¨íˆ ê³„ì‚°
            const completed = plans.filter(p => ['approved', 'O'].includes(p.status));
            
            // ëˆ„ì  ì‹œê°„
            const totalMin = completed.reduce((sum, p) => sum + (p.actualTime || 0), 0);
            document.getElementById('totalStudyTime').textContent = (totalMin / 60).toFixed(1) + 'h';
            
            // ì—°ì† í•™ìŠµì¼ (ê°„ë‹¨ ë²„ì „: ì˜¤ëŠ˜ë¶€í„° ê±°ê¾¸ë¡œ)
            const today = new Date();
            let streak = 0;
            let checkDate = new Date(today);
            
            const completedDates = new Set(completed.map(p => p.date));
            
            for (let i = 0; i < 365; i++) {
                const dateStr = fmt(checkDate);
                if (completedDates.has(dateStr)) {
                    streak++;
                    checkDate.setDate(checkDate.getDate() - 1);
                } else if (i === 0) {
                    // ì˜¤ëŠ˜ ì•„ì§ ì•ˆ í–ˆìœ¼ë©´ ì–´ì œë¶€í„° ì²´í¬
                    checkDate.setDate(checkDate.getDate() - 1);
                } else {
                    break;
                }
            }
            
            document.getElementById('streakDays').textContent = streak;
        }

        // ========== í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ==========
        function switchNav(tab) {
            document.querySelectorAll('.nav-item').forEach((item, idx) => {
                item.classList.toggle('active', 
                    (tab === 'planner' && idx === 0) ||
                    (tab === 'ranking' && idx === 1) ||
                    (tab === 'mystats' && idx === 2) ||
                    (tab === 'live' && idx === 3)
                );
            });
            
            if (tab === 'planner') {
                // ëª¨ë“  ëª¨ë‹¬ ë‹«ê¸°
                closeModal('rankingModal');
                closeModal('mystatsModal');
                closeModal('liveModal');
            } else if (tab === 'ranking') {
                openModal('rankingModal');
                loadRanking();
            } else if (tab === 'mystats') {
                openModal('mystatsModal');
                loadMyStats();
            } else if (tab === 'live') {
                openModal('liveModal');
                loadLiveStatus();
            }
        }
        
        function openModal(id) {
            document.getElementById(id).classList.add('show');
        }
        
        function closeModal(id) {
            document.getElementById(id).classList.remove('show');
            // í”Œë˜ë„ˆ íƒ­ í™œì„±í™”
            document.querySelectorAll('.nav-item').forEach((item, idx) => {
                item.classList.toggle('active', idx === 0);
            });
        }

        // ========== ë­í‚¹ ë¡œë“œ ==========
        async function loadRanking() {
            const timeList = document.getElementById('timeRankingList');
            const completeList = document.getElementById('completeRankingList');
            
            timeList.innerHTML = '<li style="padding:20px;text-align:center;color:#888;"><i class="fas fa-spinner fa-spin"></i> ë¡œë”©ì¤‘...</li>';
            completeList.innerHTML = '<li style="padding:20px;text-align:center;color:#888;"><i class="fas fa-spinner fa-spin"></i> ë¡œë”©ì¤‘...</li>';
            
            try {
                // ì˜¤ëŠ˜ ê¸°ë¡ ê°€ì ¸ì˜¤ê¸° (ì „ì²´ í•™ìƒ)
                const res = await api({ action: 'getTodayRanking', floor: user.floor });
                
                if (res.success && res.rankings) {
                    const rankings = res.rankings;
                    
                    // í•™ìŠµì‹œê°„ ìˆœ ì •ë ¬
                    const byTime = [...rankings].sort((a, b) => (b.totalTime || 0) - (a.totalTime || 0)).slice(0, 10);
                    // ì™„ë£Œ ê³¼ëª© ìˆœ ì •ë ¬
                    const byComplete = [...rankings].sort((a, b) => (b.completed || 0) - (a.completed || 0)).slice(0, 10);
                    
                    timeList.innerHTML = byTime.length > 0 ? byTime.map((r, i) => renderRankItem(r, i, 'time')).join('') 
                        : '<li style="padding:20px;text-align:center;color:#888;">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</li>';
                    completeList.innerHTML = byComplete.length > 0 ? byComplete.map((r, i) => renderRankItem(r, i, 'complete')).join('') 
                        : '<li style="padding:20px;text-align:center;color:#888;">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</li>';
                } else {
                    // API ì—†ìœ¼ë©´ ì„ì‹œ ë°ì´í„°
                    timeList.innerHTML = '<li style="padding:20px;text-align:center;color:#888;">ë­í‚¹ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</li>';
                    completeList.innerHTML = '<li style="padding:20px;text-align:center;color:#888;">ë­í‚¹ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</li>';
                }
            } catch (e) {
                console.error(e);
                timeList.innerHTML = '<li style="padding:20px;text-align:center;color:#888;">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</li>';
            }
        }
        
        function renderRankItem(r, i, type) {
            const rankClass = i < 3 ? `rank-${i+1}` : 'rank-other';
            const isMe = r.name === user.name;
            const value = type === 'time' ? `${r.totalTime || 0}<small>ë¶„</small>` : `${r.completed || 0}<small>ê°œ</small>`;
            
            return `
            <li class="ranking-item">
                <span class="rank-badge ${rankClass}">${i + 1}</span>
                <div class="rank-info">
                    <div class="rank-name ${isMe ? 'me' : ''}">${r.name}${isMe ? ' (ë‚˜)' : ''}</div>
                    <div class="rank-floor">${r.floor || user.floor}</div>
                </div>
                <div class="rank-value">${value}</div>
            </li>`;
        }

        // ========== ë‚´ í†µê³„ ë¡œë“œ ==========
        async function loadMyStats() {
            const subjectBars = document.getElementById('subjectBars');
            
            // ì—°ì† í•™ìŠµì¼ & ëˆ„ì  ì‹œê°„ í‘œì‹œ (ìƒë‹¨ ë°”ì—ì„œ ì´ë¯¸ ê³„ì‚°ë¨)
            document.getElementById('myStreakDays').textContent = document.getElementById('streakDays').textContent;
            document.getElementById('myTotalTime').textContent = document.getElementById('totalStudyTime').textContent;
            
            try {
                // ì´ë²ˆ ì£¼ ë‚´ ê¸°ë¡ ê°€ì ¸ì˜¤ê¸°
                const weekDates = getWeekDates();
                const weekStart = fmt(weekDates[0]);
                const weekEnd = fmt(weekDates[6]);
                
                // ì´ë²ˆ ì£¼ ê³„íšê³¼ ì™„ë£Œ ë°ì´í„° ì§‘ê³„
                let weekPlanned = 0;
                let weekCompleted = 0;
                let weekTime = 0;
                const subjectTime = {};
                
                // í˜„ì¬ ë¡œë“œëœ plansì—ì„œ ì´ë²ˆ ì£¼ ë°ì´í„° ì§‘ê³„
                plans.forEach(p => {
                    if (p.date >= weekStart && p.date <= weekEnd) {
                        weekPlanned++;
                        if (['approved', 'O'].includes(p.status)) {
                            weekCompleted++;
                            const time = p.actualTime || 0;
                            weekTime += time;
                            if (!subjectTime[p.subject]) subjectTime[p.subject] = 0;
                            subjectTime[p.subject] += time;
                        }
                    }
                });
                
                // completedToday ì¶”ê°€
                completedToday.forEach(c => {
                    if (!subjectTime[c.subject]) subjectTime[c.subject] = 0;
                    subjectTime[c.subject] += Math.ceil(c.elapsed / 60);
                    weekTime += Math.ceil(c.elapsed / 60);
                });
                
                const weekRate = weekPlanned > 0 ? Math.round(weekCompleted / weekPlanned * 100) : 0;
                
                document.getElementById('myWeekCompleted').textContent = weekCompleted;
                document.getElementById('myWeekTime').textContent = (weekTime / 60).toFixed(1) + 'h';
                document.getElementById('myWeekRate').textContent = weekRate + '%';
                
                // ê³¼ëª©ë³„ ë§‰ëŒ€ ê·¸ë˜í”„
                const maxTime = Math.max(...Object.values(subjectTime), 1);
                const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4'];
                
                if (Object.keys(subjectTime).length === 0) {
                    subjectBars.innerHTML = '<div style="text-align:center;color:#888;padding:20px;">ì•„ì§ í•™ìŠµ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                } else {
                    subjectBars.innerHTML = Object.entries(subjectTime).map(([subj, time], i) => {
                        const pct = Math.round(time / maxTime * 100);
                        const hours = (time / 60).toFixed(1);
                        return `
                        <div class="subject-bar">
                            <span class="subject-bar-name">${subj}</span>
                            <div class="subject-bar-track">
                                <div class="subject-bar-fill" style="width:${pct}%;background:${colors[i % colors.length]}">${time}ë¶„</div>
                            </div>
                            <span class="subject-bar-time">${hours}h</span>
                        </div>`;
                    }).join('');
                }
            } catch (e) {
                console.error(e);
            }
        }

        // ========== ì‹¤ì‹œê°„ í˜„í™© ë¡œë“œ ==========
        async function loadLiveStatus() {
            const liveList = document.getElementById('liveList');
            const liveCount = document.getElementById('liveStudyingCount');
            const liveBadge = document.getElementById('liveBadge');
            
            liveList.innerHTML = '<div style="padding:20px;text-align:center;color:#888;"><i class="fas fa-spinner fa-spin"></i> ë¡œë”©ì¤‘...</div>';
            
            try {
                const res = await api({ action: 'getLiveStatus', floor: user.floor });
                
                if (res.success && res.students) {
                    const students = res.students;
                    const studying = students.filter(s => s.isStudying);
                    
                    liveCount.textContent = studying.length;
                    
                    if (liveBadge) {
                        if (studying.length > 0) {
                            liveBadge.textContent = studying.length;
                            liveBadge.style.display = 'block';
                        } else {
                            liveBadge.style.display = 'none';
                        }
                    }
                    
                    if (students.length === 0) {
                        liveList.innerHTML = '<div style="padding:20px;text-align:center;color:#888;">ë“±ë¡ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤</div>';
                    } else {
                        // ê³µë¶€ì¤‘ì¸ í•™ìƒ ë¨¼ì €, ê·¸ ë‹¤ìŒ ëŒ€ê¸°ì¤‘
                        const sorted = [...students].sort((a, b) => (b.isStudying ? 1 : 0) - (a.isStudying ? 1 : 0));
                        
                        liveList.innerHTML = sorted.map(s => {
                            const isMe = s.name === user.name;
                            return `
                            <div class="live-card">
                                <div class="live-status ${s.isStudying ? 'studying' : ''}"></div>
                                <div class="live-info">
                                    <div class="live-name">${s.name}${isMe ? ' (ë‚˜)' : ''}</div>
                                    <div class="live-detail">${s.isStudying ? s.currentSubject + ' ê³µë¶€ì¤‘' : 'ëŒ€ê¸°ì¤‘'}</div>
                                </div>
                                <div class="live-time ${s.isStudying ? 'active' : ''}">${s.todayTime || 0}ë¶„</div>
                            </div>`;
                        }).join('');
                    }
                } else {
                    // API ì—†ìœ¼ë©´ í˜„ì¬ ì¸µ í•™ìƒë“¤ë§Œ í‘œì‹œ
                    liveCount.textContent = '?';
                    liveList.innerHTML = '<div style="padding:20px;text-align:center;color:#888;">ì‹¤ì‹œê°„ í˜„í™©ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>';
                }
            } catch (e) {
                console.error(e);
                liveList.innerHTML = '<div style="padding:20px;text-align:center;color:#888;">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</div>';
            }
        }

        function toast(msg, type = '') {
            const t = document.getElementById('toast');
            t.textContent = msg; t.className = 'toast' + (type ? ` ${type}` : '');
            t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2500);
        }
        // ========== ë„¤ë¹„ê²Œì´ì…˜ ìˆ˜ì • ==========
function switchNav(tab) {
    document.querySelectorAll('.nav-item').forEach((item, idx) => {
        item.classList.toggle('active', 
            (tab === 'planner' && idx === 0) ||
            (tab === 'care' && idx === 1) ||
            (tab === 'ranking' && idx === 2) ||
            (tab === 'more' && idx === 3)
        );
    });
    
    if (tab === 'planner') {
        closeModal('careModal');
        closeModal('rankingModal');
        closeModal('moreModal');
        closeModal('mystatsModal');
        closeModal('liveModal');
    } else if (tab === 'care') {
        openModal('careModal');
        loadSavedCondition();
    } else if (tab === 'ranking') {
        openModal('rankingModal');
        loadRanking();
    } else if (tab === 'more') {
        openModal('moreModal');
    }
}

// ========== ì»¨ë””ì…˜(ì—„ë§ˆì†ì¼€ì–´) ==========
let conditionData = {
    sleepHours: 7,
    sleepQuality: 3,
    condition: 5,
    stress: 1,
    symptoms: ['none'],
    breakfast: 2
};

function setupCareListeners() {
    // ì»¨ë””ì…˜ ìŠ¬ë¼ì´ë”
    const slider = document.getElementById('conditionSlider');
    if (slider) {
        slider.addEventListener('input', function() {
            document.getElementById('conditionValue').textContent = this.value;
            conditionData.condition = parseInt(this.value);
        });
    }
    
    // ì´ëª¨ì§€ ë²„íŠ¼ë“¤
    ['sleepQuality', 'stressLevel', 'breakfast'].forEach(groupId => {
        document.querySelectorAll(`#${groupId} .emoji-btn`).forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll(`#${groupId} .emoji-btn`).forEach(b => b.classList.remove('selected'));
                this.classList.add('selected');
                const value = parseInt(this.dataset.value);
                if (groupId === 'sleepQuality') conditionData.sleepQuality = value;
                else if (groupId === 'stressLevel') conditionData.stress = value;
                else if (groupId === 'breakfast') conditionData.breakfast = value;
            });
        });
    });
    
    // ì¦ìƒ íƒœê·¸
    document.querySelectorAll('#symptoms .symptom-tag').forEach(tag => {
        tag.addEventListener('click', function() {
            const symptom = this.dataset.symptom;
            if (symptom === 'none') {
                document.querySelectorAll('#symptoms .symptom-tag').forEach(t => t.classList.remove('selected'));
                this.classList.add('selected');
                conditionData.symptoms = ['none'];
            } else {
                document.querySelector('#symptoms .symptom-tag[data-symptom="none"]').classList.remove('selected');
                this.classList.toggle('selected');
                conditionData.symptoms = Array.from(document.querySelectorAll('#symptoms .symptom-tag.selected'))
                    .map(t => t.dataset.symptom).filter(s => s !== 'none');
                if (conditionData.symptoms.length === 0) {
                    document.querySelector('#symptoms .symptom-tag[data-symptom="none"]').classList.add('selected');
                    conditionData.symptoms = ['none'];
                }
            }
        });
    });
}

function loadSavedCondition() {
    if (!user) return;
    const saved = localStorage.getItem(`condition_${user.name}_${fmt(new Date())}`);
    if (saved) {
        const data = JSON.parse(saved);
        displayCareResult(data);
    }
}

function submitCondition() {
    conditionData.sleepHours = parseInt(document.getElementById('sleepHours').value) || 0;
    
    let score = 50;
    if (conditionData.sleepHours >= 7) score += 25;
    else if (conditionData.sleepHours >= 6) score += 20;
    else if (conditionData.sleepHours >= 5) score += 10;
    else score -= 5;
    
    score += (conditionData.condition - 5) * 4;
    score -= (conditionData.stress - 1) * 3;
    score -= conditionData.symptoms.filter(s => s !== 'none').length * 5;
    score += conditionData.breakfast * 2;
    score = Math.max(0, Math.min(100, Math.round(score)));
    
    const result = { date: fmt(new Date()), ...conditionData, score };
    localStorage.setItem(`condition_${user.name}_${fmt(new Date())}`, JSON.stringify(result));
    // API ì €ì¥
    api({ action: 'saveCondition', floor: user.floor, name: user.name, ...result });
    displayCareResult(result);
    toast('ì»¨ë””ì…˜ ì²´í¬ ì™„ë£Œ!', 'success');
}

function displayCareResult(data) {
    let status, message, tips = [];
    
    if (data.score >= 80) {
        status = ''; message = 'ì»¨ë””ì…˜ ìµœê³ ! ğŸ’ª';
        tips = ['ğŸ”¥ ì–´ë ¤ìš´ ê³¼ëª©ì— ë„ì „í•˜ì„¸ìš”!', 'â° 90ë¶„ ì§‘ì¤‘ + 10ë¶„ íœ´ì‹ ì¶”ì²œ'];
    } else if (data.score >= 60) {
        status = ''; message = 'ì»¨ë””ì…˜ ì–‘í˜¸! ğŸ˜Š';
        tips = ['ğŸ“š ê³„íšëŒ€ë¡œ ì§„í–‰í•˜ì„¸ìš”', 'â° 50ë¶„ ì§‘ì¤‘ + 10ë¶„ íœ´ì‹ ì¶”ì²œ'];
    } else if (data.score >= 40) {
        status = 'warning'; message = 'ì¡°ê¸ˆ í”¼ê³¤í•´ìš” ğŸ˜';
        tips = ['â˜• ë”°ëœ»í•œ ì°¨ í•œ ì” ì–´ë•Œìš”?', 'ğŸ§˜ ìŠ¤íŠ¸ë ˆì¹­ì„ í•´ë³´ì„¸ìš”'];
    } else {
        status = 'danger'; message = 'ì˜¤ëŠ˜ì€ ë¬´ë¦¬í•˜ì§€ ë§ˆì„¸ìš” ğŸ˜¢';
        tips = ['ğŸ’¤ ì¶©ë¶„í•œ íœ´ì‹ì´ í•„ìš”í•´ìš”', 'ğŸ“– ê°€ë²¼ìš´ ë³µìŠµë§Œ í•˜ì„¸ìš”'];
    }
    
    if (data.symptoms.includes('headache')) tips.push('ğŸ¤• ë‘í†µ: ëˆˆ ê°ê³  5ë¶„ íœ´ì‹');
    if (data.symptoms.includes('eyestrain')) tips.push('ğŸ‘€ ëˆˆí”¼ë¡œ: ë¨¼ ê³³ ë°”ë¼ë³´ê¸°');
    
    const card = document.getElementById('careResultCard');
    card.className = 'care-result-card ' + status;
    card.style.display = 'block';
    document.getElementById('careResultContent').innerHTML = `
        <div class="care-score">${data.score}ì </div>
        <div class="care-message">${message}</div>
        <div class="care-tips">${tips.map(t => `<div class="care-tip">${t}</div>`).join('')}</div>
    `;
}

// ========== ë”ë³´ê¸° ì„œë¸Œëª¨ë‹¬ ==========
function openSubModal(id) {
    document.getElementById(id).classList.add('show');
    if (id === 'mystatsModal') loadMyStats();
    if (id === 'liveModal') loadLiveStatus();
    if (id === 'achieveModal') loadAchievement();
    if (id === 'styleModal') loadSavedStyle();
    if (id === 'roadmapModal') loadSavedRoadmap();
}

function closeSubModal(id) {
    document.getElementById(id).classList.remove('show');
}

// ========== í•™ìŠµì„±í–¥ ì§„ë‹¨ ==========
let styleData = null;

function loadSavedStyle() {
    if (!user) return;
    const saved = localStorage.getItem(`style_${user.name}`);
    if (saved) {
        styleData = JSON.parse(saved);
        displayStyleResult();
    }
}
function displayStyleResult() {
    if (!styleData) return;
    document.getElementById('styleIntro').style.display = 'none';
    document.getElementById('styleResult').style.display = 'block';
    document.getElementById('styleResult').innerHTML = `
        <div class="style-result-card">
            <div class="style-code-badge">${styleData.code}</div>
            <div class="style-name">${styleData.name}</div>
            <div class="style-desc">ë‹¹ì‹ ë§Œì˜ í•™ìŠµ ìŠ¤íƒ€ì¼ì…ë‹ˆë‹¤!</div>
            <button onclick="resetStyleTest()" style="margin-top:15px;padding:10px 20px;background:#f0f0f0;border:none;border-radius:8px;cursor:pointer;">ğŸ”„ ë‹¤ì‹œ ì§„ë‹¨í•˜ê¸°</button>
        </div>
        <div class="my-stats-card">
            <div class="my-stats-title"><i class="fas fa-lightbulb" style="color:#f59e0b;"></i> ë§ì¶¤ í•™ìŠµ íŒ</div>
            ${styleData.tips.map(t => `<div class="care-tip">${t}</div>`).join('')}
        </div>
    `;
}

// ========== í•™ìŠµ ë¡œë“œë§µ ==========
let roadmapData = null;

function loadSavedRoadmap() {
    if (!user) return;
    const saved = localStorage.getItem(`roadmap_${user.name}`);
    if (saved) {
        roadmapData = JSON.parse(saved);
        displayRoadmapResult();
    }
}

function showRoadmapSetup() {
    document.getElementById('roadmapIntro').style.display = 'none';
    document.getElementById('roadmapSetup').style.display = 'block';
}

function createRoadmap() {
    const goal = document.getElementById('rmGoal').value;
    const period = document.getElementById('rmPeriod').value;
    const hours = document.getElementById('rmHours').value;
    
    if (!goal || !period || !hours) { toast('ëª¨ë“  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”', 'warning'); return; }
    
    const goalNames = { 'top10': 'ìƒìœ„ê¶Œ ëŒ€í•™', 'mid': 'ì¤‘ìƒìœ„ê¶Œ ëŒ€í•™', 'improve': 'ì„±ì  í–¥ìƒ', 'weak': 'ì·¨ì•½ ê³¼ëª© ê·¹ë³µ' };
    roadmapData = { goal: goalNames[goal], period: parseInt(period), dailyHours: parseInt(hours), startDate: fmt(new Date()) };
    localStorage.setItem(`roadmap_${user.name}`, JSON.stringify(roadmapData));
    displayRoadmapResult();
    toast('ë¡œë“œë§µ ìƒì„± ì™„ë£Œ!', 'success');
}

function displayRoadmapResult() {
    if (!roadmapData) return;
    document.getElementById('roadmapIntro').style.display = 'none';
    document.getElementById('roadmapSetup').style.display = 'none';
    document.getElementById('roadmapResult').style.display = 'block';
    
    const startDate = new Date(roadmapData.startDate);
    const endDate = new Date(startDate);
    endDate.setMonth(endDate.getMonth() + roadmapData.period);
    const daysLeft = Math.max(0, Math.ceil((endDate - new Date()) / (1000 * 60 * 60 * 24)));
    const progress = Math.round(((roadmapData.period * 30 - daysLeft) / (roadmapData.period * 30)) * 100);
    
    document.getElementById('roadmapResult').innerHTML = `
        <div class="my-stats-card">
            <div style="text-align:center;padding-bottom:15px;border-bottom:1px solid #f0f0f0;">
                <div style="font-size:1.3rem;font-weight:700;color:var(--primary);">${roadmapData.goal}</div>
                <div style="font-size:0.9rem;color:#888;">${roadmapData.period}ê°œì›” ë¡œë“œë§µ</div>
            </div>
            <div class="stats-summary-row" style="margin-top:15px;">
                <div class="summary-box"><div class="value">${roadmapData.dailyHours}h</div><div class="label">ì¼ì¼ ëª©í‘œ</div></div>
                <div class="summary-box"><div class="value" style="color:#10b981;">${progress}%</div><div class="label">ì§„í–‰ë¥ </div></div>
                <div class="summary-box"><div class="value">${daysLeft}</div><div class="label">ë‚¨ì€ ì¼</div></div>
            </div>
        </div>
    `;
}

// ========== í•™ìŠµ ì„±ì·¨ë„ ==========
function loadAchievement() {
    const weekDates = getWeekDates();
    const weekStart = fmt(weekDates[0]);
    const weekEnd = fmt(weekDates[6]);
    
    const weekPlans = plans.filter(p => p.date >= weekStart && p.date <= weekEnd);
    const completed = weekPlans.filter(p => ['approved', 'O'].includes(p.status));
    const rate = weekPlans.length > 0 ? Math.round((completed.length / weekPlans.length) * 100) : 0;
    
    let grade, title, message;
    if (rate >= 90) { grade = 'S'; title = 'ìµœìš°ìˆ˜!'; message = 'ì •ë§ í›Œë¥­í•´ìš”! ğŸ”¥'; }
    else if (rate >= 80) { grade = 'A'; title = 'ìš°ìˆ˜!'; message = 'ì˜í•˜ê³  ìˆì–´ìš”! ğŸ‘'; }
    else if (rate >= 70) { grade = 'B'; title = 'ì–‘í˜¸'; message = 'ì¢‹ì€ ë°©í–¥ì´ì—ìš”! ğŸ’ª'; }
    else if (rate >= 60) { grade = 'C'; title = 'ë³´í†µ'; message = 'ì¡°ê¸ˆ ë” ë…¸ë ¥í•´ë´ìš”!'; }
    else { grade = 'D'; title = 'ë¶„ë°œ í•„ìš”'; message = 'í•¨ê»˜ ë°©ë²•ì„ ì°¾ì•„ë´ìš”! ğŸ“š'; }
    
    const totalTime = completed.reduce((sum, p) => sum + (p.actualTime || 0), 0);
    
    document.getElementById('achieveContent').innerHTML = `
        <div class="my-stats-card" style="text-align:center;">
            <div class="achieve-grade-badge ${grade}">
                <div class="achieve-grade-letter">${grade}</div>
                <div class="achieve-grade-score">${rate}ì </div>
            </div>
            <div style="font-size:1.2rem;font-weight:700;color:var(--primary);">${title}</div>
            <div style="color:#666;margin-top:5px;">${message}</div>
            <div class="stats-summary-row" style="margin-top:20px;">
                <div class="summary-box"><div class="value">${completed.length}</div><div class="label">ì™„ë£Œ</div></div>
                <div class="summary-box"><div class="value">${weekPlans.length}</div><div class="label">ê³„íš</div></div>
                <div class="summary-box"><div class="value">${(totalTime/60).toFixed(1)}h</div><div class="label">í•™ìŠµì‹œê°„</div></div>
            </div>
        </div>
    `;
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì»¨ë””ì…˜ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(setupCareListeners, 500);
});
       // í•™ìŠµì„±í–¥ ë‹¤ì‹œ ì§„ë‹¨
function resetStyleTest() {
    localStorage.removeItem(`style_${user.name}`);
    styleData = null;
    document.getElementById('styleIntro').style.display = 'block';
    document.getElementById('styleResult').style.display = 'none';
}

// ë¡œë“œë§µ ë‹¤ì‹œ ì„¤ì •
function resetRoadmap() {
    localStorage.removeItem(`roadmap_${user.name}`);
    roadmapData = null;
    document.getElementById('roadmapIntro').style.display = 'block';
    document.getElementById('roadmapSetup').style.display = 'none';
    document.getElementById('roadmapResult').style.display = 'none';
} 
    </script>
</body>
</html>
