<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÍπÄÏóÑÎßàÎèÖÏÑúÏã§ | ÏùºÏùºÌîåÎûòÎÑà</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { 
            height: 100%; 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f0f0f0;
            overflow: hidden;
        }

        /* Î°úÍ∑∏Ïù∏ */
        .login-screen {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #1e3a5f, #0f1f33);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .login-screen.hidden { display: none; }
        .login-box {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            width: 90%;
            max-width: 340px;
            text-align: center;
        }
        .login-box h1 { color: #1e3a5f; margin-bottom: 1.5rem; }
        .login-box select {
            width: 100%;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 2px solid #ddd;
            border-radius: 12px;
            font-size: 1rem;
        }
        .login-box button {
            width: 100%;
            padding: 1rem;
            background: #1e3a5f;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
        }

        /* Î©îÏù∏ */
        .container {
            display: none;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
        }
        .container.active { display: flex; }

        /* Ìó§Îçî */
        .header {
            background: #1e3a5f;
            color: white;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .mood { font-size: 1.5rem; }
        .name { font-weight: 600; }
        .header-btn {
            width: 36px; height: 36px;
            background: rgba(255,255,255,0.15);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
        }

        /* Ï£ºÏ∞® Î∞î */
        .week-bar {
            background: white;
            padding: 8px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e0e0e0;
        }
        .week-nav {
            width: 30px; height: 30px;
            background: #f0f0f0;
            border: none;
            border-radius: 50%;
        }
        .week-info { text-align: center; }
        .week-title { font-weight: 700; color: #1e3a5f; }
        .week-range { font-size: 0.7rem; color: #999; }

        /* ÌÖåÏù¥Î∏î ÏòÅÏó≠ */
        .table-wrapper {
            flex: 1;
            overflow: auto;
            padding: 8px;
        }
        .plan-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            min-width: 750px;
        }
        .plan-table th {
            background: #1e3a5f;
            color: white;
            padding: 10px 6px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .plan-table th.subject-col { width: 50px; }
        .plan-table th.add-col { width: 40px; }
        .plan-table th.book-col { width: 80px; }
        .plan-table td {
            border: 1px solid #e5e5e5;
            padding: 4px;
            vertical-align: top;
            height: 65px;
        }
        .subject-cell {
            background: #f5f5f5;
            text-align: center;
            font-weight: 700;
            font-size: 0.9rem;
            color: #1e3a5f;
            vertical-align: middle !important;
        }
        .add-cell {
            background: #f5f5f5;
            text-align: center;
            vertical-align: middle !important;
        }
        .book-cell {
            background: #fefce8;
            font-size: 0.7rem;
            vertical-align: middle !important;
            text-align: center;
            font-weight: 600;
            color: #666;
        }
        .add-btn {
            width: 30px; height: 30px;
            background: #e0f2fe;
            border: 2px dashed #3b82f6;
            border-radius: 6px;
            color: #3b82f6;
            font-size: 1rem;
            cursor: pointer;
        }

        /* ÏöîÏùº Ìó§Îçî */
        .day-header { text-align: center; }
        .day-name { font-size: 0.7rem; opacity: 0.8; }
        .day-num { font-size: 1rem; }
        .today { background: #f59e0b !important; }
        .sat .day-num { color: #93c5fd; }
        .sun .day-num { color: #fca5a5; }

        /* Îç∞Ïù¥ ÏÖÄ */
        .day-cell {
            position: relative;
            padding: 3px !important;
        }

        /* + Î≤ÑÌäº */
        .cell-add {
            width: 100%;
            height: 100%;
            min-height: 55px;
            background: transparent;
            border: 2px dashed #d0d0d0;
            border-radius: 6px;
            color: #bbb;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .cell-add:hover {
            border-color: #3b82f6;
            color: #3b82f6;
            background: #eff6ff;
        }

        /* Í≥ÑÌöç Ïπ¥Îìú (2Îã® Íµ¨Ï°∞) */
        .plan-card {
            background: white;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid #e0e0e0;
            margin-bottom: 3px;
        }
        .plan-card.completed { border-color: #86efac; background: #f0fdf4; }
        .plan-card.pending { border-color: #fcd34d; background: #fef9c3; }
        .plan-card.failed { border-color: #fca5a5; background: #fef2f2; }

        /* ÏÉÅÎã® - ÌîåÎ†àÏù¥Î≤ÑÌäº + ÌÉÄÏù¥Î®∏ */
        .card-top {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 5px 6px;
            background: rgba(0,0,0,0.03);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .play-btn {
            width: 28px; height: 28px;
            background: #3b82f6;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 0.65rem;
            cursor: pointer;
            flex-shrink: 0;
        }
        .play-btn.recording {
            background: #ef4444;
            animation: pulse 1.5s infinite;
        }
        .play-btn.done {
            background: #10b981;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .card-timer {
            font-size: 0.8rem;
            font-weight: 700;
            color: #1e3a5f;
            font-family: monospace;
        }
        .card-status {
            margin-left: auto;
            font-size: 0.9rem;
        }

        /* ÌïòÎã® - ÏûÖÎ†• ÏòÅÏó≠ */
        .card-bottom {
            padding: 5px 6px;
        }
        .card-input {
            width: 100%;
            border: none;
            background: rgba(255,255,255,0.8);
            padding: 4px 6px;
            font-size: 0.75rem;
            border-radius: 4px;
            margin-bottom: 3px;
            font-family: inherit;
        }
        .card-input:focus {
            outline: 2px solid #3b82f6;
            background: white;
        }
        .card-pages {
            display: flex;
            gap: 3px;
            align-items: center;
        }
        .card-pages input {
            width: 45px;
            text-align: center;
        }
        .card-pages span {
            font-size: 0.7rem;
            color: #999;
        }

        /* ÌïòÎã® Î∞î */
        .bottom-bar {
            background: white;
            padding: 8px 15px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        .bottom-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 15px;
            background: #f5f5f5;
            border: none;
            border-radius: 10px;
            font-size: 0.7rem;
            color: #666;
        }
        .bottom-btn i {
            font-size: 1.2rem;
            color: #3b82f6;
            margin-bottom: 3px;
        }

        /* ÌÜµÍ≥Ñ Ìå®ÎÑê */
        .stats-panel {
            display: none;
            position: fixed;
            bottom: 60px; left: 10px; right: 10px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
            padding: 15px;
            z-index: 100;
        }
        .stats-panel.active { display: block; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }
        .stat-item {
            text-align: center;
            padding: 10px;
            background: #f8f8f8;
            border-radius: 8px;
        }
        .stat-value { font-size: 1.4rem; font-weight: 700; color: #1e3a5f; }
        .stat-label { font-size: 0.65rem; color: #999; }
        .close-stats {
            position: absolute; top: 10px; right: 10px;
            background: none; border: none; font-size: 1.2rem; color: #999;
        }

        /* ÍµêÏû¨ Ï∂îÍ∞Ä Î™®Îã¨ */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 500;
            align-items: center;
            justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-box {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            width: 90%;
            max-width: 320px;
        }
        .modal-box h3 { margin-bottom: 1rem; color: #1e3a5f; }
        .modal-box select, .modal-box input {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
        }
        .modal-btns {
            display: flex;
            gap: 10px;
        }
        .modal-btns button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
        }
        .modal-btns .cancel { background: #eee; color: #666; }
        .modal-btns .confirm { background: #3b82f6; color: white; }

        /* ÌÜ†Ïä§Ìä∏ */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            opacity: 0;
            transition: all 0.3s;
            z-index: 600;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .toast.success { background: #10b981; }

        /* Ï∫°Ï≤òÏö© Ìó§Îçî */
        .capture-header {
            display: none;
            background: linear-gradient(135deg, #1e3a5f, #2d5a8b);
            color: white;
            padding: 15px 20px;
            text-align: center;
            border-radius: 10px 10px 0 0;
        }
        .capture-header.visible { display: block; }
        .capture-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 4px;
        }
        .capture-info {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        .capture-mode .plan-table {
            border-radius: 0 0 10px 10px;
        }
    </style>
</head>
<body>
    <!-- Î°úÍ∑∏Ïù∏ -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <h1>üìö ÍπÄÏóÑÎßàÎèÖÏÑúÏã§</h1>
            <select id="loginFloor" onchange="loadStudents()">
                <option value="">Ï∏µ ÏÑ†ÌÉù</option>
                <option value="7Ï∏µ">7Ï∏µ</option>
                <option value="8Ï∏µ">8Ï∏µ</option>
            </select>
            <select id="loginName">
                <option value="">Ïù¥Î¶Ñ ÏÑ†ÌÉù</option>
            </select>
            <button onclick="login()">ÏãúÏûëÌïòÍ∏∞</button>
        </div>
    </div>

    <!-- Î©îÏù∏ -->
    <div class="container" id="container">
        <div class="header">
            <div class="header-left">
                <span class="mood" id="mood">üòä</span>
                <span class="name" id="userName">ÌïôÏÉù</span>
            </div>
            <div class="header-right">
                <button class="header-btn" onclick="captureShare()"><i class="fas fa-camera"></i></button>
                <button class="header-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>

        <div class="week-bar">
            <button class="week-nav" onclick="changeWeek(-1)"><i class="fas fa-chevron-left"></i></button>
            <div class="week-info">
                <div class="week-title" id="weekTitle">2Ïõî 1Ï£ºÏ∞®</div>
                <div class="week-range" id="weekRange">2/3(Ïõî)~2/9(Ïùº)</div>
            </div>
            <button class="week-nav" onclick="changeWeek(1)"><i class="fas fa-chevron-right"></i></button>
        </div>

        <div class="table-wrapper">
            <div id="captureArea">
                <!-- Ï∫°Ï≤òÏö© Ìó§Îçî (ÌèâÏÜå Ïà®ÍπÄ) -->
                <div class="capture-header" id="captureHeader">
                    <div class="capture-title">üìö ÍπÄÏóÑÎßàÎèÖÏÑúÏã§ Ï£ºÍ∞ÑÍ≥ÑÌöçÌëú</div>
                    <div class="capture-info" id="captureInfo">ÌïôÏÉù ¬∑ Ï∏µ ¬∑ Ï£ºÏ∞®</div>
                </div>
                <table class="plan-table">
                <thead id="tableHead"></thead>
                <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>

        <div class="bottom-bar">
            <button class="bottom-btn" onclick="toggleStats()">
                <i class="fas fa-chart-bar"></i>
                <span>ÌÜµÍ≥Ñ</span>
            </button>
            <button class="bottom-btn" onclick="captureShare()">
                <i class="fas fa-share-alt"></i>
                <span>Í≥µÏú†</span>
            </button>
        </div>

        <div class="stats-panel" id="statsPanel">
            <button class="close-stats" onclick="toggleStats()"><i class="fas fa-times"></i></button>
            <div class="stats-grid">
                <div class="stat-item"><div class="stat-value" id="statTotal">0</div><div class="stat-label">Ï¥ù Í≥ÑÌöç</div></div>
                <div class="stat-item"><div class="stat-value" id="statDone" style="color:#10b981">0</div><div class="stat-label">ÏôÑÎ£å</div></div>
                <div class="stat-item"><div class="stat-value" id="statTime" style="color:#3b82f6">0h</div><div class="stat-label">Í≥µÎ∂ÄÏãúÍ∞Ñ</div></div>
                <div class="stat-item"><div class="stat-value" id="statRate" style="color:#f59e0b">0%</div><div class="stat-label">Ïã§Ï≤úÏú®</div></div>
            </div>
        </div>
    </div>

    <!-- ÍµêÏû¨ Ï∂îÍ∞Ä Î™®Îã¨ -->
    <div class="modal" id="bookModal">
        <div class="modal-box">
            <h3>üìö ÍµêÏû¨ Ï∂îÍ∞Ä</h3>
            <select id="bookSubject">
                <option value="">Í≥ºÎ™© ÏÑ†ÌÉù</option>
                <option value="Íµ≠Ïñ¥">Íµ≠Ïñ¥</option>
                <option value="ÏàòÌïô">ÏàòÌïô</option>
                <option value="ÏòÅÏñ¥">ÏòÅÏñ¥</option>
                <option value="ÌÉêÍµ¨">ÌÉêÍµ¨</option>
            </select>
            <input type="text" id="bookName" placeholder="ÍµêÏû¨Î™Ö">
            <div class="modal-btns">
                <button class="cancel" onclick="closeBookModal()">Ï∑®ÏÜå</button>
                <button class="confirm" onclick="addBook()">Ï∂îÍ∞Ä</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        const API = 'https://script.google.com/macros/s/AKfycbwGFbsj8FgFIuF-iFkJ4ekyS76MWQf9UrUysJ-Fs12vuVByJwenoYRgOJeOZiPOa6gzkg/exec';
        
        let user = null;
        let books = [];
        let plans = [];
        let weekStart = getMonday(new Date());
        let timers = {}; // { "subject-book-date": { interval, start, elapsed } }

        const SUBJECTS = ['Íµ≠Ïñ¥', 'ÏàòÌïô', 'ÏòÅÏñ¥', 'ÌÉêÍµ¨'];

        function getMonday(d) {
            const date = new Date(d);
            const day = date.getDay();
            return new Date(date.setDate(date.getDate() - day + (day === 0 ? -6 : 1)));
        }
        function fmt(d) { return d.toISOString().split('T')[0]; }
        function fmtKR(d) { return `${d.getMonth()+1}/${d.getDate()}`; }
        function dayName(i) { return ['Ïõî','Ìôî','Ïàò','Î™©','Í∏à','ÌÜ†','Ïùº'][i]; }
        function getWeekDates() {
            const arr = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(weekStart);
                d.setDate(weekStart.getDate() + i);
                arr.push(d);
            }
            return arr;
        }

        async function api(data) {
            try {
                const res = await fetch(API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(data)
                });
                return await res.json();
            } catch { return { success: false }; }
        }

        async function loadStudents() {
            const floor = document.getElementById('loginFloor').value;
            const sel = document.getElementById('loginName');
            if (!floor) return;
            sel.innerHTML = '<option>Î°úÎî©Ï§ë...</option>';
            const res = await api({ action: 'getStudents', floor });
            if (res.success) {
                sel.innerHTML = '<option value="">Ïù¥Î¶Ñ ÏÑ†ÌÉù</option>' +
                    res.students.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
            }
        }

        async function login() {
            const floor = document.getElementById('loginFloor').value;
            const name = document.getElementById('loginName').value;
            if (!floor || !name) return toast('Ï∏µÍ≥º Ïù¥Î¶ÑÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî');
            
            user = { floor, name };
            document.getElementById('userName').textContent = name;
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('container').classList.add('active');
            await loadData();
        }

        function logout() {
            user = null;
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('container').classList.remove('active');
        }

        async function loadData() {
            const bRes = await api({ action: 'getBooks', floor: user.floor, name: user.name });
            if (bRes.success) books = bRes.books || [];
            await loadPlans();
            renderWeek();
            renderTable();
            updateMood();
        }

        async function loadPlans() {
            const dates = getWeekDates();
            const res = await api({
                action: 'getWeekPlans',
                floor: user.floor,
                name: user.name,
                startDate: fmt(dates[0]),
                endDate: fmt(dates[6])
            });
            if (res.success) plans = res.plans || [];
        }

        function changeWeek(delta) {
            weekStart.setDate(weekStart.getDate() + delta * 7);
            loadPlans().then(() => { renderWeek(); renderTable(); });
        }

        function renderWeek() {
            const dates = getWeekDates();
            const m = dates[0].getMonth() + 1;
            const w = Math.ceil(dates[0].getDate() / 7);
            document.getElementById('weekTitle').textContent = `${m}Ïõî ${w}Ï£ºÏ∞®`;
            document.getElementById('weekRange').textContent = `${fmtKR(dates[0])}(Ïõî)~${fmtKR(dates[6])}(Ïùº)`;
        }

        function renderTable() {
            const dates = getWeekDates();
            const today = fmt(new Date());

            // Ìó§Îçî
            let hHtml = '<tr><th class="subject-col">Í≥ºÎ™©</th><th class="add-col">+</th><th class="book-col">ÍµêÏû¨</th>';
            for (let i = 0; i < 7; i++) {
                const d = dates[i];
                const isToday = fmt(d) === today;
                const cls = isToday ? 'today' : (i === 5 ? 'sat' : (i === 6 ? 'sun' : ''));
                hHtml += `<th class="${cls}"><div class="day-header ${cls}">
                    <div class="day-name">${dayName(i)}</div>
                    <div class="day-num">${d.getDate()}</div>
                </div></th>`;
            }
            hHtml += '</tr>';
            document.getElementById('tableHead').innerHTML = hHtml;

            // Î∞îÎîî
            let bHtml = '';
            SUBJECTS.forEach(subject => {
                const sBooks = books.filter(b => b.subject === subject);
                
                if (sBooks.length === 0) {
                    bHtml += `<tr>
                        <td class="subject-cell">${subject}</td>
                        <td class="add-cell"><button class="add-btn" onclick="openBookModal('${subject}')">+</button></td>
                        <td class="book-cell">-</td>`;
                    for (let i = 0; i < 7; i++) {
                        bHtml += `<td class="day-cell"><button class="cell-add" onclick="quickAdd('${subject}','${subject}','${fmt(dates[i])}')">+</button></td>`;
                    }
                    bHtml += '</tr>';
                } else {
                    sBooks.forEach((book, idx) => {
                        bHtml += '<tr>';
                        if (idx === 0) {
                            bHtml += `<td class="subject-cell" rowspan="${sBooks.length}">${subject}</td>`;
                            bHtml += `<td class="add-cell" rowspan="${sBooks.length}"><button class="add-btn" onclick="openBookModal('${subject}')">+</button></td>`;
                        }
                        bHtml += `<td class="book-cell">${book.name}</td>`;
                        
                        for (let i = 0; i < 7; i++) {
                            const dateStr = fmt(dates[i]);
                            const dayPlans = plans.filter(p => p.date === dateStr && p.subject === subject && p.book === book.name);
                            
                            bHtml += `<td class="day-cell">`;
                            if (dayPlans.length > 0) {
                                dayPlans.forEach(plan => {
                                    const key = `${subject}-${book.name}-${dateStr}`;
                                    const timer = timers[key];
                                    const isRecording = timer && timer.interval;
                                    
                                    let cardCls = '';
                                    let statusIcon = '';
                                    let btnCls = '';
                                    let btnIcon = 'fa-play';
                                    
                                    if (plan.status === 'approved' || plan.status === 'O') {
                                        cardCls = 'completed';
                                        statusIcon = '‚úÖ';
                                        btnCls = 'done';
                                        btnIcon = 'fa-check';
                                    } else if (plan.status === 'failed' || plan.status === 'X') {
                                        cardCls = 'failed';
                                        statusIcon = '‚ùå';
                                    } else if (plan.status === 'requested') {
                                        cardCls = 'pending';
                                        statusIcon = '‚è≥';
                                    }
                                    
                                    if (isRecording) {
                                        btnCls = 'recording';
                                        btnIcon = 'fa-stop';
                                    }
                                    
                                    const timerDisplay = timer ? formatTime(timer.elapsed || 0) : '00:00';
                                    
                                    bHtml += `<div class="plan-card ${cardCls}">
                                        <div class="card-top">
                                            <button class="play-btn ${btnCls}" onclick="toggleTimer('${subject}','${book.name}','${dateStr}')" ${cardCls === 'completed' ? 'disabled' : ''}>
                                                <i class="fas ${btnIcon}"></i>
                                            </button>
                                            <span class="card-timer" id="timer-${key}">${timerDisplay}</span>
                                            <span class="card-status">${statusIcon}</span>
                                        </div>
                                        <div class="card-bottom">
                                            <div class="card-pages">
                                                <input class="card-input" placeholder="p." value="${plan.startPage || ''}" 
                                                    onchange="updatePage('${dateStr}','${subject}','${book.name}','start',this.value)">
                                                <span>~</span>
                                                <input class="card-input" placeholder="p." value="${plan.endPage || ''}"
                                                    onchange="updatePage('${dateStr}','${subject}','${book.name}','end',this.value)">
                                            </div>
                                        </div>
                                    </div>`;
                                });
                            } else {
                                bHtml += `<button class="cell-add" onclick="quickAdd('${subject}','${book.name}','${dateStr}')">+</button>`;
                            }
                            bHtml += '</td>';
                        }
                        bHtml += '</tr>';
                    });
                }
            });
            
            document.getElementById('tableBody').innerHTML = bHtml;
        }

        function formatTime(seconds) {
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        }

        // ÌÉÄÏù¥Î®∏
        function toggleTimer(subject, book, dateStr) {
            const key = `${subject}-${book}-${dateStr}`;
            
            if (timers[key] && timers[key].interval) {
                // Î©àÏ∂îÍ∏∞
                clearInterval(timers[key].interval);
                timers[key].interval = null;
                savePlanTime(subject, book, dateStr, timers[key].elapsed);
            } else {
                // ÏãúÏûë
                if (!timers[key]) {
                    timers[key] = { interval: null, start: null, elapsed: 0 };
                }
                timers[key].start = Date.now() - timers[key].elapsed * 1000;
                timers[key].interval = setInterval(() => {
                    timers[key].elapsed = Math.floor((Date.now() - timers[key].start) / 1000);
                    const el = document.getElementById(`timer-${key}`);
                    if (el) el.textContent = formatTime(timers[key].elapsed);
                }, 1000);
            }
            renderTable();
        }

        async function savePlanTime(subject, book, dateStr, seconds) {
            const minutes = Math.ceil(seconds / 60);
            if (minutes === 0) return;
            
            const res = await api({
                action: 'requestCheck',
                floor: user.floor,
                name: user.name,
                date: dateStr,
                subject: subject,
                bookName: book,
                actualTime: minutes
            });
            
            if (res.success) {
                await loadPlans();
                renderTable();
                updateMood();
                toast(`‚úÖ ${minutes}Î∂Ñ Í∏∞Î°ùÎê®!`, true);
            }
        }

        // Îπ†Î•∏ Ï∂îÍ∞Ä
        async function quickAdd(subject, book, dateStr) {
            const res = await api({
                action: 'addPlan',
                floor: user.floor,
                name: user.name,
                date: dateStr,
                subject: subject,
                bookName: book,
                time: 60
            });
            
            if (res.success) {
                plans.push({ date: dateStr, subject, book, status: 'pending' });
                renderTable();
                toast('‚úÖ Ï∂îÍ∞ÄÎê®');
            }
        }

        // ÌéòÏù¥ÏßÄ ÏóÖÎç∞Ïù¥Ìä∏
        async function updatePage(dateStr, subject, book, type, value) {
            const plan = plans.find(p => p.date === dateStr && p.subject === subject && p.book === book);
            if (plan) {
                if (type === 'start') plan.startPage = value;
                else plan.endPage = value;
                
                await api({
                    action: 'updatePlanPage',
                    floor: user.floor,
                    name: user.name,
                    date: dateStr,
                    subject,
                    bookName: book,
                    startPage: plan.startPage,
                    endPage: plan.endPage
                });
            }
        }

        // ÍµêÏû¨ Ï∂îÍ∞Ä
        function openBookModal(subject) {
            document.getElementById('bookSubject').value = subject || '';
            document.getElementById('bookName').value = '';
            document.getElementById('bookModal').classList.add('active');
        }

        function closeBookModal() {
            document.getElementById('bookModal').classList.remove('active');
        }

        async function addBook() {
            const subject = document.getElementById('bookSubject').value;
            const name = document.getElementById('bookName').value.trim();
            if (!subject || !name) return toast('Í≥ºÎ™©Í≥º ÍµêÏû¨Î™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî');
            
            const res = await api({
                action: 'addBook',
                floor: user.floor,
                name: user.name,
                subject,
                bookName: name
            });
            
            if (res.success) {
                books.push({ subject, name });
                closeBookModal();
                renderTable();
                toast('üìö Ï∂îÍ∞ÄÎê®', true);
            }
        }

        // ÌëúÏ†ï
        async function updateMood() {
            const res = await api({
                action: 'getRecords',
                floor: user.floor,
                name: user.name,
                date: fmt(new Date())
            });
            
            if (res.success) {
                const records = res.records || [];
                const totalTime = records
                    .filter(r => r.status === 'approved' || r.status === 'O' || r.status === 'requested')
                    .reduce((sum, r) => sum + (r.actualTime || 0), 0);
                
                let emoji = 'üò¥';
                if (totalTime >= 480) emoji = 'üòä';
                else if (totalTime >= 240) emoji = 'üôÇ';
                else if (totalTime > 0) emoji = 'üò¢';
                
                document.getElementById('mood').textContent = emoji;
            }
        }

        // ÌÜµÍ≥Ñ
        function toggleStats() {
            const panel = document.getElementById('statsPanel');
            panel.classList.toggle('active');
            if (panel.classList.contains('active')) loadStats();
        }

        async function loadStats() {
            const res = await api({
                action: 'getStats',
                floor: user.floor,
                name: user.name
            });
            
            if (res.success) {
                const s = res.stats;
                document.getElementById('statTotal').textContent = s.totalPlans || 0;
                document.getElementById('statDone').textContent = s.completed || 0;
                document.getElementById('statTime').textContent = (s.totalTimeHours || 0) + 'h';
                document.getElementById('statRate').textContent = (s.rate || 0) + '%';
            }
        }

        // Í≥µÏú† - Ï†ÑÏ≤¥ Í≥ºÎ™© Ï∫°Ï≤ò
        async function captureShare() {
            try {
                toast('üì∏ Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Ï§ë...');
                
                const captureArea = document.getElementById('captureArea');
                const captureHeader = document.getElementById('captureHeader');
                const wrapper = document.querySelector('.table-wrapper');
                
                // Ï∫°Ï≤ò Ìó§ÎçîÏóê Ï†ïÎ≥¥ ÏÑ§Ï†ï
                const dates = getWeekDates();
                const m = dates[0].getMonth() + 1;
                const w = Math.ceil(dates[0].getDate() / 7);
                document.getElementById('captureInfo').textContent = 
                    `${user.name} ¬∑ ${user.floor} ¬∑ ${m}Ïõî ${w}Ï£ºÏ∞® (${fmtKR(dates[0])}~${fmtKR(dates[6])})`;
                
                // Ï∫°Ï≤ò Î™®Îìú ÌôúÏÑ±Ìôî
                captureHeader.classList.add('visible');
                captureArea.classList.add('capture-mode');
                
                // Ï∫°Ï≤òÎ•º ÏúÑÌï¥ Ïä§ÌÅ¨Î°§ ÏòÅÏó≠ ÏûÑÏãúÎ°ú ÌôïÏû•
                const originalOverflow = wrapper.style.overflow;
                const originalHeight = wrapper.style.height;
                
                wrapper.style.overflow = 'visible';
                wrapper.style.height = 'auto';
                
                // ÏïΩÍ∞Ñ ÎåÄÍ∏∞ ÌõÑ Ï∫°Ï≤ò
                await new Promise(r => setTimeout(r, 150));
                
                const canvas = await html2canvas(captureArea, {
                    backgroundColor: '#ffffff',
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    scrollX: 0,
                    scrollY: 0,
                    windowWidth: captureArea.scrollWidth + 50,
                    windowHeight: captureArea.scrollHeight + 50
                });
                
                // ÏõêÎûò Ïä§ÌÉÄÏùºÎ°ú Î≥µÍµ¨
                captureHeader.classList.remove('visible');
                captureArea.classList.remove('capture-mode');
                wrapper.style.overflow = originalOverflow;
                wrapper.style.height = originalHeight;
                
                canvas.toBlob(async (blob) => {
                    try {
                        await navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]);
                        toast('üìã Ï†ÑÏ≤¥ Í≥ÑÌöçÌëú Î≥µÏÇ¨Îê®! Ïπ¥ÌÜ°Ïóê Î∂ôÏó¨ÎÑ£Í∏∞', true);
                    } catch {
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `${user.name}_Í≥ÑÌöçÌëú.png`;
                        a.click();
                        toast('üì• Ï†ÄÏû•Îê®', true);
                    }
                }, 'image/png');
            } catch (e) {
                console.error(e);
                toast('Ï∫°Ï≤ò Ïã§Ìå®');
            }
        }

        function toast(msg, success = false) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = 'toast' + (success ? ' success' : '');
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        }
    </script>
</body>
</html>
